<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Thread handling stuff</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Thread handling stuff</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>src/thread.c &#45; Thread handling stuff</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>Threads are created by creating new <code lang='und' xml:lang='und'>ParrotInterpreter</code> objects.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="static_void*_thread_func(void_*arg)"
><b><code lang='und' xml:lang='und'>static void *thread_func(void *arg)</b></code></a></dt><p class="pad"></p>

<dd>The actual thread function.</dd><p class="pad"></p>
</dl>

<h2><a name="Helper_functions_used_also_for_running_plain_interpreters"
>Helper functions used also for running plain interpreters <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_clone_code(Parrot_Interp_d,_Parrot_Interp_s)"
><b><code lang='und' xml:lang='und'>void pt_clone_code(Parrot_Interp d, Parrot_Interp s)</b></code></a></dt><p class="pad"></p>

<dd>Copy/clone the packfile/code from interpreter <code lang='und' xml:lang='und'>s</code> to <code lang='und' xml:lang='und'>d</code>.
All resources are created in <code lang='und' xml:lang='und'>d</code>.</dd><p class="pad"></p>

<dt><a name="void_pt_thread_prepare_for_run(Parrot_Interp_d,_Parrot_Interp_s)"
><b><code lang='und' xml:lang='und'>void pt_thread_prepare_for_run(Parrot_Interp d, Parrot_Interp s)</b></code></a></dt><p class="pad"></p>

<dd>Setup code,
and TODO ...</dd><p class="pad"></p>
</dl>

<h2><a name="ParrotThread_methods"
>ParrotThread methods <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="int_pt_thread_run(Parrot_Interp_interp,_PMC*_dest_interp,_PMC*_sub)"
><b><code lang='und' xml:lang='und'>int pt_thread_run(Parrot_Interp interp, PMC *dest_interp, PMC *sub)</b></code></a></dt><p class="pad"></p>

<dd>Run the <code lang='und' xml:lang='und'>*sub</code> PMC in a separate thread using interpreter in <code lang='und' xml:lang='und'>*dest_interp</code>.</dd><p class="pad"></p>

<dt><a name="int_pt_thread_run_1(Parrot_Interp_interp,_PMC*_dest_interp,_PMC*_sub)"
><b><code lang='und' xml:lang='und'>int pt_thread_run_1(Parrot_Interp interp, PMC *dest_interp, PMC *sub)</b></code></a></dt><p class="pad"></p>

<dd>Runs a type 1 thread.
Nothing is shared,
both interpreters are free running without any communication.</dd><p class="pad"></p>

<dt><a name="int_pt_thread_run_2(Parrot_Interp_interp,_PMC*_dest_interp,_PMC*_sub)"
><b><code lang='und' xml:lang='und'>int pt_thread_run_2(Parrot_Interp interp, PMC *dest_interp, PMC *sub)</b></code></a></dt><p class="pad"></p>

<dd>Runs a type 2 thread.
No shared variables,
threads are communicating by sending messages.</dd><p class="pad"></p>

<dt><a name="int_pt_thread_run_3(Parrot_Interp_interp,_PMC*_dest_interp,_PMC*_sub)"
><b><code lang='und' xml:lang='und'>int pt_thread_run_3(Parrot_Interp interp, PMC *dest_interp, PMC *sub)</b></code></a></dt><p class="pad"></p>

<dd>Run a type 3 thread.
Threads may have shared variables and are managed in a thread pool.</dd><p class="pad"></p>

<dt><a name="void_pt_thread_yield(void)"
><b><code lang='und' xml:lang='und'>void pt_thread_yield(void)</b></code></a></dt><p class="pad"></p>

<dd>Relinquishes hold on the processor.</dd><p class="pad"></p>

<dt><a name="static_Parrot_Interp_pt_check_tid(UINTVAL_tid,_const_char_*from)"
><b><code lang='und' xml:lang='und'>static Parrot_Interp pt_check_tid(UINTVAL tid, const char *from)</b></code></a></dt><p class="pad"></p>

<dd>Helper function.
Check if <code lang='und' xml:lang='und'>tid</code> is valid.
The caller holds the mutex.
Returns the interpreter for <code lang='und' xml:lang='und'>tid</code>.</dd><p class="pad"></p>

<dt><a name="static_void_mutex_unlock(void_*arg)"
><b><code lang='und' xml:lang='und'>static void mutex_unlock(void *arg)</b></code></a></dt><p class="pad"></p>

<dd>Unlocks the mutex <code lang='und' xml:lang='und'>*arg</code>.</dd><p class="pad"></p>

<dt><a name="void*_pt_thread_join(Parrot_Interp_parent,_UINTVAL_tid)"
><b><code lang='und' xml:lang='und'>void *pt_thread_join(Parrot_Interp parent, UINTVAL tid)</b></code></a></dt><p class="pad"></p>

<dd>Join (wait for) a joinable thread.</dd><p class="pad"></p>

<dt><a name="void_pt_join_threads(Parrot_Interp_interpreter)"
><b><code lang='und' xml:lang='und'>void pt_join_threads(Parrot_Interp interpreter)</b></code></a></dt><p class="pad"></p>

<dd>Possibly wait for other running threads.
This is called when destroying <code lang='und' xml:lang='und'>interpreter</code>.</dd><p class="pad"></p>

<dt><a name="static_Parrot_Interp_detach(UINTVAL_tid)"
><b><code lang='und' xml:lang='und'>static Parrot_Interp detach(UINTVAL tid)</b></code></a></dt><p class="pad"></p>

<dd>Helper for detach and kill.</dd><p class="pad"></p>

<dd>Returns the interpreter,
if it didn&#39;t finish yet.</dd><p class="pad"></p>

<dt><a name="void_pt_thread_detach(UINTVAL_tid)"
><b><code lang='und' xml:lang='und'>void pt_thread_detach(UINTVAL tid)</b></code></a></dt><p class="pad"></p>

<dd>Detaches (make non&#45;joinable) the thread.</dd><p class="pad"></p>

<dt><a name="void_pt_thread_kill(UINTVAL_tid)"
><b><code lang='und' xml:lang='und'>void pt_thread_kill(UINTVAL tid)</b></code></a></dt><p class="pad"></p>

<dd>Kills the thread.</dd><p class="pad"></p>
</dl>

<h2><a name="Threaded_interpreter_book&#45;keeping"
>Threaded interpreter book&#45;keeping <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_add_to_interpreters(Parrot_Interp_interpreter,_Parrot_Interp_new_interp)"
><b><code lang='und' xml:lang='und'>void pt_add_to_interpreters(Parrot_Interp interpreter, Parrot_Interp new_interp)</b></code></a></dt><p class="pad"></p>

<dd>All threaded interpreters are stored in an array.
Assumes that caller holds LOCK.</dd><p class="pad"></p>
</dl>

<h2><a name="DOD_Synchronization_Functions"
>DOD Synchronization Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_DOD_start_mark(Parrot_Interp_interpreter)"
><b><code lang='und' xml:lang='und'>void pt_DOD_start_mark(Parrot_Interp interpreter)</b></code></a></dt><p class="pad"></p>

<dd>DOD is gonna start the mark phase.
In the presence of shared PMCs,
we can only run one DOD run at a time because <code lang='und' xml:lang='und'>PMC&#45;&#62;next_for_GC</code> may be changed.</dd><p class="pad"></p>

<dd>TODO &#45; Have a count of shared PMCs and check it during DOD.</dd><p class="pad"></p>

<dd>TODO &#45; Evaluate,
if a interpreter lock is cheaper,
when <code lang='und' xml:lang='und'>dod_mark_ptr</code> is updated.</dd><p class="pad"></p>

<dt><a name="void_pt_DOD_mark_root_finished(Parrot_Interp_interpreter)"
><b><code lang='und' xml:lang='und'>void pt_DOD_mark_root_finished(Parrot_Interp interpreter)</b></code></a></dt><p class="pad"></p>

<dd>DOD is finished for the root set.</dd><p class="pad"></p>

<dt><a name="void_pt_DOD_stop_mark(Parrot_Interp_interpreter)"
><b><code lang='und' xml:lang='und'>void pt_DOD_stop_mark(Parrot_Interp interpreter)</b></code></a></dt><p class="pad"></p>

<dd>DOD&#39;s mark phase is done.</dd><p class="pad"></p>
</dl>

<h1><a name="HISTORY"
>HISTORY <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>2003.12.18 leo initial rev</p>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'><a href="pmc/parrotinterpreter.pmc.html">src/pmc/parrotinterpreter.pmc</a></em>,
<em lang='und' xml:lang='und'><a href="../docs/dev/events.pod.html">docs/dev/events.pod</a></em>.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
