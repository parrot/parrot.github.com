<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Thread handling stuff</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Thread handling stuff</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>src/thread.c &#45; Thread handling stuff</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>Threads are created by creating new <code>ParrotInterpreter</code> objects.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="static_PMC_*_make_local_copy"
><b><code>static PMC *make_local_copy</b></code></a></dt>
Creates a local copy of the PMC if necessary.
(No copy is made if it is marked shared.) This includes workarounds for Parrot_clone() not doing the Right Thing with subroutines (specifically,
code segments aren&#39;t preserved and it is difficult to do so as long as Parrot_clone() depends on freezing).
<dt><a name="static_Shared_gc_info_*_get_pool"
><b><code>static Shared_gc_info *get_pool</b></code></a></dt>
Gets the shared gc information.
For now this is global data; ideally it will become something other than a static variable.
If everything uses this function,
it will be easier to change.
<dt><a name="void_pt_free_pool"
><b><code>void pt_free_pool</b></code></a></dt>
Frees the shared GC information.
This clears any global data when joining all threads at parent interpreter destruction.
<dt><a name="static_PMC_*_make_local_args_copy"
><b><code>static PMC *make_local_args_copy</b></code></a></dt>
Make a local copy of the corresponding array of arguments.
<dt><a name="PMC_*_pt_shared_fixup"
><b><code>PMC *pt_shared_fixup</b></code></a></dt>
Modifies a PMC to be sharable.
Right now,
reassigns the vtable to one owned by some master interpreter,
so the PMC can be safely reused after thread death.In the future the PMC returned might be different than the one passed,
e.g.,
if we need to reallocate the PMC in a different interpreter.
<dt><a name="static_void_pt_thread_signal"
><b><code>static void pt_thread_signal</b></code></a></dt>
Wakes up an <code>interp</code> which should have called pt_thread_wait().
<dt><a name="void_pt_thread_wait_with"
><b><code>void pt_thread_wait_with</b></code></a></dt>
Waits for this interpreter to be signalled through its condition variable,
dealing properly with GC issues.
<code>*mutex</code> is assumed locked on entry and will be locked on exit from this function.
If a GC run occurs in the middle of this function,
then a spurious wakeup may occur.
<dt><a name="static_void_pt_thread_wait"
><b><code>static void pt_thread_wait</b></code></a></dt>
Waits for a signal,
handling GC matters correctly.
<code>interpreter_array_mutex</code> is assumed held.
Spurious wakeups may occur.
<dt><a name="static_void*_thread_func"
><b><code>static void *thread_func</b></code></a></dt>
The actual thread function.</dl>

<h2><a name="Helper_functions_used_also_for_running_plain_interpreters"
>Helper functions used also for running plain interpreters <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_clone_code"
><b><code>void pt_clone_code</b></code></a></dt>
Copies/clones the packfile/code from interpreter <code>s</code> to <code>d</code>.
All resources are created in <code>d</code>.
<dt><a name="static_void_pt_ns_clone"
><b><code>static void pt_ns_clone</b></code></a></dt>
Clones all globals from <code>s</code> to <code>d</code>.
<dt><a name="void_pt_clone_globals"
><b><code>void pt_clone_globals</b></code></a></dt>
Copies the global namespace when cloning a new interpreter.
<dt><a name="void_pt_thread_prepare_for_run"
><b><code>void pt_thread_prepare_for_run</b></code></a></dt>
Sets up a new thread to run.</dl>

<h2><a name="ParrotThread_methods"
>ParrotThread methods <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="PMC_*_pt_transfer_sub"
><b><code>PMC *pt_transfer_sub</b></code></a></dt>
Clones the sub so that it&#39;s suitable for the other interpreter.
<dt><a name="int_pt_thread_run"
><b><code>int pt_thread_run</b></code></a></dt>
Runs the <code>*sub</code> PMC in a separate thread using the interpreter in <code>*dest_interp</code>.<code>arg</code> should be an array of arguments for the subroutine.
<dt><a name="int_pt_thread_run_1"
><b><code>int pt_thread_run_1</b></code></a></dt>
Runs a thread that shares nothing and does not communicate with the other interpreter.
<dt><a name="int_pt_thread_run_2"
><b><code>int pt_thread_run_2</b></code></a></dt>
Runs an interpreter in a thread with no shared variables,
but which communicates by sending messages.
<dt><a name="int_pt_thread_run_3"
><b><code>int pt_thread_run_3</b></code></a></dt>
Runs an interpreter in a thread,
allowing shared variables and using a thread pool.
<dt><a name="void_pt_thread_yield"
><b><code>void pt_thread_yield</b></code></a></dt>
Relinquishes hold on the processor.
<dt><a name="static_Parrot_Interp_pt_check_tid"
><b><code>static Parrot_Interp pt_check_tid</b></code></a></dt>
Helper function.
Checks if the given thread ID is valid.
The caller holds the mutex.
Returns the interpreter for <code>tid</code>.
<dt><a name="static_void_mutex_unlock"
><b><code>static void mutex_unlock</b></code></a></dt>
Unlocks the mutex <code>*arg</code>.
<dt><a name="static_int_is_suspended_for_gc"
><b><code>static int is_suspended_for_gc</b></code></a></dt>
Returns true iff <code>interp</code> is suspended for a global GC run.
Be sure to hold <code>interpreter_array_mutex</code>.
<dt><a name="static_QUEUE_ENTRY_*_remove_queued_suspend_gc"
><b><code>static QUEUE_ENTRY *remove_queued_suspend_gc</b></code></a></dt>
Removes an event requesting that the interpreter suspend itself for a garbage&#45;collection run from the event queue.
<dt><a name="static_int_pt_gc_count_threads"
><b><code>static int pt_gc_count_threads</b></code></a></dt>
Returns the number of active threads in the system (running or suspended).
Be sure to hold <code>interpreter_array_mutex</code>.
<dt><a name="static_void_pt_gc_wait_for_stage"
><b><code>static void pt_gc_wait_for_stage</b></code></a></dt>
Waits until all threads have reached the desired stage.
Takes an interpreter,
starting stage and ending stage as arguments.
Updates the thread information.
Used in <code>pt_DOD_start_mark</code> and <code>pt_DOD_stop_mark</code>.
<dt><a name="static_void_pt_gc_wakeup_check"
><b><code>static void pt_gc_wakeup_check</b></code></a></dt>
Checks if it&#39;s necessary to wake threads to perform garbage collection.
This is called after thread death.
Be sure to hold <code>interpreter_array_mutex</code>.
<dt><a name="static_void_pt_suspend_one_for_gc"
><b><code>static void pt_suspend_one_for_gc</b></code></a></dt>
Suspends a single interpreter for GC.
Be sure to hold <code>interpreter_array_mutex</code>.
<dt><a name="static_void_pt_suspend_all_for_gc"
><b><code>static void pt_suspend_all_for_gc</b></code></a></dt>
Notifies all threads to perform a GC run.
<dt><a name="void_pt_suspend_self_for_gc"
><b><code>void pt_suspend_self_for_gc</b></code></a></dt>
Suspends this thread for a full GC run.XXX FIXME &#45;&#45; if GC is blocked,
we need to do a GC run as soon as it becomes unblocked.
<dt><a name="PMC*_pt_thread_join"
><b><code>PMC *pt_thread_join</b></code></a></dt>
Joins (by waiting for) a joinable thread.
<dt><a name="void_pt_join_threads"
><b><code>void pt_join_threads</b></code></a></dt>
Possibly waits for other running threads.
This is called when destroying <code>interp</code>.
<dt><a name="static_Parrot_Interp_detach"
><b><code>static Parrot_Interp detach</b></code></a></dt>
Helper for detach and kill.Returns the interpreter,
if it didn&#39;t finish yet.
<dt><a name="void_pt_thread_detach"
><b><code>void pt_thread_detach</b></code></a></dt>
Detaches the thread,
making it non&#45;joinable.
<dt><a name="void_pt_thread_kill"
><b><code>void pt_thread_kill</b></code></a></dt>
Kills the thread.</dl>

<h2><a name="Threaded_interpreter_book&#45;keeping"
>Threaded interpreter book&#45;keeping <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_add_to_interpreters"
><b><code>void pt_add_to_interpreters</b></code></a></dt>
Stores the given interpreter in the array of all interpreters.
Be sure to hold <code>interpreter_array_mutex</code>.</dl>

<h2><a name="DOD_Synchronization_Functions"
>DOD Synchronization Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_pt_DOD_start_mark"
><b><code>void pt_DOD_start_mark</b></code></a></dt>
Record that the mark phase of DOD is about to begin.
In the presence of shared PMCs,
we can only run one DOD run at a time because <code>PMC&#45;&#62;next_for_GC</code> may be changed.<code>flags</code> are the DOD flags.
We check if we need to collect shared objects or not.TODO &#45; Have a count of shared PMCs and check it during DOD.TODO &#45; Evaluate if a interpreter lock is cheaper when <code>dod_mark_ptr</code> is updated.
<dt><a name="void_pt_DOD_mark_root_finished"
><b><code>void pt_DOD_mark_root_finished</b></code></a></dt>
Records that DOD has finished for the root set.
EXCEPTION_UNIMPLEMENTED
<dt><a name="void_pt_DOD_stop_mark"
><b><code>void pt_DOD_stop_mark</b></code></a></dt>
Records that the mark phase of DOD has completed.
<dt><a name="void_Parrot_shared_DOD_block"
><b><code>void Parrot_shared_DOD_block</b></code></a></dt>
Blocks stop&#45;the&#45;world DOD runs.
<dt><a name="void_Parrot_shared_DOD_unblock"
><b><code>void Parrot_shared_DOD_unblock</b></code></a></dt>
Unblocks stop&#45;the&#45;world DOD runs.</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
