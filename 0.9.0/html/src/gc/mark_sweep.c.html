<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Small Object Pools and general mark/sweep GC behavior</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Small Object Pools and general mark/sweep GC behavior</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/gc/mark_sweep.c &#45; Small Object Pools and general mark/sweep GC behavior</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Handles the accessing of small object pools (header pools).
All of the mark/sweep garbage collectors use this code.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_Parrot_gc_ms_run"
><b><code>void Parrot_gc_ms_run</b></code></a></dt>
Runs the stop&#45;the&#45;world mark &#38; sweep (MS) collector.
<dt><a name="int_Parrot_gc_trace_root"
><b><code>int Parrot_gc_trace_root</b></code></a></dt>
Traces the root set.
Returns 0 if it&#39;s a lazy DOD run and all objects that need timely destruction were found.<code>trace_stack</code> can have these values:
<ul>
<li>GC_TRACE_FULL</li>

<p>trace whole root set,
including system areas</p>

<li>GC_TRACE_ROOT_ONLY</li>

<p>trace normal roots,
no system areas</p>

<li>GC_TRACE_SYSTEM_ONLY</li>

<p>trace system areas only</p>
</ul>

<dt><a name="void_Parrot_gc_sweep"
><b><code>void Parrot_gc_sweep</b></code></a></dt>
Puts any buffers/PMCs that are now unused onto the pool&#39;s free list.
If <code>GC_IS_MALLOC</code>,
bufstart gets freed too,
if possible.
Avoids buffers that are immune from collection (i.e.
constant).
<dt><a name="void_pobject_lives"
><b><code>void pobject_lives</b></code></a></dt>
Marks the PObj as &#34;alive&#34; for the Garbage Collector.
Takes a pointer to a PObj,
and performs necessary marking to ensure the PMC and its direct children nodes are marked alive.
Implementation is generally dependant on the particular garbage collector in use.
<dt><a name="INTVAL_contained_in_pool"
><b><code>INTVAL contained_in_pool</b></code></a></dt>
Returns whether the given <code>*ptr</code> points to a location in <code>pool</code>.
<dt><a name="int_Parrot_is_const_pmc"
><b><code>int Parrot_is_const_pmc</b></code></a></dt>
Returns whether <code>*pmc</code> is a constant PMC.
The given pointer is a constant PMC if it points into the constant PMC pool.
<dt><a name="static_void_mark_special"
><b><code>static void mark_special</b></code></a></dt>
Marks the children of a special PMC.
Handles the marking necessary for shared PMCs,
and ensures timely marking of high&#45;priority PMCs.
Ensures PMC_EXT structures are properly organized for garbage collection.
<dt><a name="static_void_more_traceable_objects"
><b><code>static void more_traceable_objects</b></code></a></dt>
We&#39;re out of traceable objects.
First we try a DOD run to free some up.
If that doesn&#39;t work,
allocate a new arena.
<dt><a name="static_void_gc_ms_add_free_pmc_ext"
><b><code>static void gc_ms_add_free_pmc_ext</b></code></a></dt>
Add a freed PMC_EXT structure to the free list in the PMC_EXT pool.
Objects on the free list can be reused later.
<dt><a name="static_void_gc_ms_add_free_object"
><b><code>static void gc_ms_add_free_object</b></code></a></dt>
Add an unused object back to the pool&#39;s free list for later reuse.
Set the PObj flags to indicate that the item is free.
<dt><a name="static_void_*_gc_ms_get_free_object"
><b><code>static void *gc_ms_get_free_object</b></code></a></dt>
Free object allocator for the MS garbage collector system.
If there are no free objects,
call <code>gc_ms_add_free_object</code> to either free them up with a DOD run,
or allocate new objects.
If there are objects available on the free list,
pop it off and return it.
<dt><a name="static_void_*_gc_ms_get_free_pmc_ext"
><b><code>static void *gc_ms_get_free_pmc_ext</b></code></a></dt>
Get a new PMC_EXT structure from the free pool and return it.
<dt><a name="static_int_sweep_cb"
><b><code>static int sweep_cb</b></code></a></dt>
Sweeps the given pool for the MS collector.
This function also ends the profiling timer,
if profiling is enabled.
Returns the total number of objects freed.
<dt><a name="static_int_trace_active_PMCs"
><b><code>static int trace_active_PMCs</b></code></a></dt>
Performs a full trace run and marks all the PMCs as active if they are.
Returns whether the run completed,
that is,
whether it&#39;s safe to proceed with GC.
<dt><a name="static_void_clear_live_bits"
><b><code>static void clear_live_bits</b></code></a></dt>
Runs through all PMC arenas and clear live bits.
This is used to reset the GC system after a full system sweep.
<dt><a name="void_Parrot_gc_clear_live_bits"
><b><code>void Parrot_gc_clear_live_bits</b></code></a></dt>
Resets the PMC pool,
so all objects are marked as &#34;White&#34;.
This is done after a GC run to reset the system and prepare for the next mark phase.
<dt><a name="int_Parrot_gc_trace_children"
><b><code>int Parrot_gc_trace_children</b></code></a></dt>
Returns whether the tracing process has completed.
<dt><a name="void_Parrot_add_to_free_list"
><b><code>void Parrot_add_to_free_list</b></code></a></dt>
Adds the objects in the newly allocated <code>arena</code> to the free list.
<dt><a name="void_Parrot_append_arena_in_pool"
><b><code>void Parrot_append_arena_in_pool</b></code></a></dt>
Insert the new arena into the pool&#39;s structure.
Arenas are stored in a linked list,
so add the new arena to the list.
Set information in the arenas structure,
such as the number of objects allocated in it.
<dt><a name="static_void_gc_ms_alloc_objects"
><b><code>static void gc_ms_alloc_objects</b></code></a></dt>
New arena allocator function for the MS garbage collector system.
Allocates and initializes a new memory arena in the given pool.
Adds all the new objects to the pool&#39;s free list for later allocation.
<dt><a name="Small_Object_Pool_*_new_small_object_pool"
><b><code>Small_Object_Pool *new_small_object_pool</b></code></a></dt>
Creates a new <code>Small_Object_Pool</code> and returns a pointer to it.
Initializes the pool structure based on the size of objects in the pool and the number of items to allocate in each arena.
<dt><a name="void_gc_pmc_ext_pool_init"
><b><code>void gc_pmc_ext_pool_init</b></code></a></dt>
Initialize the PMC_EXT pool functions.
This is done separately from other pools.
<dt><a name="static_void_gc_ms_pool_init"
><b><code>static void gc_ms_pool_init</b></code></a></dt>
Initialize a memory pool for the MS garbage collector system.
Sets the function pointers necessary to perform basic operations on a pool,
such as object allocation.
<dt><a name="void_Parrot_gc_ms_init"
><b><code>void Parrot_gc_ms_init</b></code></a></dt>
Initialize the state structures of the gc system.
Called immediately before creation of memory pools.
This function must set the function pointers for <code>add_free_object_fn</code>,
<code>get_free_object_fn</code>,
<code>alloc_object_fn</code>,
and <code>more_object_fn</code>.
<dt><a name="void_Parrot_small_object_pool_merge"
><b><code>void Parrot_small_object_pool_merge</b></code></a></dt>
Merge pool <code>source</code> into pool <code>dest</code>.
Combines the free lists directly,
moves all arenas to the new pool,
and remove the old pool.
To merge,
the two pools must have the same object size,
and the same name (if they have names).</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em>include/parrot/mark_sweep.h</em>,
<em><a href="../../docs/memory_internals.pod.html">docs/memory_internals.pod</a></em>.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
