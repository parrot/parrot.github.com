<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>compilers/imcc/optimizer.c</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">compilers/imcc/optimizer.c</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/compilers.html">Compilers</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>compilers/imcc/optimizer.c</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Optimization occurs in three stages: 1) pre_optimizer &#45;&#45; runs before control flow graph (CFG) is built 2) optimizer &#45;&#45; runs after CFG is built,
but before register allocation 3) post_optimizer &#45;&#45; runs after register allocation</p>

<p>pre_optimizer &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>During pre&#45;optimization we perform optimizations which don&#39;t require full knowledge of the control flow graph and the life ranges of each variable.
This phase is handled by two functions: pre_optimize() and cfg_optimize().</p>

<p>pre_optimize() runs before the construction of the CFG begins.
It calls strength_reduce() to perform simple strength reduction,
and if_branch() to rewrite certain if/branch/label constructs (for details,
see if_branch() below).</p>

<p>[pre_optimize() may also be called later,
during the main optimization phase,
but this is not guaranteed.]</p>

<p>cfg_optimize() runs during the construction of the CFG.
It calls branch_branch() to perform jump optimization (i.e.
branches to branch statements or jumps to jumps are converted into single branches/jumps to the final destination),
unused_label() to remove unused labels and dead_code_remove() to remove unreachable code (e.g.
basic blocks which are never entered or instructions after and unconditional branch which are never branched to).</p>

<p>cfg_optimize may be called multiple times during the construction of the CFG depending on whether or not it finds anything to optimize.</p>

<p>RT #46277: subst_constants ...
rewrite e.g.
add_i_ic_ic &#45;&#45; where does this happen?</p>

<p>optimizer &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>runs with CFG and life info</p>

<p>used_once ...
deletes assignments,
when LHS is unused RT #46279 e.g.
constant_propagation</p>

<p>post_optimizer: currently pcc_optimize in pcc.c &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>runs after register alloocation</p>

<p>e.g.
eliminate new Px .PerlUndef because Px where different before</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="int_pre_optimize"
><b><code>int pre_optimize</b></code></a></dt>
Handles optimizations occuring before the construction of the CFG.
<dt><a name="int_cfg_optimize"
><b><code>int cfg_optimize</b></code></a></dt>
Handles optimizations occuring during the construction of the CFG.
Returns TRUE if any optimization was performed.
Otherwise,
returns FALSE.
<dt><a name="int_optimize"
><b><code>int optimize</b></code></a></dt>
RT #48260: Not yet documented!!!
<dt><a name="const_char_*_get_neg_op"
><b><code>const char *get_neg_op</b></code></a></dt>
Get negated form of operator.
If no negated form is known,
return NULL.
<dt><a name="static_int_if_branch"
><b><code>static int if_branch</b></code></a></dt>
Convert if/branch/label constructs of the form:
<pre>  if cond L1
  branch L2
  L1</pre>
to the simpler negated form:
<pre>  unless cond L2</pre>

<dt><a name="static_int_strength_reduce"
><b><code>static int strength_reduce</b></code></a></dt>
strength_reduce ... rewrites e.g add Ix, Ix, y =&#62; add Ix, yThese are run after constant simplification, so it is guaranteed that one operand is non constant if opsize == 4
<dt><a name="static_int_constant_propagation"
><b><code>static int constant_propagation</b></code></a></dt>
Does conservative constant propagation. This code will not propagate constants past labels or saves, even though sometimes it may be safe.
<dt><a name="Instruction_*_IMCC_subst_constants_umix"
><b><code>Instruction *IMCC_subst_constants_umix</b></code></a></dt>
rewrite e.g. add_n_ic =&#62; add_n_nc
<dt><a name="static_int_eval_ins"
><b><code>static int eval_ins</b></code></a></dt>
Run one parrot instruction, registers are filled with the according constants. If an exception occurs, return &#45;1, aborting this optimization: this lets the runtime handle any exceptions.
<dt><a name="Instruction_*_IMCC_subst_constants"
><b><code>Instruction *IMCC_subst_constants</b></code></a></dt>
rewrite e.g. add_n_nc_nc =&#62; set_n_nc abs_i_ic =&#62; set_i_ic eq_ic_ic_ic =&#62; branch_ic / delete if_ic_ic =&#62; branch_ic / delete
<dt><a name="static_int_branch_branch"
><b><code>static int branch_branch</b></code></a></dt>
if I0 goto L1 =&#62; if IO goto L2 ... L1: branch L2Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.
<dt><a name="static_int_branch_reorg"
><b><code>static int branch_reorg</b></code></a></dt>
branch L2 =&#62; ... L1: branch L4 ... L1: branch L3 ... L2: branch L3 ... L5: branch L4 L5:Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.
<dt><a name="static_int_branch_cond_loop_swap"
><b><code>static int branch_cond_loop_swap</b></code></a></dt>
RT #48260: Not yet documented!!!
<dt><a name="static_int_branch_cond_loop"
><b><code>static int branch_cond_loop</b></code></a></dt>
start: =&#62; start: if cond goto end if cond goto end ... branch start start_post1: end: ... unless cond goto start_post562 end:The basic premise is &#34;branch (A) to conditional (B), where B goes to just after A.&#34;Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.
<dt><a name="static_int_unused_label"
><b><code>static int unused_label</b></code></a></dt>
Removes unused labels. A label is unused if ... [RT #46287: finish this].Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.
<dt><a name="static_int_dead_code_remove"
><b><code>static int dead_code_remove</b></code></a></dt>
RT #48260: Not yet documented!!!
<dt><a name="static_int_used_once"
><b><code>static int used_once</b></code></a></dt>
RT #48260: Not yet documented!!!</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
