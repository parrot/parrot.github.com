<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Allocate and deallocate tracked resources</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Allocate and deallocate tracked resources</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/gc/resources.c &#45; Allocate and deallocate tracked resources</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<h2><a name="Parrot_Memory_Management_Code"
>Parrot Memory Management Code <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="static_void_alloc_new_block"
><b><code lang='und' xml:lang='und'>static void alloc_new_block</b></code></a></dt><p class="pad"></p>

<dd>Allocate a new memory block.
We allocate either the requested size or the default size,
whichever is larger.
Add the new block to the given memory pool.
The given <code lang='und' xml:lang='und'>char *why</code> text is used for debugging.</dd><p class="pad"></p>

<dt><a name="static_void_*_mem_allocate"
><b><code lang='und' xml:lang='und'>static void *mem_allocate</b></code></a></dt><p class="pad"></p>

<dd>Allocates memory for headers.</dd><p class="pad"></p>

<dd>Alignment problems history:</dd><p class="pad"></p>

<dd>See <a href='http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html'><a href="http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html">http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html</a></a> for details.</dd><p class="pad"></p>

<dd>&#45; return aligned pointer *if needed* &#45; return strings et al at unaligned i.e.
void* boundaries &#45; remember alignment in a buffer header bit use this in compaction code &#45; reduce alignment to a reasonable value i.e.
MALLOC_ALIGNMENT aka 2*sizeof (size_t) or just 8 (TODO make a config hint)</dd><p class="pad"></p>

<dd>Buffer memory layout:</dd><p class="pad"></p>

<pre lang='und' xml:lang='und'>                    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+
                    |  ref_count   |f |    # GC header
  obj&#45;&#62;bufstart  &#45;&#62; +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+
                    |  data           |
                    v                 v

 * if PObj_is_COWable is set, then we have
   &#45; a ref_count, {inc, dec}remented by 2 always
   &#45; the lo bit &#39;f&#39; means &#39;is being forwarded&#34; &#45; what TAIL_flag was

 * if PObj_align_FLAG is set, obj&#45;&#62;bufstart is aligned like discussed above
 * obj&#45;&#62;buflen is the usable length excluding the optional GC part.</pre>

<dt><a name="static_const_char*_buffer_location"
><b><code lang='und' xml:lang='und'>static const char *buffer_location</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="static_void_debug_print_buf"
><b><code lang='und' xml:lang='und'>static void debug_print_buf</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>
</dl>

<h2><a name="Compaction_Code"
>Compaction Code <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="static_void_compact_pool"
><b><code lang='und' xml:lang='und'>static void compact_pool</b></code></a></dt><p class="pad"></p>

<dd>Compact the string buffer pool. Does not perform a GC scan, or mark items as being alive in any way.</dd><p class="pad"></p>

<dt><a name="void_Parrot_go_collect"
><b><code lang='und' xml:lang='und'>void Parrot_go_collect</b></code></a></dt><p class="pad"></p>

<dd>Scan the string pools and compact them. This does not perform a GC mark or sweep run, and does not check whether string buffers are still alive. Redirects to <code lang='und' xml:lang='und'>compact_pool</code>.</dd><p class="pad"></p>

<dt><a name="static_size_t_aligned_size"
><b><code lang='und' xml:lang='und'>static size_t aligned_size</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="static_char_*_aligned_mem"
><b><code lang='und' xml:lang='und'>static char *aligned_mem</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="static_size_t_aligned_string_size"
><b><code lang='und' xml:lang='und'>static size_t aligned_string_size</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="int_Parrot_in_memory_pool"
><b><code lang='und' xml:lang='und'>int Parrot_in_memory_pool</b></code></a></dt><p class="pad"></p>

<dd>Determines if the given <code lang='und' xml:lang='und'>bufstart</code> pointer points to a location inside the memory pool. Returns 1 if the pointer is in the memory pool, 0 otherwise.</dd><p class="pad"></p>
</dl>

<h2><a name="Parrot_Re/Allocate_Code"
>Parrot Re/Allocate Code <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_Parrot_reallocate"
><b><code lang='und' xml:lang='und'>void Parrot_reallocate</b></code></a></dt><p class="pad"></p>

<dd>Reallocate the Buffer&#39;s buffer memory to the given size. The allocated buffer will not shrink. If the buffer was allocated with <a href='TODO'>Parrot_allocate_aligned</a> the new buffer will also be aligned. As with all reallocation, the new buffer might have moved and the additional memory is not cleared.</dd><p class="pad"></p>

<dt><a name="void_Parrot_reallocate_string"
><b><code lang='und' xml:lang='und'>void Parrot_reallocate_string</b></code></a></dt><p class="pad"></p>

<dd>Reallocate the STRING&#39;s buffer memory to the given size. The allocated buffer will not shrink. This function sets also <code lang='und' xml:lang='und'>str&#45;&#62;strstart</code> to the new buffer location, <code lang='und' xml:lang='und'>str&#45;&#62;bufused</code> is <b>not</b> changed.</dd><p class="pad"></p>

<dt><a name="void_Parrot_allocate"
><b><code lang='und' xml:lang='und'>void Parrot_allocate</b></code></a></dt><p class="pad"></p>

<dd>Allocate buffer memory for the given Buffer pointer. The <code lang='und' xml:lang='und'>size</code> has to be a multiple of the word size. <code lang='und' xml:lang='und'>PObj_buflen</code> will be set to exactly the given <code lang='und' xml:lang='und'>size</code>.</dd><p class="pad"></p>

<dt><a name="void_Parrot_allocate_aligned"
><b><code lang='und' xml:lang='und'>void Parrot_allocate_aligned</b></code></a></dt><p class="pad"></p>

<dd>Like above, except the <code lang='und' xml:lang='und'>size</code> will be rounded up and the address of the buffer will have the same alignment as a pointer returned by malloc(3) suitable to hold e.g. a <code lang='und' xml:lang='und'>FLOATVAL</code> array.</dd><p class="pad"></p>

<dt><a name="void_Parrot_allocate_string"
><b><code lang='und' xml:lang='und'>void Parrot_allocate_string</b></code></a></dt><p class="pad"></p>

<dd>Allocate the STRING&#39;s buffer memory to the given size. The allocated buffer maybe slightly bigger than the given <code lang='und' xml:lang='und'>size</code>. This function sets also <code lang='und' xml:lang='und'>str&#45;&#62;strstart</code> to the new buffer location, <code lang='und' xml:lang='und'>str&#45;&#62;bufused</code> is <b>not</b> changed.</dd><p class="pad"></p>

<dt><a name="static_Memory_Pool_*_new_memory_pool"
><b><code lang='und' xml:lang='und'>static Memory_Pool *new_memory_pool</b></code></a></dt><p class="pad"></p>

<dd>Allocate a new <code lang='und' xml:lang='und'>Memory_Pool</code> structures, and set some initial values. return a pointer to the new pool.</dd><p class="pad"></p>

<dt><a name="void_Parrot_initialize_memory_pools"
><b><code lang='und' xml:lang='und'>void Parrot_initialize_memory_pools</b></code></a></dt><p class="pad"></p>

<dd>Initialize the managed memory pools. Parrot maintains two <code lang='und' xml:lang='und'>Memory_Pool</code> structures, the general memory pool and the constant string pool. Create and initialize both pool structures, and allocate initial blocks of memory for both.</dd><p class="pad"></p>

<dt><a name="void_Parrot_destroy_memory_pools"
><b><code lang='und' xml:lang='und'>void Parrot_destroy_memory_pools</b></code></a></dt><p class="pad"></p>

<dd>Destroys the memory pool and the constant string pool. Loop through both pools and destroy all memory blocks contained in them. Once all the blocks are freed, free the pools themselves.</dd><p class="pad"></p>

<dt><a name="static_void_merge_pools"
><b><code lang='und' xml:lang='und'>static void merge_pools</b></code></a></dt><p class="pad"></p>

<dd>Merge two memory pools together. Do this by moving all memory blocks from the <code lang='und' xml:lang='und'>*source</code> pool into the <code lang='und' xml:lang='und'>*dest</code> pool. The <code lang='und' xml:lang='und'>source</code> pool is emptied, but is not destroyed here.</dd><p class="pad"></p>

<dt><a name="void_Parrot_merge_memory_pools"
><b><code lang='und' xml:lang='und'>void Parrot_merge_memory_pools</b></code></a></dt><p class="pad"></p>

<dd>Merge the memory pools of two interpreter structures. Merge the general memory pool and the constant string pools from <code lang='und' xml:lang='und'>source_interp</code> into <code lang='und' xml:lang='und'>dest_interp</code>.</dd><p class="pad"></p>
</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'>include/parrot/resources.h</em>, <em lang='und' xml:lang='und'><a href="memory.c.html">src/gc/memory.c</a></em>.</p>

<h1><a name="HISTORY"
>HISTORY <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Initial version by Dan on 2001.10.2.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
