<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Register handling routines</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Register handling routines</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/gc/register.c &#45; Register handling routines</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Parrot has 4 register sets,
one for each of its basic types.
The number of registers in each set varies depending on the use counts of the subroutine and is determined by the PASM/PIR compiler in the register allocation pass (<em lang='und' xml:lang='und'>imcc/reg_alloc.c</em>).</p>

<h2><a name="Context_and_register_frame_layout"
>Context and register frame layout <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    | context  || N  |  I   |   P        |  S +
    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    ^          ^     ^                   ^
    |          |     ctx.bp              ctx.bp_ps
    ctx.state  opt
               padding</pre>

<p>Registers are addressed as usual via the register base pointer ctx.bp.</p>

<p>The macro CONTEXT() hides these details</p>

<h2><a name="Context_and_register_frame_allocation"
>Context and register frame allocation <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>There are two allocation strategies: chunked memory and malloced with a free list.</p>

<pre lang='und' xml:lang='und'> CHUNKED_CTX_MEM = 1</pre>

<p><code lang='und' xml:lang='und'>ctx_mem.data</code> is a pointer to an allocated chunk of memory. The pointer <code lang='und' xml:lang='und'>ctx_mem.free</code> holds the next usable location. With (full) continuations the <code lang='und' xml:lang='und'>ctx_mem.free</code> pointer can&#39;t be moved below the <code lang='und' xml:lang='und'>ctx_mem.threshold</code>, which is the highest context pointer of all active continuations.</p>

<p>[the code for this is incomplete; it had suffered some bit&#45;rot and was getting in the way of maintaining the other case. &#45;&#45; rgr, 4&#45;Feb&#45;06.]</p>

<p>RT #46177 GC has to lower this threshold when collecting continuations.</p>

<pre lang='und' xml:lang='und'> CHUNKED_CTX_MEM = 0</pre>

<p>Context/register memory is malloced. <code lang='und' xml:lang='und'>ctx_mem.free</code> is used as a free list of reusable items.</p>

<p>Round register allocation size up to the nearest multiple of 8. A granularity of 8 is arbitrary, it could have been some bigger power of 2. A &#34;slot&#34; is an index into the free_list array. Each slot in free_list has a linked list of pointers to already allocated contexts available for (re)use. The slot where an available context is stored corresponds to the size of the context.</p>

<h2><a name="Context_and_Register_Allocation_Functions"
>Context and Register Allocation Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_destroy_context"
><b><code lang='und' xml:lang='und'>void destroy_context</b></code></a></dt><p class="pad"></p>

<dd>Frees allocated context memory.</dd><p class="pad"></p>

<dt><a name="void_create_initial_context"
><b><code lang='und' xml:lang='und'>void create_initial_context</b></code></a></dt><p class="pad"></p>

<dd>Creates the interpreter&#39;s initial context.</dd><p class="pad"></p>

<dt><a name="void_parrot_gc_context"
><b><code lang='und' xml:lang='und'>void parrot_gc_context</b></code></a></dt><p class="pad"></p>

<dd>Cleans up dead context memory; called by the garbage collector. This only applies in the chunked context memory scheme.</dd><p class="pad"></p>

<dt><a name="static_void_clear_regs"
><b><code lang='und' xml:lang='und'>static void clear_regs</b></code></a></dt><p class="pad"></p>

<dd>Clears all registers in a context. PMC and STRING registers contain PMCNULL and NULL, respectively. Integer and float registers contain negative flag values, for debugging purposes.</dd><p class="pad"></p>

<dt><a name="static_void_init_context"
><b><code lang='und' xml:lang='und'>static void init_context</b></code></a></dt><p class="pad"></p>

<dd>Initializes a freshly allocated or recycled context.</dd><p class="pad"></p>

<dt><a name="Parrot_Context_*_Parrot_dup_context"
><b><code lang='und' xml:lang='und'>Parrot_Context *Parrot_dup_context</b></code></a></dt><p class="pad"></p>

<dd>Duplicates the passed context, making the result the current context.</dd><p class="pad"></p>

<dt><a name="Parrot_Context_*_Parrot_push_context"
><b><code lang='und' xml:lang='und'>Parrot_Context *Parrot_push_context</b></code></a></dt><p class="pad"></p>

<dd>Creates and sets the current context to a new context, remembering the old context in <code lang='und' xml:lang='und'>caller_ctx</code>. Suitable to use with <code lang='und' xml:lang='und'>Parrot_pop_context</code>.</dd><p class="pad"></p>

<dt><a name="void_Parrot_pop_context"
><b><code lang='und' xml:lang='und'>void Parrot_pop_context</b></code></a></dt><p class="pad"></p>

<dd>Frees the context created with <code lang='und' xml:lang='und'>Parrot_push_context</code> and restores the previous context (the caller context).</dd><p class="pad"></p>

<dt><a name="Parrot_Context_*_Parrot_alloc_context"
><b><code lang='und' xml:lang='und'>Parrot_Context *Parrot_alloc_context</b></code></a></dt><p class="pad"></p>

<dd>Allocates and returns a new context as the current context. Note that the register usage <code lang='und' xml:lang='und'>n_regs_used</code> is copied.</dd><p class="pad"></p>

<dt><a name="void_Parrot_free_context"
><b><code lang='und' xml:lang='und'>void Parrot_free_context</b></code></a></dt><p class="pad"></p>

<dd>Frees the context. If <code lang='und' xml:lang='und'>re_use</code> is true, this function is called by a return continuation invoke, else from the destructor of a continuation.</dd><p class="pad"></p>

<dt><a name="void_Parrot_set_context_threshold"
><b><code lang='und' xml:lang='und'>void Parrot_set_context_threshold</b></code></a></dt><p class="pad"></p>

<dd>Marks the context as possible threshold.</dd><p class="pad"></p>
</dl>

<h2><a name="Register_Stack_Functions"
>Register Stack Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_Parrot_clear_i"
><b><code lang='und' xml:lang='und'>void Parrot_clear_i</b></code></a></dt><p class="pad"></p>

<dd>Sets all integer registers in the current context to 0.</dd><p class="pad"></p>

<dt><a name="void_Parrot_clear_s"
><b><code lang='und' xml:lang='und'>void Parrot_clear_s</b></code></a></dt><p class="pad"></p>

<dd>Sets all STRING registers in the current context to NULL.</dd><p class="pad"></p>

<dt><a name="void_Parrot_clear_p"
><b><code lang='und' xml:lang='und'>void Parrot_clear_p</b></code></a></dt><p class="pad"></p>

<dd>Sets all PMC registers in the current context to NULL.</dd><p class="pad"></p>

<dt><a name="void_Parrot_clear_n"
><b><code lang='und' xml:lang='und'>void Parrot_clear_n</b></code></a></dt><p class="pad"></p>

<dd>Sets all number registers in the current context to 0.0.</dd><p class="pad"></p>
</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'>include/parrot/register.h</em> and <em lang='und' xml:lang='und'><a href="../stacks.c.html">src/stacks.c</a></em>.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
