<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Parrot Installation</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot Installation</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../../html/index.html">Contents</a> | <a href="../../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>docs/pdds/draft/pdd30_install.pod &#45; Parrot Installation</p>

<h1><a name="ABSTRACT"
>ABSTRACT <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>This PDD outlines Parrot&#39;s installation system and support.
Parrot&#39;s core installation system will provide support for binary packages,
a working <code lang='und' xml:lang='und'>make install</code> target,
compiled installables,
and FHS compliant search paths for the installables.
This document also aims to solve the current problem of accessing installed source&#45;only files,
and to allow the optimization of config bootstrapping if a frozen config_hash is already linked.</p>

<h1><a name="VERSION"
>VERSION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>$Revision$</p>

<h1><a name="SYNOPSIS"
>SYNOPSIS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Short&#45;term parrot core goal:</p>

<pre lang='und' xml:lang='und'>  make install DESTDIR=/tmp/inst
  make test&#45;installable &#45;C language/lang
  make installable &#45;C language/lang
  make install &#45;C language/lang DESTDIR=/tmp/inst</pre>

<p>Long&#45;term external goal:</p>

<pre lang='und' xml:lang='und'>  cd module_name&#45;1.00 &#38;&#38; parrot Makefile.pir &#38;&#38; make build test install</pre>

<p>or:</p>

<pre lang='und' xml:lang='und'>  cpan6 module_name ... &#45;&#45;download &#45;&#45;build &#45;&#45;test &#45;&#45;installable \
                        &#45;&#45;test&#45;installable &#45;&#45;install</pre>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Parrot&#39;s <em lang='und' xml:lang='und'>MANIFEST</em> will contain the installation path of all files. The installation script <em lang='und' xml:lang='und'><a href="../../../tools/dev/install_files.pl.html">tools/dev/install_files.pl</a></em> is driven by this definition, which contains the filelist and the recommended package if being installed at all. The three runtime paths for &#34;include&#34;, &#34;library&#34; for <code lang='und' xml:lang='und'>load_bytecode</code> and &#34;dynext&#34; for <code lang='und' xml:lang='und'>loadlib</code> should end up in the <em lang='und' xml:lang='und'>$prefix/lib/parrot/</em> paths. {{NOTE: See #56996&#45;fhs&#45;runtime.patch }} Accessing <em lang='und' xml:lang='und'>/usr/runtime</em> is forbidden by the FHS.</p>

<p>The Parrot and language implementions on top of Parrot may be installed as self&#45;hosting single&#45;file executables, with the help of merged pbc&#39;s and pbc2exe &#45;&#45;install. The destination path for the language libraries is not decided yet, two conflicting layouts 1. &#34;a language pbc is a simple library&#34; vs 2. &#34;a language is special&#34; are discussed.</p>

<p>Eg. ad 1. <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/src/WMLScript.pbc&#39;</code> should be replaced by <code lang='und' xml:lang='und'>load_bytecode &#39;WMLScript&#39;</code> and <em lang='und' xml:lang='und'>WMLScript.pbc</em> should be installed to <em lang='und' xml:lang='und'>runtime/parrot/library/WMLScript.pbc</em> which ends up in <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/WMLScript.pbc</em>.</p>

<p>1a. <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript&#39;</code> =&#62; <em lang='und' xml:lang='und'>runtime/parrot/library/languages/WMLScript.pbc</em> =&#62; <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/languages/WMLScript.pbc</em>.</p>

<p>1b. aka &#34;existing practice&#34;: <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/WMLScript.pbc&#39;</code> =&#62; <em lang='und' xml:lang='und'>languages/WMLScript/WMLScript.pbc</em> or <em lang='und' xml:lang='und'>runtime/parrot/library/languages/WMLScript/WMLScript.pbc</em> =&#62; <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/languages/WMLScript/WMLScript.pbc</em>.</p>

<p>ad 2. <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/src/WMLScript.pbc&#39;</code> should be replaced by <code lang='und' xml:lang='und'>load_language &#39;WMLScript&#39;</code> and <em lang='und' xml:lang='und'>WMLScript.pbc</em> should be installed to <em lang='und' xml:lang='und'>runtime/language/library/WMLScript.pbc</em> which ends up in <em lang='und' xml:lang='und'>$prefix/lib/parrot/language/library/WMLScript.pbc</em>. See below at <a href='#Layout_2_%22Parallel_%2D_A_language_is_special%22'>&#34;Layout 2 &#34;Parallel &#45; A language is special&#34;&#34;</a>. {{ ?? }}</p>

<p>Bootstrapping the configuration hash should not read a config file when the hash is already contained in the pmc or executable. {{ See #57418 [TODO] optimize _config to omit .include &#34;library/config.pir&#34; on installables. }} The same problem is for every <code lang='und' xml:lang='und'>.include</code>, <code lang='und' xml:lang='und'>loadlib</code> and <code lang='und' xml:lang='und'>load_bytecode</code> statement in installed files where the target is not installed. If in doubt install the missing library by patching the installation code. For <code lang='und' xml:lang='und'>load_bytecode &#39;PGE/Text.pbc&#39;</code> in some lua src we should take care, that this compiler pbc is really installed or if not merge it into the main <em lang='und' xml:lang='und'>lua.pbc</em>.</p>

<p>Test executables are binary different to installable executables because of this embedded configuration hash. Test executables contain configuration hash with the prefix to the build directory, installables to the given prefix from Configure.pl. The executables that are tested should always be the same as the ones that are installed. Otherwise, subtle bugs can leak into the installed executables which can never be caught by the tests.</p>

<p>There are&#39;s also a long&#45;standing conflict in building Parrot with an already installed shared libparrot.so. See #39742&#45;installed&#45;conflict.patch which adds the blib/lib path to PATH resp. LD_RUN_PATH to all parrot executable invocations.</p>

<h1><a name="DEPENDENCIES"
>DEPENDENCIES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Before you can <code lang='und' xml:lang='und'>make installable &#45;C language/lang</code> or a simple <code lang='und' xml:lang='und'>make</code> or <code lang='und' xml:lang='und'>make installable</code> in the directory <em lang='und' xml:lang='und'>languages</em>, you need to <code lang='und' xml:lang='und'>make parrot_utils</code> and <code lang='und' xml:lang='und'>make installable</code> in the parrot build directory.</p>

<p>The languages have no extra dependencies to the required parrot_utils and <em lang='und' xml:lang='und'>src/install_config.o</em> and <em lang='und' xml:lang='und'>install_config.fpmc</em></p>

<h1><a name="DEFINITIONS"
>DEFINITIONS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>The <b>build_dir</b> is the full path where Parrot was built. It is defined in the configuration hash. When building from source the <code lang='und' xml:lang='und'>build_dir</code> is also the <code lang='und' xml:lang='und'>PARROT_RUNTIME</code> prefix.</p>

<p>An <b>installable</b> is a bytecode or executable file which must not access the build_dir paths. The build_dir path is not available in a binary package. This is solved by generating and linking a special <em lang='und' xml:lang='und'>install_config.fpmc</em>. Custom Python modules have a similar packaging problem, which they haven&#39;t solved yet.</p>

<p>The <b>destination directory</b> is the path of the installed Parrot tree after the prefix (<em lang='und' xml:lang='und'>/usr</em>, <em lang='und' xml:lang='und'>/usr/local</em>, or some other platform&#45;specific or custom location). Creating a virtual installation path like this simplifies packaging by installing into a separate install tree and creating a tarball from that tree.</p>

<p>The <b>configuration hash</b> is the return value of the global function <code lang='und' xml:lang='und'>_config()</code>, generated in <em lang='und' xml:lang='und'>config_lib.pasm</em>, and either defined in <em lang='und' xml:lang='und'>library/config.pir</em>, or as frozen PMC embedded in the test executable (<em lang='und' xml:lang='und'>config.fpmc</em>), the installable executable (<em lang='und' xml:lang='und'>install_config.fpmc</em>) or empty for miniparrot (<em lang='und' xml:lang='und'>null_config.fpmc</em>).</p>

<h2><a name="Layout_1_&#34;A_language_pbc_is_simply_a_library&#34;"
>Layout 1 &#34;A language pbc is simply a library&#34; <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Rationale</b>: A language pbc is not much more than a normal library, so it should go to the normal parrot library path. The library searchpath needs no extension for languages.</p>

<p><code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/src/WMLScript.pbc&#39;</code> should be replaced by <code lang='und' xml:lang='und'>load_bytecode &#39;WMLScript&#39;</code> and <em lang='und' xml:lang='und'>WMLScript.pbc</em> should be installed to <em lang='und' xml:lang='und'>runtime/parrot/library/WMLScript.pbc</em> which ends up in <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/WMLScript.pbc</em>.</p>

<p><b>Usage</b>: <code lang='und' xml:lang='und'>load_bytecode &#39;WMLScript&#39;</code> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>runtime/parrot/library/WMLScript.pbc</em> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/WMLScript.pbc</em></p>

<p>{{ rurban favors this one }}</p>

<h2><a name="Layout_1,_Variant_a_&#34;Don&#39;t_mix_the_libraries_with_the_languages&#34;"
>Layout 1, Variant a &#34;Don&#39;t mix the libraries with the languages&#34; <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Rationale</b>: A language pbc is a library under the <code lang='und' xml:lang='und'>languages</code> namespace. The library searchpath needs no extension for languages. <code lang='und' xml:lang='und'>load_bytecode &#39;languages/bla&#39;</code> makes it clear that <code lang='und' xml:lang='und'>bla</code> is a language, not a library.</p>

<p><b>Usage</b>: <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript&#39;</code> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>runtime/parrot/library/languages/WMLScript.pbc</em> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/languages/WMLScript.pbc</em>.</p>

<h2><a name="Layout_1,_Variant_b_&#34;Below_&#45;_Existing_practice&#34;"
>Layout 1, Variant b &#34;Below &#45; Existing practice&#34; <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Rationale</b>: A language pbc is a language pbc. Other languages assume the path from the build_dir as <em lang='und' xml:lang='und'>languages/WMLScript/WMLScript.pbc</em>, the installation root begins at <em lang='und' xml:lang='und'>$prefix/lib/parrot/library</em>.</p>

<p><b>Usage</b>: <code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/WMLScript.pbc&#39;</code> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>languages/WMLScript/WMLScript.pbc</em> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>$prefix/lib/parrot/library/languages/WMLScript/WMLScript.pbc</em>.</p>

<h2><a name="Layout_2_&#34;Parallel_&#45;_A_language_is_special&#34;"
>Layout 2 &#34;Parallel &#45; A language is special&#34; <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Rationale</b>: Languages are more than simple libraries because they could be invoked by link $0 magic on platforms which do support that. Languages should have their distinct libraries seperate from parrot with seperate dynext, library, include. parrot is just another language, with perl6 sharing the same namespace.</p>

<p>This requires either a new opcode or method to able to override the library searchpath.</p>

<p><code lang='und' xml:lang='und'>load_bytecode &#39;languages/WMLScript/src/WMLScript.pbc&#39;</code> should be replaced by <code lang='und' xml:lang='und'>load_language &#39;WMLScript&#39;</code> and <em lang='und' xml:lang='und'>WMLScript.pbc</em> should be installed to <em lang='und' xml:lang='und'>runtime/languages/library/WMLScript.pbc</em> which ends up in <em lang='und' xml:lang='und'>$prefix/lib/parrot/languages/library/WMLScript.pbc</em>.</p>

<p><b>Usage</b>: <code lang='und' xml:lang='und'>load_language &#39;WMLScript&#39;</code> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>runtime/language/library/WMLScript.pbc</em> =<code lang='und' xml:lang='und'>gt</code> <em lang='und' xml:lang='und'>$prefix/lib/parrot/WMLScript/library/WMLScript.pbc</em> or Variant 2a: <em lang='und' xml:lang='und'>$prefix/lib/parrot/languages/WMLScript/library/WMLScript.pbc</em>.</p>

<p><i>Note</i>: We will not be able to get rid of <em lang='und' xml:lang='und'>/usr/lib/parrot</em> here, so the <em lang='und' xml:lang='und'>runtime/parrot</em> &#60;=&#62; <em lang='und' xml:lang='und'>/usr/lib/parrot mapping</em> is not symetric anymore.</p>

<h2><a name="make_install"
>make install <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>The Parrot build system is currently optimized for building and testing in the build directory, but not for building with an already installed Parrot. This is complicated by some simple build system bugs. It is also not optimized to build and test installables, which should not access libraries in the build directory, but in the destination directory.</p>

<p>The short&#45;term goal of this document is to make installation work for Parrot, its libraries and tools, and its languages so that packagers can provide binary packages for parrot and its languages.</p>

<p>The longer&#45;term goal is a framework so that external libraries and languages not within the current parrot source tree can also be properly built, tested and installed.</p>

<p>We do not only support GNU make or Win32 nmake but also other platform make variants, so we generate the Makefile at first from a generic template.</p>

<p>Currently for Parrot and its libraries the install actions are defined in the main Makefile. For the languages the install actions are defined in the language&#39;s Makefile. {{ See an implementation of this in #56554&#45;make&#45;install&#45;lang.patch.}}</p>

<p>One general comment: We need to be careful not to install bytecode files in the same directories as executables. The C includes and the PIR includes also need to be separate.</p>

<p><code lang='und' xml:lang='und'>make install</code> currently does not work with an already installed shared libparrot.so on most platforms. {{See a patch for this in RT #39742.}}</p>

<p>The to&#45;be&#45;defined <code lang='und' xml:lang='und'>make install</code> actions for a language named &#34;mylanguage&#34;:</p>

<p>Different platforms will also support different layouts.</p>

<ul>
<li>bin_dir: Copy installables to the destination directory&#39;s <em lang='und' xml:lang='und'>bin</em> directory as <em lang='und' xml:lang='und'>parrot&#45;mylanguage</em>.</li><p class="pad"></p>

<li>script_dir: Optionally copy the main language file <em lang='und' xml:lang='und'>mylanguage.pbc</em> to the destination directory&#39;s <em lang='und' xml:lang='und'>script</em> directory. (<em lang='und' xml:lang='und'>/usr/lib/parrot/bin/</em> ?)</li><p class="pad"></p>

<li>dynext: Copy shared libraries (groups and ops) to the destination directory&#39;s <em lang='und' xml:lang='und'>lib</em> directory under <em lang='und' xml:lang='und'>/parrot/dynext/</em>.</li><p class="pad"></p>

<li>lib_dir Variant 1: Copy the main language library <em lang='und' xml:lang='und'>mylanguage.pbc</em> to the destination directory&#39;s <em lang='und' xml:lang='und'>lib</em> directory under <em lang='und' xml:lang='und'>parrot/library/</em> for HLL interoperability. Also the other pbc&#39;s to a <em lang='und' xml:lang='und'>parrot/library/mylanguage</em> subdirectory. <code lang='und' xml:lang='und'>load_bytecode &#34;mylanguage&#34;</code> should succeed.</li><p class="pad"></p>

<li>lib_dir Variant 1a: Copy the main language library <em lang='und' xml:lang='und'>mylanguage.pbc</em> to the destination directory&#39;s <em lang='und' xml:lang='und'>lib</em> directory under <em lang='und' xml:lang='und'>parrot/library/languages/</em> for HLL interoperability. Also the other pbc&#39;s to a <em lang='und' xml:lang='und'>parrot/library/languages/mylanguage</em> subdirectory. <code lang='und' xml:lang='und'>load_bytecode &#34;languages/mylanguage&#34;</code> should succeed.</li><p class="pad"></p>

<li>lib_dir Variant 3 or 3a: Copy the main language library <em lang='und' xml:lang='und'>mylanguage.pbc</em> to the destination directory&#39;s <em lang='und' xml:lang='und'>lib</em> directory under <em lang='und' xml:lang='und'>parrot/language/library/</em> for HLL interoperability. Also the other pbc&#39;s to a <em lang='und' xml:lang='und'>parrot/language/library/mylanguage</em> subdirectory. <code lang='und' xml:lang='und'>load_language &#34;mylanguage&#34;</code> should succeed. The mylanguage.pbc is resonsible to load the other &#34;mylanguage/mylangspecial&#34; pbc&#39;s.</li><p class="pad"></p>

<p>The subdirs are currently needed for <code lang='und' xml:lang='und'>forth</code> and <code lang='und' xml:lang='und'>WMLScript</code>, the other language pbc&#39;s are <em lang='und' xml:lang='und'>php_*.pbc</em>, <em lang='und' xml:lang='und'>pipplib.pbc</em> and <em lang='und' xml:lang='und'>tcllib.pbc</em>.</p>

<li>lib_dir: Optionally copy include PASM and PIR files to the destination directory&#39;s <em lang='und' xml:lang='und'>lib</em> directory under <em lang='und' xml:lang='und'>parrot/include/</em> <i>(not yet)</i>.</li><p class="pad"></p>

<li>doc_dir: Copy documentation files to a <em lang='und' xml:lang='und'>$doc_dir/languages/mylanguage/</em> subdirectory tree.</li><p class="pad"></p>

<li>man_dir: Generate man(1) pages and copy to destination directory&#39;s <em lang='und' xml:lang='und'>$man_dir/man1/</em> directory. {{ what about man(2) and man(3) pages? info_dir ditto }}</li><p class="pad"></p>

<li>html_dir: Optionally generate HTML and copy to destination directory&#39;s <em lang='und' xml:lang='und'>html</em> directory, possibly under a language specific subdirectory. This should be selectable by a <code lang='und' xml:lang='und'>Configure</code> or <code lang='und' xml:lang='und'>make install</code> option.</li><p class="pad"></p>
</ul>

<h2><a name="make_installable_&#45;C_languages/mylanguage"
>make installable &#45;C languages/mylanguage <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>This creates a bytecode or executable file linked to <em lang='und' xml:lang='und'>install_config.fpmc</em>, and this executable should not access the build directory&#39;s <em lang='und' xml:lang='und'>runtime/parrot</em> paths.</p>

<p>A bytecode file may be optionally merged with <em lang='und' xml:lang='und'>install_config.fpmc</em>, an executable is just linked with <code lang='und' xml:lang='und'>pbc_to_exe &#45;&#45;install</code>.</p>

<h2><a name="make_test&#45;installable_&#45;C_languages/mylanguage"
>make test&#45;installable &#45;C languages/mylanguage <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Goal</b>: Test if the generated installable does not access the build directory paths but does find older libraries, includes and dynext&#39;s in the <em lang='und' xml:lang='und'>$prefix</em> path. The destination directory is not known and may be optional. A simple test from <code lang='und' xml:lang='und'>make test</code> without any features from an external library is enough, because newer libraries are not installed yet at this stage.</p>

<p><b>Implementation</b>: <i>TODO</i></p>

<p><b>Problem</b>: <code lang='und' xml:lang='und'>make test&#45;installable</code> should copy the make install files away, out of the build directory, should temporarily rename the build directory, run a simple test, and remake the build directory back. This will not be possible from a make run from within the build directory. So renaming the <em lang='und' xml:lang='und'>runtime</em> directory during the test might be the best idea.</p>

<p>This is fragile and similar for every language target, so it should be simplified by a make framework, like include <em lang='und' xml:lang='und'>Makefile.common</em>, extending the current automake&#45;like framework or using a Parrot/Install library.</p>

<p>A core <code lang='und' xml:lang='und'>ExtUtils::MakeMaker</code> alike installation library for every external library and HLL, because the languages will be removed from trunk before the Parrot 1.0 release.</p>

<h2><a name="Configuration_bootstrapping"
>Configuration bootstrapping <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>Bootstrapping the configuration hash should not read a config file when the hash is already contained in the PMC or executable. <code lang='und' xml:lang='und'>.include &#34;library/config.pir&#34;</code> and <code lang='und' xml:lang='und'>load_bytecode &#34;config.pbc&#34;</code> should be omitted on installables if possible.</p>

<p>{{NOTE: We need to step back and take a broader view here. Why is <em lang='und' xml:lang='und'>library/config.pir</em> currently included in the installables? It sounds like a hack to work around earlier limitations in the build system. This is an ideal opportunity to eliminate the hack. &#45;allison}}</p>

<h2><a name="Accessing_not&#45;installed_files"
>Accessing not&#45;installed files <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p><b>Makefile and MANIFEST cleanup</b></p>

<p><b>Problem:</b> Various PIR files load source&#45;only PIR, PASM or compiler bytecode files, which are not installed in binary packages. This shows up when trying to run an installable with the build directory removed or renamed.</p>

<pre lang='und' xml:lang='und'> $ parrot&#45;forth.exe xx
 &#34;load_bytecode&#34; couldn&#39;t find file &#39;languages/forth/tokenstream.pbc&#39;
 current instr.: &#39; init&#39; pc 942 (forth.pir:9)
 called from Sub &#39;main&#39; pc 994 (forth.pir:40)

 $ parrot&#45;pheme.exe
 &#34;load_bytecode&#34; couldn&#39;t find file &#39;compilers/tge/TGE/Rule.pbc&#39;
 current instr.: &#39;parrot;TGE;__onload&#39; pc 19 (TGE.pir:94)
 called from Sub &#39;parrot;Pheme::AST::Grammar;__onload&#39; pc 7175
    (languages/pheme/lib/ASTGrammar.pir:5)
 called from Sub &#39;parrot;Pheme::Compiler;main&#39; pc &#45;1 ((unknown file):&#45;1)

 $ parrot&#45;pipp
 Parrot VM: Can&#39;t stat
    /usr/src/perl/parrot/parrot&#45;0.7.0&#45;1/
         build/languages/pipp/src/common/pipplib.pbc, code 2.
 Unable to append PBC to the current directory
 current instr.: &#39;parrot;Pipp;__onload&#39; pc 47 (src/common/pipp.pir:92)
 called from Sub &#39;parrot;Pipp;pipp&#39; pc &#45;1 ((unknown file):&#45;1)</pre>

<p><b>Fix 1</b>: Install all deps and make sure that every HLL is installed at <em lang='und' xml:lang='und'>library/HLLNAME.pbc</em></p>

<p>{{NOTE: This may be a sign that we need to rethink our language build strategy. Trying to glom everything into a single C executable is less than ideal. Especially since it causes problems for language interoperability if every language is running off its own independent executable. &#45;allison}}</p>

<p>The simple Forth and Pipp problem could be solved by merging the missing bytecode files to a single file <em lang='und' xml:lang='und'>forth.pbc</em> and generate from this the installable.</p>

<p>The simple Pheme problem could be solved by installing also all TGE and other compiler bytecode files at the <em lang='und' xml:lang='und'>parrot/library/compilers</em> path. Since TGE is not used elsewhere anymore, Pheme should be fixed to get rid of this. {{NOTE: commonly used libraries should be installed somewhere. &#45;allison}}</p>

<p>The same problem is for every <code lang='und' xml:lang='und'>.include</code>, <code lang='und' xml:lang='und'>loadlib</code> and <code lang='und' xml:lang='und'>load_bytecode</code> statement in installed files where the target is not installed.</p>

<p><b>Fix 2</b>: Module system.</p>

<p>Avoid already loaded pbc files.</p>

<p>Source loading PIR statements like <code lang='und' xml:lang='und'>loadlib</code> and <code lang='und' xml:lang='und'>load_bytecode</code> should</p>

<p>a) cache the file name and skip the file if it has already been loaded (as in perl5)</p>

<p>b) add load*_once sisters as in php &#45; <code lang='und' xml:lang='und'>load_bytecode_once</code> and <code lang='und' xml:lang='und'>loadlib_once</code>. This is not preferred. It might be added later on, but parrot core should not rely on it.</p>

<p>{{NOTE: option (a) strongly preferred. &#45;allison}}</p>

<p><b>Fix 3</b>: pbc_merge fixups</p>

<p>pbc_merge could patch up the bytecode (if possible) to omit loading load_bytecode pbc&#45;files which are being merged, but hacking bytecode during pbc_merge is not desirable.</p>

<h1><a name="IMPLEMENTATION"
>IMPLEMENTATION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>A new language is generated by <em lang='und' xml:lang='und'><a href="../../../tools/dev/mk_language_shell.pl.html">tools/dev/mk_language_shell.pl</a></em></p>

<p>The makefiles are generated from a <em lang='und' xml:lang='und'>config/makefiles/root.in</em> template, which can make use of conditional platform and config logic, the forward slashes are automatically converted to backslashes for MSWin32 and <code lang='und' xml:lang='und'>\n</code> is converted to <code lang='und' xml:lang='und'>\r\n</code> for MSWin32 nmake. See <a href='..%2F..%2F..%2Flib%2FParrot%2FConfigure%2FCompiler.pm.html'>Parrot::Configure::Compiler</a>.</p>

<p>A new <em lang='und' xml:lang='und'>lib/Parrot/Install.pm</em> or <em lang='und' xml:lang='und'>Parrot/Install.pir</em> library should provide the same support as described above and simplify the Makefile and installation maintenance. The entry point could be a Makefile.pl or Makefile.pir then.</p>

<h1><a name="ATTACHMENTS"
>ATTACHMENTS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>None.</p>

<h1><a name="FOOTNOTES"
>FOOTNOTES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>None.</p>

<h1><a name="REFERENCES"
>REFERENCES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>{{ Some of the mentioned single patches against SVN HEAD are at <a href="http://code.google.com/p/cygwin&#45;rurban/source/browse/">http://code.google.com/p/cygwin&#45;rurban/source/browse/</a> trunk/release/parrot/patches</p>

<p>The cygwin070patches branch contains all the mentioned fixes and language lib_dir installation variant 1, so it is really a &#34;make_install&#34; branch. }}</p>

<p>#nnnnn references tickets in <a href="http://rt.perl.org/rt3/Ticket/Display.html?id=nnnnn">http://rt.perl.org/rt3/Ticket/Display.html?id=nnnnn</a></p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
