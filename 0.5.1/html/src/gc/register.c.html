<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Register handling routines</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Register handling routines</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/gc/register.c &#45; Register handling routines</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Parrot has 4 register sets,
one for each of its basic types.
The amount of registers in each set varies depending on the use counts of the respective subroutine and is determined by the PASM/PIR compiler in the register allocation pass (<em lang='und' xml:lang='und'>imcc/reg_alloc.c</em>).</p>

<p>There is one register stack to support the <code lang='und' xml:lang='und'>saveall</code> and <code lang='und' xml:lang='und'>restoreall</code> opcodes.
The former copies all registers to a newly allocated storage and points the register base pointers to this storage.
In <code lang='und' xml:lang='und'>Parrot_pop_regs</code> the register base pointers are restored to the previous values and the allocated register memory is discarded.</p>

<h2><a name="Context_and_register_frame_layout"
>Context and register frame layout <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    | context  || N  |  I   |   P        |  S +
    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    ^          ^     ^                   ^
    |          |     ctx.bp              ctx.bp_ps
    ctx.state  opt
               padding</pre>

<p>Registers are addressed as usual via the register base pointer ctx.bp.</p>

<p>The macro CONTEXT() hides these details</p>

<h2><a name="Context_and_register_frame_allocation"
>Context and register frame allocation <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>There are two allocation strategies: chunked memory and malloced with a free list.</p>

<pre lang='und' xml:lang='und'> CHUNKED_CTX_MEM = 1</pre>

<p><code lang='und' xml:lang='und'>ctx_mem.data</code> is a pointer to an allocated chunk of memory. The pointer <code lang='und' xml:lang='und'>ctx_mem.free</code> holds the next usable location. With (full) continuations the <code lang='und' xml:lang='und'>ctx_mem.free</code> pointer can&#39;t be moved below the <code lang='und' xml:lang='und'>ctx_mem.threshold</code>, which is the highest context pointer of all active continuations. [the code for this is incomplete; it had suffered some bit&#45;rot and was getting in the way of maintaining the other case. &#45;&#45; rgr, 4&#45;Feb&#45;06.]</p>

<p>RT#46177 GC has to lower this threshold when collecting continuations.</p>

<pre lang='und' xml:lang='und'> CHUNKED_CTX_MEM = 0</pre>

<p>Context/register memory is malloced. <code lang='und' xml:lang='und'>ctx_mem.free</code> is used as a free list of reusable items.</p>

<p>Round register allocation size up to the nearest multiple of 8. A granularity of 8 is arbitrary, it could have been some bigger power of 2. A &#34;slot&#34; is an index into the free_list array. Each slot in free_list has a linked list of pointers to already allocated contexts available for (re)use. The slot where an available context is stored corresponds to the size of the context.</p>

<h2><a name="Context_and_Register_Allocation_Functions"
>Context and Register Allocation Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_destroy_context(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>void destroy_context(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Free allocated context memory</dd><p class="pad"></p>

<dt><a name="void_create_initial_context(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>void create_initial_context(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Create initial interpreter context.</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_parrot_gc_context(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void parrot_gc_context(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Cleanup dead context memory. Called by the garbage collector.</dd><p class="pad"></p>

<dt><a name="static_void_clear_regs(PARROT_INTERP,_NOTNULL(parrot_context_t_*ctx))"
><b><code lang='und' xml:lang='und'>static void clear_regs(PARROT_INTERP, NOTNULL(parrot_context_t *ctx))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>static void init_context(PARROT_INTERP, NOTNULL(parrot_context_t *ctx), ARGIN_NULLOK(const parrot_context_t *old))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT PARROT_CANNOT_RETURN_NULL struct Parrot_Context *Parrot_dup_context(PARROT_INTERP, ARGIN(const struct Parrot_Context *old))</b></code></a></dt><p class="pad"></p>

<dd>Duplicate the passed context</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_API PARROT_WARN_UNUSED_RESULT PARROT_CANNOT_RETURN_NULL struct Parrot_Context *Parrot_push_context(PARROT_INTERP, NOTNULL(INTVAL *n_regs_used))</b></code></a></dt><p class="pad"></p>

<dd>Remember old context in <code lang='und' xml:lang='und'>caller_ctx</code>, suitable to use with <code lang='und' xml:lang='und'>Parrot_pop_context</code>.</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_pop_context(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_pop_context(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Free the context created with <code lang='und' xml:lang='und'>Parrot_push_context</code> and restore the previous context.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_CANNOT_RETURN_NULL PARROT_WARN_UNUSED_RESULT struct Parrot_Context *Parrot_alloc_context(PARROT_INTERP, NOTNULL(INTVAL *number_regs_used))</b></code></a></dt><p class="pad"></p>

<dd>Allocate a new context and set the context pointer. Please note that the register usage <code lang='und' xml:lang='und'>n_regs_used</code> is copied. The function returns the new context.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_free_context(PARROT_INTERP, NOTNULL(struct Parrot_Context *ctxp), int re_use)</b></code></a></dt><p class="pad"></p>

<dd>Free the context. If <code lang='und' xml:lang='und'>re_use</code> is true, this function is called by a return continuation invoke, else from the destructor of a continuation.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_set_context_threshold(PARROT_INTERP, NULLOK(struct Parrot_Context *ctxp))</b></code></a></dt><p class="pad"></p>

<dd>Mark the context as possible threshold.</dd><p class="pad"></p>
</dl>

<h2><a name="Register_Stack_Functions"
>Register Stack Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="void_setup_register_stacks(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>void setup_register_stacks(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Set up the register stacks.</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_push_regs(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_push_regs(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Save all registers onto the register stack.</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_pop_regs(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_pop_regs(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>Restore all registers from register stack.</dd><p class="pad"></p>

<dt><a name="void_mark_register_stack(PARROT_INTERP,_NOTNULL(Stack_Chunk_t*_chunk))"
><b><code lang='und' xml:lang='und'>void mark_register_stack(PARROT_INTERP, NOTNULL(Stack_Chunk_t *chunk))</b></code></a></dt><p class="pad"></p>

<dd>Marks the register stack and its registers as live.</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_clear_i(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_clear_i(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_clear_s(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_clear_s(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_clear_p(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_clear_p(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="PARROT_API_void_Parrot_clear_n(PARROT_INTERP)"
><b><code lang='und' xml:lang='und'>PARROT_API void Parrot_clear_n(PARROT_INTERP)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>
</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'>include/parrot/register.h</em> and <em lang='und' xml:lang='und'><a href="../stack_common.c.html">src/stack_common.c</a></em></p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
