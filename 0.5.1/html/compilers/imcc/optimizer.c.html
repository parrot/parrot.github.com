<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>compilers/imcc/optimizer.c</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">compilers/imcc/optimizer.c</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/compilers.html">Compilers</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>compilers/imcc/optimizer.c</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Optimization occurs in three stages: 1) pre_optimizer &#45;&#45; runs before control flow graph (CFG) is built 2) optimizer &#45;&#45; runs after CFG is built,
but before register allocation 3) post_optimizer &#45;&#45; runs after register allocation</p>

<p>pre_optimizer &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>During pre&#45;optimization we perform optimizations which don&#39;t require full knowledge of the control flow graph and the life ranges of each variable.
This phase is handled by two functions: pre_optimize() and cfg_optimize().</p>

<p>pre_optimize() runs before the construction of the CFG begins.
It calls strength_reduce() to perform simple strength reduction,
and if_branch() to rewrite certain if/branch/label constructs (for details,
see if_branch() below).</p>

<p>[pre_optimize() may also be called later,
during the main optimization phase,
but this is not guaranteed.]</p>

<p>cfg_optimize() runs during the construction of the CFG.
It calls branch_branch() to perform jump optimization (i.e.
branches to branch statements or jumps to jumps are converted into single branches/jumps to the final destination),
unused_label() to remove unused labels and dead_code_remove() to remove unreachable code (e.g.
basic blocks which are never entered or instructions after and unconditional branch which are never branched to).</p>

<p>cfg_optimize may be called multiple times during the construction of the CFG depending on whether or not it finds anything to optimize.</p>

<p>RT#46277: subst_constants ...
rewrite e.g.
add_i_ic_ic &#45;&#45; where does this happen?</p>

<p>optimizer &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>runs with CFG and life info</p>

<p>used_once ...
deletes assignments,
when LHS is unused loop_optimization ...
pulls invariants out of loops RT#46279 e.g.
constant_propagation</p>

<p>post_optimizer: currently pcc_optimize in pcc.c &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;</p>

<p>runs after register alloocation</p>

<p>e.g.
eliminate new Px .PerlUndef because Px where different before</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="int_pre_optimize(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>int pre_optimize(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>Handles optimizations occuring before the construction of the CFG.</dd><p class="pad"></p>

<dt><a name="PARROT_WARN_UNUSED_RESULT_int_cfg_optimize(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT int cfg_optimize(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>Handles optimizations occuring during the construction of the CFG.
Returns TRUE if any optimization was performed.
Otherwise,
returns FALSE.</dd><p class="pad"></p>

<dt><a name="int_optimize(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>int optimize(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL const char *get_neg_op(ARGIN(const char *op), NOTNULL(int *n))</b></code></a></dt><p class="pad"></p>

<dd>Get negated form of operator.
If no negated form is known,
return NULL.</dd><p class="pad"></p>

<dt><a name="static_int_if_branch(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int if_branch(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>Convert if/branch/label constructs of the form:</dd><p class="pad"></p>

<pre lang='und' xml:lang='und'>  if cond L1
  branch L2
  L1</pre>

<dd>to the simpler negated form:</dd><p class="pad"></p>

<pre lang='und' xml:lang='und'>  unless cond L2</pre>

<dt><a name="static_int_strength_reduce(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int strength_reduce(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>strength_reduce ... rewrites e.g add Ix, Ix, y =&#62; add Ix, y</dd><p class="pad"></p>

<dd>These are run after constant simplification, so it is guaranteed that one operand is non constant if opsize == 4</dd><p class="pad"></p>

<dt><a name="static_int_constant_propagation(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int constant_propagation(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>Does conservative constant propagation. This code will not propagate constants past labels or saves, even though sometimes it may be safe.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL Instruction *IMCC_subst_constants_umix(PARROT_INTERP, NOTNULL(IMC_Unit *unit), ARGIN(const char *name), NOTNULL(SymReg **r), int n)</b></code></a></dt><p class="pad"></p>

<dd>rewrite e.g. add_n_ic =&#62; add_n_nc</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT static int eval_ins(PARROT_INTERP, ARGIN(const char *op), size_t ops, NOTNULL(SymReg **r))</b></code></a></dt><p class="pad"></p>

<dd>Run one parrot instruction, registers are filled with the according constants. Thus the result is always ok as the function core evaluates the constants.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL Instruction *IMCC_subst_constants(PARROT_INTERP, NOTNULL(IMC_Unit *unit), ARGIN(const char *name), NOTNULL(SymReg **r), int n, NOTNULL(int *ok))</b></code></a></dt><p class="pad"></p>

<dd>rewrite e.g. add_n_nc_nc =&#62; set_n_nc abs_i_ic =&#62; set_i_ic eq_ic_ic_ic =&#62; branch_ic / delete if_ic_ic =&#62; branch_ic / delete</dd><p class="pad"></p>

<dt><a name="static_int_branch_branch(PARROT_INTERP,_NOTNULL(IMC_Unit_*_unit))"
><b><code lang='und' xml:lang='und'>static int branch_branch(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>if I0 goto L1 =&#62; if IO goto L2 ... L1: branch L2</dd><p class="pad"></p>

<dd>Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.</dd><p class="pad"></p>

<dt><a name="PARROT_WARN_UNUSED_RESULT_static_int_branch_reorg(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT static int branch_reorg(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>branch L2 =&#62; ... L1: branch L4 ... L1: branch L3 ... L2: branch L3 ... L5: branch L4 L5:</dd><p class="pad"></p>

<dd>Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT static int branch_cond_loop_swap(PARROT_INTERP, NOTNULL(IMC_Unit *unit), NOTNULL(Instruction *branch), NOTNULL(Instruction *start), NOTNULL(Instruction *cond))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="static_int_branch_cond_loop(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int branch_cond_loop(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>start: =&#62; start: if cond goto end if cond goto end ... branch start start_post1: end: ... unless cond goto start_post562 end:</dd><p class="pad"></p>

<dd>The basic premise is &#34;branch (A) to conditional (B), where B goes to just after A.&#34;</dd><p class="pad"></p>

<dd>Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.</dd><p class="pad"></p>

<dt><a name="PARROT_WARN_UNUSED_RESULT_static_int_unused_label(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT static int unused_label(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>Removes unused labels. A label is unused if ... [RT#46287: finish this].</dd><p class="pad"></p>

<dd>Returns TRUE if any optimizations were performed. Otherwise, returns FALSE.</dd><p class="pad"></p>

<dt><a name="static_int_dead_code_remove(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int dead_code_remove(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="static_int_used_once(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>static int used_once(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>static int _is_ins_save(NOTNULL(IMC_Unit *unit), NOTNULL(Instruction *check_ins), NOTNULL(SymReg *r), int what)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT static int is_ins_save(PARROT_INTERP, NOTNULL(IMC_Unit *unit), NOTNULL(Instruction *ins), NOTNULL(SymReg *r), int what)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="int_max_loop_depth(NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>int max_loop_depth(NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="int_is_invariant(PARROT_INTERP,_NOTNULL(IMC_Unit_*_unit),_NOTNULL(Instruction_*ins))"
><b><code lang='und' xml:lang='und'>int is_invariant(PARROT_INTERP, NOTNULL(IMC_Unit *unit), NOTNULL(Instruction *ins))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL Basic_block *find_outer(NOTNULL(IMC_Unit *unit), NOTNULL(Basic_block *blk))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a
><b><code lang='und' xml:lang='und'>int move_ins_out(PARROT_INTERP, NOTNULL(IMC_Unit *unit), NOTNULL(Instruction **ins), NOTNULL(Basic_block *bb))</b></code></a></dt><p class="pad"></p>

<dd>move the instruction ins before loop in bb</dd><p class="pad"></p>

<dt><a name="int_loop_one(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit),_int_bnr)"
><b><code lang='und' xml:lang='und'>int loop_one(PARROT_INTERP, NOTNULL(IMC_Unit *unit), int bnr)</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>

<dt><a name="int_loop_optimization(PARROT_INTERP,_NOTNULL(IMC_Unit_*unit))"
><b><code lang='und' xml:lang='und'>int loop_optimization(PARROT_INTERP, NOTNULL(IMC_Unit *unit))</b></code></a></dt><p class="pad"></p>

<dd>RT#48260: Not yet documented!!!</dd><p class="pad"></p>
</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
