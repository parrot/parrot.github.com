<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Readme file for pirc/new compiler, a fresh implementation of</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Readme file for pirc/new compiler, a fresh implementation of</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/compilers.html">Compilers</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>README.txt &#45; Readme file for pirc/new compiler,
a fresh implementation of the PIR language using Bison and Flex.</p>

<h1><a name="AUTHOR"
>AUTHOR <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>kjs</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>pirc/new is a fresh implementation of the PIR language.
Maintaining the current default implementation (IMCC) is a bit of a pain,
and it contains a lot of &#34;XXX&#34; and &#34;TODO&#34; and other kludge alerts.
Eventually,
this should be fixed.</p>

<p>PIRC is not finished yet.
A lot of work is needed on the back&#45;end before it can generate Parrot Byte Code files (PBC).</p>

<p>Note that pirc/new refers to a Lex/Yacc based implementation,
while &#39;pirc&#39; refers to the hand&#45;written recursive&#45;descent implementation,
to be found in pirc/src directory.</p>

<p>The current set&#45;up is a three&#45;phase compiler:</p>

<ul>
<li>Heredoc pre&#45;processor</li><p class="pad"></p>

<p>The heredoc pre&#45;processor takes the input,
and converts all heredoc strings into normal strings.
So,
the following:</p>

<pre lang='und' xml:lang='und'> .sub main
    foo(&#60;&#60;&#39;HI&#39;, &#60;&#60;&#39;BYE&#39;)
 hi there!
HI
 bye for now!
BYE

 .end</pre>

<p>is converted into:</p>

<pre lang='und' xml:lang='und'> .sub main
    foo(&#34; hi there!\n&#34;, &#34; bye for now!\n\n&#34;)
 .end</pre>

<p>Currently there is a small issue with the 2nd and later heredoc arguments; they seem to get one newline character too many.</p>

<p>The heredoc pre&#45;processor needs to know about POD comments, because the POD comment may contain a heredoc string, which should not be processed, as it is a comment. For that purpose, all comments (POD and line comments) are stripped in this phase.</p>

<p>The Heredoc pre&#45;processor is located in <b>compilers/pirc/heredoc</b>.</p>

<li>Macro pre&#45;processor</li><p class="pad"></p>

<p>The macro pre&#45;processor takes the output of the heredoc pre&#45;processor, and handles all macro definitions and expansions. The <code lang='und' xml:lang='und'>.include</code> directive is handled here too. The output of the macro pre&#45;processor is (in case of uses of the <code lang='und' xml:lang='und'>.include</code> directive) one long big file with &#34;pure&#34; PIR code.</p>

<p>The macro pre&#45;processor is located in <b>compilers/pirc/macro</b>.</p>

<li>PIR parser</li><p class="pad"></p>

<p>The third pass is done by the PIR parser, which takes the &#34;pure&#34; PIR code from the macro pre&#45;processor. Currently, it&#39;s only a parser, but a future extension could be to generate PASM code from the PIR input. This way, it&#39;s easy to see what ops are actually executed when running the PIR file.</p>

<p>The PIR parser is located in <b>compilers/pirc/new</b>.</p>
</ul>

<p>The new implementation also has some unique features with respect to IMCC:</p>

<ul>
<li>Multiple heredoc arguments</li><p class="pad"></p>

<p>In pirc/new (a new name is yet to be defined) it is allowed to use multiple heredocs as function arguments, like so:</p>

<pre lang='und' xml:lang='und'>   ...
   foo(&#60;&#60;&#39;HI&#39;, &#60;&#60;&#39;BYE&#39;)

   ...
 HI

   ...
 BYE</pre>

<li>Heredoc arguments for macro expansions</li><p class="pad"></p>

<p>As the heredoc pre&#45;processor handles the input before the macro pre&#45;processor, it is now possible to expand macros specifying heredoc arguments, like so:</p>

<pre lang='und' xml:lang='und'> .macro foo(a)
   print .a
 .end

 .sub main
   .foo(&#60;&#60;&#39;HI&#39;)
  Hello world!
HI
 .end</pre>

<li>Reentrant</li><p class="pad"></p>

<p>The generated lexer and parser are fully re&#45;entrant. (It does need to be tested, though).</p>

<li>Comments!</li><p class="pad"></p>

<p>The code is provided with comments, so you can actually understand what it does.</p>

<li>Pre&#45;processing option</li><p class="pad"></p>

<p>Although IMCC does define the option &#39;&#45;E&#39;, it is not really working correctly. pirc has two pre&#45;processing options: 1) running the heredoc parser only, 2) running both the heredoc and macro processors. The output of option 2 is the code that will be given to the PIR compiler.</p>

<li>Grammar cleanup</li><p class="pad"></p>

<p>This is a nice opportunity to clean up the grammar of the PIR language. Hacking on IMCC&#39;s grammar is possible, but not for the faint of heart.</p>
</ul>

<h1><a name="NOTES"
>NOTES <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<h2><a name="Usage"
>Usage <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Currently the different compilers/pre&#45;processors are located in different directories. The different pre&#45;processors are invoked from the main driver in pirc.c. The latter assumes all three processors are compiled, as the following executables:</p>

<pre lang='und' xml:lang='und'> heredoc pre&#45;processor: hdocprep
 macro pre&#45;processor:   macroparser</pre>

<p>Running a file through the whole PIR compiler is then done as follows:</p>

<pre lang='und' xml:lang='und'> $ ./pirc test.pir</pre>

<p>When you want to run the heredoc pre&#45;processor only, do this:</p>

<pre lang='und' xml:lang='und'> $ ./pirc &#45;H test.pir</pre>

<p>When you want to pre&#45;process the file only (heredoc + macro parsing), do this:</p>

<pre lang='und' xml:lang='und'> $ ./pirc &#45;E test.pir</pre>

<h2><a name="Cygwin_processable_lexer_spec."
>Cygwin processable lexer spec. <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>The file <code lang='und' xml:lang='und'>pir.l</code> from which the lexer is generated is <i>not</i> processable by Cygwin&#39;s default version of Flex. In order to make a reentrant lexer, a newer version is needed, which can be downloaded from the link below.</p>

<p><a href='http://sourceforge.net/project/downloading.php?groupname=flex&#38;filename=flex&#45;2.5.33.tar.gz&#38;use_mirror=belnet'><a href="http://sourceforge.net/project/downloading.php?groupname=flex&#38;filename=flex&#45;2.5.33.tar.gz&#38;use_mirror=belnet">http://sourceforge.net/project/downloading.php?groupname=flex&#38;filename=flex&#45;2.5.33.tar.gz&#38;use_mirror=belnet</a></a></p>

<p>Just do:</p>

<pre lang='und' xml:lang='und'> $ ./configure
 $ make</pre>

<p>Then make sure to overwrite the supplied flex binary.</p>

<h1><a name="BUGS"
>BUGS <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Having a look at this implementation would be greatly appreciated, and any resulting feedback even more :&#45;)</p>

<ul>
<li>All, except the first heredoc argument, contains 1 newline character too many. Heredoc parsing is a bit complex, and there might be many other issues.</li><p class="pad"></p>

<li>Memory management needs to be improved.</li><p class="pad"></p>

<li>Braced macro argument handling needs a lot of testing.</li><p class="pad"></p>
</ul>

<h1><a name="REPLACING_IMCC_WITH_PIRC"
>REPLACING IMCC WITH PIRC <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Eventually, either IMCC needs to be fixed rigorously, or, rewritten altogether. PIRC is an attempt to do the latter. The following things need to be considered when replacing IMCC with PIRC:</p>

<ul>
<li>is_op</li><p class="pad"></p>

<p>PIRC needs a function to decide whether an identifier is an instruction. IMCC uses a function is_op that does this. For this to work, libparrot must be linked in, and I&#39;m having trouble doing this.</p>

<li>register allocation</li><p class="pad"></p>

<p>IMCC has a register allocator, but I doubt whether it can be re&#45;used by PIRC. The whole back&#45;end of IMCC probably needs to be redesigned.</p>

<li>bytecode generation</li><p class="pad"></p>

<p>There must be a proper bytecode API for PIRC to use.</p>
</ul>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>See also:</p>

<ul>
<li><code lang='und' xml:lang='und'>languages/PIR</code> for a PGE based implementation.</li><p class="pad"></p>

<li><code lang='und' xml:lang='und'>compilers/pirc</code>, a hand&#45;written, recursive&#45;descent PIR parser.</li><p class="pad"></p>

<li><code lang='und' xml:lang='und'>compilers/imcc</code>, the current <i>standard</i> PIR implementation.</li><p class="pad"></p>

<li><code lang='und' xml:lang='und'>docs/imcc/syntax.pod</code> for a description of PIR syntax.</li><p class="pad"></p>

<li><code lang='und' xml:lang='und'>docs/imcc/</code> for more documentation about the PIR language.</li><p class="pad"></p>
</ul>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
