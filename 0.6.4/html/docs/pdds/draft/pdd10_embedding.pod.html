<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Parrot&#39;s Embedding and Extending Interface</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot&#39;s Embedding and Extending Interface</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../../html/index.html">Contents</a> | <a href="../../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>docs/pdds/embedding.pod &#45; Parrot&#39;s Embedding and Extending Interface</p>

<h1><a name="ABSTRACT"
>ABSTRACT <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>What we believe people will do when embedding and extending Parrot,
why they do it,
and how.</p>

<p>{{ NOTE: some of this will later move into pdds 11 &#38; 12,
but for now just want to get the stub checked in.
}}</p>

<h1><a name="VERSION"
>VERSION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>$Revision$</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Why embed:</p>

<ul>
<li>access to special features/libraries/languages Parrot provides</li><p class="pad"></p>

<li>need an interpreter for a DSL or existing language</li><p class="pad"></p>

<li>want to run Parrot on another platform or environment (dedicated hardware,
in a web server,
et cetera)</li><p class="pad"></p>
</ul>

<p>Why extend:</p>

<ul>
<li>need something NCI doesn&#39;t provide</li><p class="pad"></p>

<li>writing a custom PMC</li><p class="pad"></p>
</ul>

<p>Philosophical rules:</p>

<ul>
<li>only ever use opaque pointers</li><p class="pad"></p>

<li>should be able to communicate through PMCs</li><p class="pad"></p>

<li>minimize conversions to and from C data</li><p class="pad"></p>

<ul>
<li>perhaps macros; Ruby does this fairly well and Perl 5 does this poorly</li><p class="pad"></p>

<li>minimize the number of necessary functions</li><p class="pad"></p>

<li>probably can follow core Parrot code to some extent,
but beware the Perl 5 problem</li><p class="pad"></p>

<ul>
<li>do not expose Parrot internals that may change</li><p class="pad"></p>

<ul>
<li>minimize the number of headers used</li><p class="pad"></p>

<li>minimize the number of Parrot types exposed</li><p class="pad"></p>

<li>follow boundaries similar to those of PIR where possible</li><p class="pad"></p>
</ul>

<li>probably includes vtable methods on PMCs</li><p class="pad"></p>
</ul>
</ul>
</ul>

<p>Gotchas:</p>

<ul>
<li>who handles signals?</li><p class="pad"></p>

<li>who owns file descriptors and other Unix resources?</li><p class="pad"></p>

<li>is there an exception boundary?</li><p class="pad"></p>

<li>namespace issues &#45;&#45; especially key related</li><p class="pad"></p>

<li>probably a continuation/control flow boundary</li><p class="pad"></p>

<li>packfiles and compilation units probably too much information for either</li><p class="pad"></p>

<li>do not let MMD and other implementation details escape</li><p class="pad"></p>

<li>okay to require some PBC/PIR/PASM for handling round&#45;trip data</li><p class="pad"></p>

<li>Parrot should not spew errors to STDERR when embedded</li><p class="pad"></p>

<li>who allocates and deallocates resources passed through the boundary level?</li><p class="pad"></p>

<li>should be access to Parrot&#39;s event loop when embedded</li><p class="pad"></p>

<li>passing var args to Parrot subs likely painful</li><p class="pad"></p>

<ul>
<li>perhaps macros/functions to add parameters to call</li><p class="pad"></p>

<li>build up a call signature somehow?</li><p class="pad"></p>

<li>some abstraction for a call frame?</li><p class="pad"></p>
</ul>

<li>compiling code from a string should return the PMC Sub entry point (:main)</li><p class="pad"></p>

<li>are there still directory path,
loading,
and deployment issues?</li><p class="pad"></p>

<li>how do dynamic oplibs and custom PMCs interact?</li><p class="pad"></p>

<li>what&#39;s the best way to handle character sets and Unicode?</li><p class="pad"></p>
</ul>

<h1><a name="DEFINITIONS"
>DEFINITIONS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Embedding &#45; using libparrot from within another program,
likely with a C/NCI/FFI interface</p>

<p>Extending &#45; writing Parrot extensions,
likely through C or another language</p>

<p>In practice,
there is little difference between the two; mostly in terms of who has control.
The necessary interfaces should stay the same.</p>

<h1><a name="IMPLEMENTATION"
>IMPLEMENTATION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Implementation details.</p>

<p>Simplicity is the main goal; it should be almost trivial to embed Parrot in an existing application.
It must be trivial to do the right thing; the APIs must make it so much easier to work correctly than to make mistakes.
This means,
in particular,
that:</p>

<ul>
<li>it should never be possible to crash or corrupt the interpreter when following the interface as documented</li><p class="pad"></p>

<li>each API call or element should have a single purpose</li><p class="pad"></p>

<li>names must be consistent in the API documentation and the examples</li><p class="pad"></p>

<li>it <i>should</i> be possible to embed Parrot <i>within</i> Parrot through NCI,
as a test both of the sanity of the external interface as well as NCI</li><p class="pad"></p>
</ul>

<h2><a name="Working_with_Interpreters"
>Working with Interpreters <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>It is the external code&#39;s duty to create,
manage,
and destroy interpreters.</p>

<p><code lang='und' xml:lang='und'>Parrot_new( NULL )</code> returns an opaque pointer to a new interpreter:</p>

<pre lang='und' xml:lang='und'>        Parrot_Interp Parrot_new(Parrot_Interp parent);</pre>

<p><code lang='und' xml:lang='und'>parent</code> can be NULL for the <i>first</i> interpreter created. All subsequent calls to this function should pass an existing interpreter.</p>

<p><i>Note: it is not clear what happens if you fail to do so; is there a way to detect this in the interface and give a warning?</i></p>

<p><code lang='und' xml:lang='und'>Parrot_destroy ( interp )</code> destroys an interpreter and frees its resources.</p>

<pre lang='und' xml:lang='und'>        void Parrot_destroy(Parrot_Interp);</pre>

<p><i>Note: It is not clear what happens if this interpreter has active children.</i></p>

<h2><a name="Working_with_Source_Code_and_PBC_Files"
>Working with Source Code and PBC Files <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>Perhaps the most common case for working with code is loading it from an external file. This may often be PBC, but it must also be possible to load code with any registered compiler. This <i>must</i> be a single&#45;stage operation:</p>

<pre lang='und' xml:lang='und'>        Parrot_PMC Parrot_load_bytecode( Parrot_Interp, const char *filepath );

        Parrot_PMC Parrot_load_hll_code( Parrot_Interp, const char *compiler,
                                                        const char *filepath );</pre>

<p>The PMC returned will be the Sub PMC representing the entry point into the code. That is, it will be the PMC representing the <code lang='und' xml:lang='und'>:main</code> subroutine, if one exists, or the first subroutine in the file.</p>

<p>If there is an error &#45;&#45; such that the file does not exist, the compiler is unknown, or there was a compilation or invalid bytecode error &#45;&#45; the PMC should be an Exception PMC instead.</p>

<p><i>Note: I suppose NULL would work as well; it might be more C&#45;like. Continue considering.</i></p>

<p><i>Note also: the current <code lang='und' xml:lang='und'>Parrot_readbc()</code> and <code lang='und' xml:lang='und'>Parrot_loadbc()</code> exposes the details of packfiles to the external API and uses two operations to perform a single logical operation.</i></p>

<p><i>Note: it may be worth reconsidering these names, if <code lang='und' xml:lang='und'>Parrot_load_bytecode()</code> can load PBC, PIR, and PASM files without having a compiler named explicitly.</i></p>

<p>Compiling source code generated or read from the host application is also possible:</p>

<pre lang='und' xml:lang='und'>         Parrot_PMC Parrot_compile_string( Parrot_Interp, const char *compiler,
                                                      const char *code );</pre>

<p>The potential return values are the same as for loading code from disk.</p>

<p><i>Note: this declaration should move from <em lang='und' xml:lang='und'>interpreter.h</em> to <em lang='und' xml:lang='und'>embed.h</em>.</i></p>

<h2><a name="Working_with_PMCs"
>Working with PMCs <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>TBD.</p>

<h2><a name="Calling_Functions"
>Calling Functions <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>TBD.</p>

<h2><a name="Calling_Opcodes"
>Calling Opcodes <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>TBD.</p>

<h1><a name="LANGUAGE_NOTES"
>LANGUAGE NOTES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>It should be possible to register a compiler for an HLL with an interpreter such that it is possible to load source code written in that language or pass source code to an interpreter successfully.</p>

<h1><a name="ATTACHMENTS"
>ATTACHMENTS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>Any associated documents.</p>

<h1><a name="FOOTNOTES"
>FOOTNOTES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>List of footnotes to the text.</p>

<h1><a name="REFERENCES"
>REFERENCES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>List of references.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
