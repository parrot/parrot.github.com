<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>IO Layer for mmaped files</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">IO Layer for mmaped files</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/io/io_mmap.c &#45; IO Layer for mmaped files</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Open mmaps the file.</p>

<h2><a name="mmap_layer_functions"
>mmap layer functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>*/</p>

<p>#include &#34;parrot/parrot.h&#34; #include &#34;io_private.h&#34;</p>

<p>/* HEADERIZER HFILE: none */</p>

<p>/* HEADERIZER BEGIN: static */</p>

<p>static INTVAL PIO_mmap_close( PARROT_INTERP,
NOTNULL(ParrotIOLayer *layer),
NOTNULL(ParrotIO *io) ) __attribute__nonnull__(1) __attribute__nonnull__(2) __attribute__nonnull__(3);</p>

<p>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL static ParrotIO * PIO_mmap_open( PARROT_INTERP,
NOTNULL(ParrotIOLayer *layer),
NOTNULL(const char *path),
INTVAL flags ) __attribute__nonnull__(1) __attribute__nonnull__(2) __attribute__nonnull__(3);</p>

<p>static size_t PIO_mmap_read( PARROT_INTERP,
NOTNULL(ParrotIOLayer *layer),
NOTNULL(ParrotIO *io),
NOTNULL(STRING **buf) ) __attribute__nonnull__(1) __attribute__nonnull__(2) __attribute__nonnull__(3) __attribute__nonnull__(4);</p>

<p>/* HEADERIZER END: static */</p>

<p>static const ParrotIOLayerAPI pio_mmap_layer_api = { PIO_null_init,
PIO_base_new_layer,
PIO_base_delete_layer,
PIO_null_push_layer,
PIO_null_pop_layer,
PIO_mmap_open,
PIO_null_open2,
PIO_null_open3,
PIO_null_open_async,
PIO_null_fdopen,
PIO_mmap_close,
PIO_null_write,
PIO_null_write_async,
PIO_mmap_read,
PIO_null_read_async,
PIO_null_flush,
PIO_null_peek,
PIO_null_seek,
PIO_null_tell,
PIO_null_setbuf,
PIO_null_setlinebuf,
PIO_null_getcount,
PIO_null_fill,
PIO_null_eof,
NULL,
/* no poll */ NULL,
/* no socket */ NULL,
/* no connect */ NULL,
/* no send */ NULL,
/* no recv */ NULL,
/* no bind */ NULL,
/* no listen */ NULL /* no accept */ };</p>

<p>ParrotIOLayer pio_mmap_layer = { NULL,
&#34;mmap&#34;,
0,
&#38;pio_mmap_layer_api,
NULL,
NULL };</p>

<p>PARROT_WARN_UNUSED_RESULT PARROT_CANNOT_RETURN_NULL ParrotIOLayer * PIO_mmap_register_layer(void) { return &#38;pio_mmap_layer; }</p>

<p>/*</p>

<p>FUNCDOC: PIO_mmap_open</p>

<p>The buffer layer&#39;s <code lang='und' xml:lang='und'>Open</code> function.</p>

<p>*/</p>

<p>PARROT_WARN_UNUSED_RESULT PARROT_CAN_RETURN_NULL static ParrotIO * PIO_mmap_open(PARROT_INTERP,
NOTNULL(ParrotIOLayer *layer),
NOTNULL(const char *path),
INTVAL flags) { ParrotIO *io; ParrotIOLayer *l = PIO_DOWNLAYER(layer);</p>

<pre lang='und' xml:lang='und'>    if (!l) {
        l = interp&#45;&#62;piodata&#45;&#62;default_stack;
        if (strcmp(l&#45;&#62;name, &#34;buf&#34;) == 0)
            l = PIO_DOWNLAYER(l);
    }
    io = PIO_open_down(interp, l, path, flags);
    if (!io) {
        /* error creating IO stream */
        return NULL;
    }
#ifdef PARROT_HAS_HEADER_SYSMMAN
    {
        /* XXX assume fstat exists too
        */
        struct stat statbuf;
        int status;
        PIOOFF_T file_size;

        status = fstat(io&#45;&#62;fd, &#38;statbuf); /* XXX We&#39;re ignoring this return value. */
        file_size = statbuf.st_size;
        /* TODO verify flags */
        io&#45;&#62;b.startb = (unsigned char *)mmap(0, file_size, PROT_READ, MAP_SHARED, io&#45;&#62;fd, 0);
        io&#45;&#62;b.size = (size_t)file_size;  /* XXX */
        io&#45;&#62;b.endb = io&#45;&#62;b.startb + io&#45;&#62;b.size;
        io&#45;&#62;b.flags |= PIO_BF_MMAP;
    }
#endif
    return io;
}</pre>

<p>/*</p>

<p>FUNCDOC: PIO_mmap_read</p>

<p>Calls <code lang='und' xml:lang='und'>read()</code> to return up to <code lang='und' xml:lang='und'>len</code> bytes in the memory starting at <code lang='und' xml:lang='und'>buffer</code>.</p>

<p>*/</p>

<p>static size_t PIO_mmap_read(PARROT_INTERP, NOTNULL(ParrotIOLayer *layer), NOTNULL(ParrotIO *io), NOTNULL(STRING **buf)) { STRING *s; UINTVAL len;</p>

<pre lang='und' xml:lang='und'>    if (!(io&#45;&#62;b.flags &#38; PIO_BF_MMAP))
        return PIO_read_down(interp, PIO_DOWNLAYER(layer), io, buf);

    if (*buf == NULL) {
        *buf = new_string_header(interp, 0);
    }
    s = *buf;
    /* TODO create string_free API for reusing string headers */
    if (s&#45;&#62;strstart &#38;&#38; PObj_sysmem_TEST(s))
        mem_sys_free(PObj_bufstart(s));
    PObj_get_FLAGS(s) |= PObj_external_FLAG;
    PObj_bufstart(s) = io&#45;&#62;b.startb + io&#45;&#62;fpos;
    s&#45;&#62;strstart =  (char *) io&#45;&#62;b.startb + io&#45;&#62;fpos;
    len = s&#45;&#62;bufused ? s&#45;&#62;bufused : io&#45;&#62;b.size;
    io&#45;&#62;fpos += len;
    PObj_buflen(s) = s&#45;&#62;strlen = len;
    return len;
}</pre>

<p>/*</p>

<p>FUNCDOC: PIO_mmap_close</p>

<p>Closes <code lang='und' xml:lang='und'>*io</code>&#39;s file descriptor.</p>

<p>*/</p>

<p>static INTVAL PIO_mmap_close(PARROT_INTERP, NOTNULL(ParrotIOLayer *layer), NOTNULL(ParrotIO *io)) { INTVAL ret = &#45;1;</p>

<pre lang='und' xml:lang='und'>    if (io&#45;&#62;fd &#62;= 0)
        ret = PIO_close_down(interp, PIO_DOWNLAYER(layer), io);
    return ret;
}</pre>

<p>/*</p>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'><a href="io_passdown.c.html">src/io/io_passdown.c</a></em>, <em lang='und' xml:lang='und'><a href="io.c.html">src/io/io.c</a></em>, <em lang='und' xml:lang='und'><a href="io_layers.c.html">src/io/io_layers.c</a></em>, <em lang='und' xml:lang='und'><a href="io_private.h.html">src/io/io_private.h</a></em>.</p>

<h1><a name="HISTORY"
>HISTORY <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Initially written by Leo.</p>

<p>*/</p>

<p>/* * Local variables: * c&#45;file&#45;style: &#34;parrot&#34; * End: * vim: expandtab shiftwidth=4: */</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
