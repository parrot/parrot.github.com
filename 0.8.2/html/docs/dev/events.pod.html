<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Design Notes for Events</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Design Notes for Events</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>docs/dev/events.pod &#45; Design Notes for Events</p>

<h1><a name="VERSION"
>VERSION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>This document describes the current state,
which might not be the final implementation.</p>

<h1><a name="Overview"
>Overview <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Parrot has to deal with asynchronous events (from timers,
signals,
async IO,
notifications,
and so on).
This document describes the current implementation.</p>

<h1><a name="Prelims"
>Prelims <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>As there is currently no good test if a threading library is included at link time,
its assumed,
that platforms having <b>PARROT_HAS_HEADER_PTHREAD</b> link against <b>libpthread</b>.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>On construction of the first interpreter (the one with no <b>parent_interpreter</b>) two threads are started: The <b>event_thread</b>,
which manages the static global <b>event_queue</b> and the <b>io_thread</b> which is responsible for signal and IO related events.</p>

<h2><a name="Events"
>Events <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Events can be either timed (they are due after some elapsed time) or untimed.
For the former there is one API call: <b>Parrot_new_timer_event</b>,
used by the <em lang='und' xml:lang='und'><a href="../../src/dynoplibs/myops.ops.html">src/dynoplibs/myops.ops</a></em>:<b>alarm</b> opcode for testing.</p>

<h2><a name="The_event_thread"
>The <b>event_thread</b> <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>The <b>event_thread</b> holds the <b>event_queue</b> mutex first.
When there is no event entry in the <b>event_queue</b>,
the <b>event_thread</b> waits on the event condition until an event arrives.
When there is an event with a timed entry,
a timed wait is performed.
(Waiting on the condition releases the mutex,
so that other threads can insert events into the <b>event_queue</b>.)</p>

<p>When an event arrives (or the timeout was reached) the <b>event_thread</b> pops off all events and places the queue entries into the interpreter&#39;s <b>task_queue</b>.
This also enables event checking in the interpreter&#39;s run&#45;core.</p>

<p>When the popped off entry is a timed event and has a repeat interval,
the entry is duplicated and reinserted with the interval added to the current time.</p>

<h2><a name="Signals"
><b>Signals</b> <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>All signals that should be handled inside Parrot are blocked in all threads and only enabled in the <b>io_thread</b>.
The signal handler functions just sets an atomic flag,
that this signal arrived and returns.
This finally interrupts the select(2) loop in the <b>io_thread</b>.</p>

<h2><a name="The_io_thread"
>The <b>io_thread</b> <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>The <b>io_thread</b> sleeps in a select(2) loop,
which is interrupted when either a signal arrives or when one of the file descriptors has a ready condition.
Additionally the file descriptor set contains the reader end of an internal pipe,
which is used by other threads to communicate with the <b>io_thread</b>.</p>

<p>Signal events like SIGINT are broadcasted to all running interpreters,
which then throw an appropriate exception.</p>

<h2><a name="The_interpreter_event_checking_code"
>The interpreter event checking code <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>We cannot interrupt the interpreter at arbitrary points and run some different code (e.g.
a PASM subroutine handling timer events).
So when an event is put into the interpreter&#39;s <b>task_queue</b> the opcode dispatch table for the interpreter is changed.</p>

<p>Plain function cores get a function table with all entries filled with the <b>check_events__</b> opcode.
This opcode pops off and finally handles the event.
The same scheme works for the CGOTO core,
where the address table is replaced.
The switched core does an explicit check if events are to be handled.</p>

<p>Prederefed and especially the CGP core don&#39;t have an opcode dispatch table that is checked during running the opcodes.
When an event is scheduled,
the event handler replaces backward branches in the opcode image with the <b>check_events__</b> opcode.</p>

<p>The JIT core doesn&#39;t handle events yet.</p>

<p>After all events are popped off and handled,
the opcode dispatch table is restored to its original,
and the <b>check_events__</b> reexecutes the same instruction again,
which is now the real one and thus normal execution flow continues.</p>

<p>This scheme has zero overhead in the absence of scheduled events for all cores except switched and JIT.</p>

<h1><a name="Missing"
>Missing <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="Synchronous_event_API"
>Synchronous event API</a></dt><p class="pad"></p>

<dd>Sync events could be placed directly into the interpreter&#39;s task queue.</dd><p class="pad"></p>

<dt><a name="Async_IO"
>Async IO</a></dt><p class="pad"></p>

<dd>That depends probably on the underlying OS,
i.e.
if it does async IO or we have to do it.</dd><p class="pad"></p>

<dt><a name="Event_priorities"
>Event priorities</a></dt><p class="pad"></p>

<dt><a name="A_lot_more"
>A lot more</a></dt><p class="pad"></p>
</dl>

<h1><a name="Author"
>Author <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Leopold Toetsch <code lang='und' xml:lang='und'>lt@toetsch.at</code></p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
