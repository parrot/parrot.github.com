<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Allocate and deallocate tracked resources</title>
        <link rel="stylesheet" type="text/css"
            href="../../../resources/parrot.css"
            media="all">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    </head>
    <body>
        <div id="wrapper">
            <div id="header">

                <img border=0 src="../../../resources/parrot_logo.png" id="logo" alt="parrot">
            </div> <!-- "header" -->
            <div id="divider"></div>
            <div id="mainbody">
                <div id="breadcrumb">
                    <a href="../../../html/index.html">Contents</a> &raquo; <a href="../../../html/c.html">C</a> &raquo; Allocate and deallocate tracked resources
                </div>

<h1><a name="NAME"
>NAME</a></h1>

<p>src/gc/resources.c &#45; Allocate and deallocate tracked resources</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Functions to manage non&#45;PObj memory,
including strings and buffers.</p>

<h2><a name="Parrot_Memory_Management_Code"
>Parrot Memory Management Code</a></h2>

<dl>
<dt><a name="static_void_alloc_new_block"
><b><code>static void alloc_new_block</b></code></a></dt>
Allocate a new memory block.
We allocate either the requested size or the default size,
whichever is larger.
Add the new block to the given memory pool.
The given <code>char *why</code> text is used for debugging.
<dt><a name="static_void_*_mem_allocate"
><b><code>static void *mem_allocate</b></code></a></dt>
Allocates memory for headers.Alignment problems history:See <a href='http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html'><a href="http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html">http://archive.develooper.com/perl6&#45;internals%40perl.org/msg12310.html</a></a> for details.&#45; return aligned pointer *if needed* &#45; return strings et al at unaligned i.e.
void* boundaries &#45; remember alignment in a buffer header bit use this in compaction code &#45; reduce alignment to a reasonable value i.e.
MALLOC_ALIGNMENT aka 2*sizeof (size_t) or just 8 (TODO make a config hint)Buffer memory layout:
<pre>                    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+
                    |  ref_count   |f |    # GC header
  obj&#45;&#62;bufstart  &#45;&#62; +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+
                    |  data           |
                    v                 v

 * if PObj_is_COWable is set, then we have
   &#45; a ref_count, {inc, dec}remented by 2 always
   &#45; the lo bit &#39;f&#39; means &#39;is being forwarded&#34; &#45; what TAIL_flag was

 * if PObj_align_FLAG is set, obj&#45;&#62;bufstart is aligned like discussed above
 * obj&#45;&#62;buflen is the usable length excluding the optional GC part.</pre>

<dt><a name="static_const_char*_buffer_location"
><b><code>static const char *buffer_location</b></code></a></dt>
Recturns a constant string representing the location of the given PObj <code>b</code> in one of the PMC registers. If the PMC is not located in one of the PMC registers of the current context, returns the string <code>&#34;???&#34;</code>.
<dt><a name="static_void_debug_print_buf"
><b><code>static void debug_print_buf</b></code></a></dt>
Prints a debug statement with information about the given PObj <code>b</code>.</dl>

<h2><a name="Compaction_Code"
>Compaction Code</a></h2>

<dl>
<dt><a name="static_void_compact_pool"
><b><code>static void compact_pool</b></code></a></dt>
Compact the string buffer pool. Does not perform a GC scan, or mark items as being alive in any way.
<dt><a name="void_Parrot_go_collect"
><b><code>void Parrot_go_collect</b></code></a></dt>
Scan the string pools and compact them. This does not perform a GC mark or sweep run, and does not check whether string buffers are still alive. Redirects to <code>compact_pool</code>.
<dt><a name="static_size_t_aligned_size"
><b><code>static size_t aligned_size</b></code></a></dt>
Determines the size of Buffer <code>buffer</code> which has nominal length <code>len</code>. The actual size in RAM of the Buffer might be different because of alignment issues.
<dt><a name="static_char_*_aligned_mem"
><b><code>static char *aligned_mem</b></code></a></dt>
Returns a pointer to the aligned allocated storage for Buffer <code>buffer</code>, which might not be the same as the pointer to <code>buffeR</code> because of memory alignment.
<dt><a name="static_size_t_aligned_string_size"
><b><code>static size_t aligned_string_size</b></code></a></dt>
Determines the size of a string of length <code>len</code> in RAM, accounting for alignment.
<dt><a name="int_Parrot_in_memory_pool"
><b><code>int Parrot_in_memory_pool</b></code></a></dt>
Determines if the given <code>bufstart</code> pointer points to a location inside the memory pool. Returns 1 if the pointer is in the memory pool, 0 otherwise.</dl>

<h2><a name="Parrot_Re/Allocate_Code"
>Parrot Re/Allocate Code</a></h2>

<dl>
<dt><a name="void_Parrot_reallocate"
><b><code>void Parrot_reallocate</b></code></a></dt>
Reallocate the Buffer&#39;s buffer memory to the given size. The allocated buffer will not shrink. If the buffer was allocated with <a href='TODO'>Parrot_allocate_aligned</a> the new buffer will also be aligned. As with all reallocation, the new buffer might have moved and the additional memory is not cleared.
<dt><a name="void_Parrot_reallocate_string"
><b><code>void Parrot_reallocate_string</b></code></a></dt>
Reallocate the STRING&#39;s buffer memory to the given size. The allocated buffer will not shrink. This function sets also <code>str&#45;&#62;strstart</code> to the new buffer location, <code>str&#45;&#62;bufused</code> is <b>not</b> changed.
<dt><a name="void_Parrot_allocate"
><b><code>void Parrot_allocate</b></code></a></dt>
Allocate buffer memory for the given Buffer pointer. The <code>size</code> has to be a multiple of the word size. <code>PObj_buflen</code> will be set to exactly the given <code>size</code>.
<dt><a name="void_Parrot_allocate_aligned"
><b><code>void Parrot_allocate_aligned</b></code></a></dt>
Like above, except the <code>size</code> will be rounded up and the address of the buffer will have the same alignment as a pointer returned by malloc(3) suitable to hold e.g. a <code>FLOATVAL</code> array.
<dt><a name="void_Parrot_allocate_string"
><b><code>void Parrot_allocate_string</b></code></a></dt>
Allocate the STRING&#39;s buffer memory to the given size. The allocated buffer maybe slightly bigger than the given <code>size</code>. This function sets also <code>str&#45;&#62;strstart</code> to the new buffer location, <code>str&#45;&#62;bufused</code> is <b>not</b> changed.
<dt><a name="static_Memory_Pool_*_new_memory_pool"
><b><code>static Memory_Pool *new_memory_pool</b></code></a></dt>
Allocate a new <code>Memory_Pool</code> structures, and set some initial values. return a pointer to the new pool.
<dt><a name="void_Parrot_initialize_memory_pools"
><b><code>void Parrot_initialize_memory_pools</b></code></a></dt>
Initialize the managed memory pools. Parrot maintains two <code>Memory_Pool</code> structures, the general memory pool and the constant string pool. Create and initialize both pool structures, and allocate initial blocks of memory for both.
<dt><a name="void_Parrot_destroy_memory_pools"
><b><code>void Parrot_destroy_memory_pools</b></code></a></dt>
Destroys the memory pool and the constant string pool. Loop through both pools and destroy all memory blocks contained in them. Once all the blocks are freed, free the pools themselves.
<dt><a name="static_void_merge_pools"
><b><code>static void merge_pools</b></code></a></dt>
Merge two memory pools together. Do this by moving all memory blocks from the <code>*source</code> pool into the <code>*dest</code> pool. The <code>source</code> pool is emptied, but is not destroyed here.
<dt><a name="void_Parrot_merge_memory_pools"
><b><code>void Parrot_merge_memory_pools</b></code></a></dt>
Merge the memory pools of two interpreter structures. Merge the general memory pool and the constant string pools from <code>source_interp</code> into <code>dest_interp</code>.</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><em>include/parrot/resources.h</em>, <em><a href="memory.c.html">src/gc/memory.c</a></em>.</p>

<h1><a name="HISTORY"
>HISTORY</a></h1>

<p>Initial version by Dan on 2001.10.2.</p>
            </div> <!-- "mainbody" -->
            <div id="divider"></div>
            <div id="footer">
	        Copyright &copy; 2002-2009, Parrot Foundation.
            </div>
        </div> <!-- "wrapper" -->
    </body>
</html>
