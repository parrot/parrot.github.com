<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Register handling routines</title>
        <link rel="stylesheet" type="text/css"
            href="../../../resources/parrot.css"
            media="all">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    </head>
    <body>
        <div id="wrapper">
            <div id="header">

                <img border=0 src="../../../resources/parrot_logo.png" id="logo" alt="parrot">
            </div> <!-- "header" -->
            <div id="divider"></div>
            <div id="mainbody">
                <div id="breadcrumb">
                    <a href="../../../html/index.html">Contents</a> &raquo; <a href="../../../html/c.html">C</a> &raquo; Register handling routines
                </div>

<h1><a name="NAME"
>NAME</a></h1>

<p>src/gc/register.c &#45; Register handling routines</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Parrot has 4 register sets,
one for each of its basic types.
The number of registers in each set varies depending on the use counts of the subroutine and is determined by the PASM/PIR compiler in the register allocation pass (<em>imcc/reg_alloc.c</em>).</p>

<h2><a name="Context_and_register_frame_layout"
>Context and register frame layout</a></h2>

<pre>    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    | context  || N  |  I   |   P        |  S +
    +&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;++&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;+&#45;&#45;&#45;&#45;+
    ^          ^     ^                   ^
    |          |     ctx.bp              ctx.bp_ps
    ctx.state  opt
               padding</pre>

<p>Registers are addressed as usual via the register base pointer ctx.bp.</p>

<p>The macro CONTEXT() hides these details</p>

<h2><a name="Context_and_register_frame_allocation"
>Context and register frame allocation</a></h2>

<p>There are two allocation strategies: chunked memory and malloced with a free list.</p>

<pre> CHUNKED_CTX_MEM = 1</pre>

<p><code>ctx_mem.data</code> is a pointer to an allocated chunk of memory. The pointer <code>ctx_mem.free</code> holds the next usable location. With (full) continuations the <code>ctx_mem.free</code> pointer can&#39;t be moved below the <code>ctx_mem.threshold</code>, which is the highest context pointer of all active continuations.</p>

<p>[the code for this is incomplete; it had suffered some bit&#45;rot and was getting in the way of maintaining the other case. &#45;&#45; rgr, 4&#45;Feb&#45;06.]</p>

<p>RT #46177 GC has to lower this threshold when collecting continuations.</p>

<pre> CHUNKED_CTX_MEM = 0</pre>

<p>Context/register memory is malloced. <code>ctx_mem.free</code> is used as a free list of reusable items.</p>

<p>Round register allocation size up to the nearest multiple of 8. A granularity of 8 is arbitrary, it could have been some bigger power of 2. A &#34;slot&#34; is an index into the free_list array. Each slot in free_list has a linked list of pointers to already allocated contexts available for (re)use. The slot where an available context is stored corresponds to the size of the context.</p>

<h2><a name="Context_and_Register_Allocation_Functions"
>Context and Register Allocation Functions</a></h2>

<dl>
<dt><a name="void_destroy_context"
><b><code>void destroy_context</b></code></a></dt>
Frees allocated context memory.
<dt><a name="void_create_initial_context"
><b><code>void create_initial_context</b></code></a></dt>
Creates the interpreter&#39;s initial context.
<dt><a name="void_parrot_gc_context"
><b><code>void parrot_gc_context</b></code></a></dt>
Cleans up dead context memory; called by the garbage collector. This only applies in the chunked context memory scheme.
<dt><a name="static_void_clear_regs"
><b><code>static void clear_regs</b></code></a></dt>
Clears all registers in a context. PMC and STRING registers contain PMCNULL and NULL, respectively. Integer and float registers contain negative flag values, for debugging purposes.
<dt><a name="static_void_init_context"
><b><code>static void init_context</b></code></a></dt>
Initializes a freshly allocated or recycled context.
<dt><a name="Parrot_Context_*_Parrot_push_context"
><b><code>Parrot_Context *Parrot_push_context</b></code></a></dt>
Creates and sets the current context to a new context, remembering the old context in <code>caller_ctx</code>. Suitable to use with <code>Parrot_pop_context</code>.
<dt><a name="void_Parrot_pop_context"
><b><code>void Parrot_pop_context</b></code></a></dt>
Frees the context created with <code>Parrot_push_context</code> and restores the previous context (the caller context).
<dt><a name="Parrot_Context_*_Parrot_alloc_context"
><b><code>Parrot_Context *Parrot_alloc_context</b></code></a></dt>
Allocates and returns a new context. Does not set this new context as the current context. Note that the register usage <code>n_regs_used</code> is copied. Use the init flag to indicate whether you want to initialize the new context (setting its default values and clearing its registers).
<dt><a name="Parrot_Context_*_Parrot_set_new_context"
><b><code>Parrot_Context *Parrot_set_new_context</b></code></a></dt>
Allocates and returns a new context as the current context. Note that the register usage <code>n_regs_used</code> is copied.
<dt><a name="void_Parrot_free_context"
><b><code>void Parrot_free_context</b></code></a></dt>
Frees the context if its reference count is zero. If <code>deref</code> is true, then reduce the reference count prior to determining if the context should be freed.
<dt><a name="Parrot_Context_*_Parrot_context_ref_trace"
><b><code>Parrot_Context *Parrot_context_ref_trace</b></code></a></dt>
Helper function to trace references when CTX_LEAK_DEBUG is set.
<dt><a name="void_Parrot_set_context_threshold"
><b><code>void Parrot_set_context_threshold</b></code></a></dt>
Marks the context as possible threshold.</dl>

<h2><a name="Register_Stack_Functions"
>Register Stack Functions</a></h2>

<dl>
<dt><a name="void_Parrot_clear_i"
><b><code>void Parrot_clear_i</b></code></a></dt>
Sets all integer registers in the current context to 0.
<dt><a name="void_Parrot_clear_s"
><b><code>void Parrot_clear_s</b></code></a></dt>
Sets all STRING registers in the current context to NULL.
<dt><a name="void_Parrot_clear_p"
><b><code>void Parrot_clear_p</b></code></a></dt>
Sets all PMC registers in the current context to NULL.
<dt><a name="void_Parrot_clear_n"
><b><code>void Parrot_clear_n</b></code></a></dt>
Sets all number registers in the current context to 0.0.</dl>

<h1><a name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><em>include/parrot/register.h</em> and <em><a href="../stacks.c.html">src/stacks.c</a></em>.</p>
            </div> <!-- "mainbody" -->
            <div id="divider"></div>
            <div id="footer">
	        Copyright &copy; 2002-2009, Parrot Foundation.
            </div>
        </div> <!-- "wrapper" -->
    </body>
</html>
