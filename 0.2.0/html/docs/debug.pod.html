<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Debugging Parrot</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Debugging Parrot</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>docs/debug.pod &#45; Debugging Parrot</p>

<h1><a name="ABSTRACT"
>ABSTRACT <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>This document describes how to debug various parts of Parrot.</p>

<h1><a name="THE_PARROT_BINARY"
>THE PARROT BINARY <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="Using_a_debugger"
>Using a debugger <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Per default the <code lang='und' xml:lang='und'>parrot</code> binary is being built with debugging symbols.
This means that you can run <code lang='und' xml:lang='und'>parrot</code> under an debugger like <code lang='und' xml:lang='und'>gdb</code>.</p>

<p>Debugging support can be explicitly enabled with:</p>

<pre lang='und' xml:lang='und'>    shell&#62; perl Configure.pl &#45;&#45;debugging
    shell&#62; make</pre>

<p>For testing it might be a good idea to make test runs without debug support. So debugging can also be turned off with:</p>

<pre lang='und' xml:lang='und'>  shell&#62; perl Configure.pl &#45;&#45;debugging=0
  shell&#62; make</pre>

<h2><a name="Using_a_memory_checker"
>Using a memory checker <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>You could, and should, also run the tests with a memory checker such as <code lang='und' xml:lang='und'>valgrind</code>. You can enable <code lang='und' xml:lang='und'>valgrind</code>, by running:</p>

<pre lang='und' xml:lang='und'>  shell&#62; make test VALGRIND=&#34;valgrind &#45;&#45;logfile=/tmp/grind&#34;</pre>

<p>Another possibility is to use Electric Fence, or ...</p>

<h2><a name="MEMORY_MANAGEMENT"
>MEMORY MANAGEMENT <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Some of the more frequent and exasperating <code lang='und' xml:lang='und'>parrot</code> bugs are related to memory management in general, and garbage collection in particular.</p>

<p>Infant mortality</p>

<p>See <em lang='und' xml:lang='und'><a href="dev/infant.dev.html">docs/dev/infant.dev</a></em> for details of one frequent problem: infant mortality. Infant mortality is when you create a Parrot object, but the garbage collector runs before you put it into a Parrot register or in something else that is itself within a Parrot register.</p>

<p>To help in resolving these issues, the parrot binary accepts a <code lang='und' xml:lang='und'>&#45;&#45;gc&#45;debug</code> flag. This flag makes garbage collection occur as frequently as possible, which maximizes the probability that any newborn objects will run afoul of the garbage collector.</p>

<p>Within the <code lang='und' xml:lang='und'>&#45;&#45;gc&#45;debug</code> mode, there is another tool to help narrow down the problem. You can edit <em lang='und' xml:lang='und'><a href="../src/dod.c.html">src/dod.c</a></em> and <code lang='und' xml:lang='und'>#define</code> the <code lang='und' xml:lang='und'>GC_VERBOSE</code> flag to 1. After recompiling <code lang='und' xml:lang='und'>parrot</code>, the garbage collector will perform additional checks. After the garbage collector has traced all objects to find which ones are still alive, it will scan through all of the dead objects to see if any of them believe they are alive (which will happen for infants, since they come into existence marked live.) If it finds any, it will print them out. You can then re&#45;run the program with a breakpoint set on the routine that allocated the object (e.g. <code lang='und' xml:lang='und'>get_free_object</code> in <em lang='und' xml:lang='und'><a href="../src/smallobject.c.html">src/smallobject.c</a></em>). You&#39;ll probably want to make the breakpoint conditional on the object having the version number that was reported, because the same memory location will probably hold many different objects over the lifetime of the program.</p>

<h1><a name="PIR_AND_PASM_CODE"
>PIR AND PASM CODE <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>Let&#39;s say you have written (or generated) a huge .pasm or .imc file. It&#39;s not working. You&#39;d like some help in figuring out why.</p>

<h2><a name="pdb"
>pdb <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>One possible tool is <code lang='und' xml:lang='und'>pdb</code>, the Parrot Debugger. See <em lang='und' xml:lang='und'><a href="debugger.pod.html">docs/debugger.pod</a></em> for details on it.</p>

<h2><a name="stabs"
>stabs <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>If you are running on a jit&#45;capable machine, you can also try using <code lang='und' xml:lang='und'>gdb</code> by having the JIT compiler generate <code lang='und' xml:lang='und'>stabs</code> metadata and then stepping through the code with <code lang='und' xml:lang='und'>gdb</code> as if it were any other language.</p>

<p>To use this, you&#39;ll want to use <code lang='und' xml:lang='und'>parrot</code> to generate your bytecode (.pbc file). It is not strictly necessary, but you&#39;ll get more information into the bytecode this way.</p>

<p>Let&#39;s say your file is named <code lang='und' xml:lang='und'>test.pasm</code>. (Note: these instructions will also work if you use <code lang='und' xml:lang='und'>test.imc</code> everywhere <code lang='und' xml:lang='und'>test.pasm</code> occurs.)</p>

<p>Step 1: Generate the .pbc file with extra debugging information.</p>

<pre lang='und' xml:lang='und'>  shell&#62; parrot &#45;d &#45;o test.pbc test.pasm</pre>

<p>Step 2: Start up <code lang='und' xml:lang='und'>parrot</code> under <code lang='und' xml:lang='und'>gdb</code></p>

<pre lang='und' xml:lang='und'>  % gdb parrot</pre>

<p>or</p>

<pre lang='und' xml:lang='und'>  % emacs &#38;
  (in emacs) M&#45;x gdb
  (in emacs) type &#34;parrot&#34; so it says &#34;gdb parrot&#34;</pre>

<p>Step 3: Set a breakpoint on runops_jit</p>

<pre lang='und' xml:lang='und'>  gdb&#62; b runops_jit</pre>

<p>Step 4: Run your program under <code lang='und' xml:lang='und'>gdb</code> with JIT and debugging on</p>

<pre lang='und' xml:lang='und'>  gdb&#62; run &#45;j &#45;d test.pbc</pre>

<p>Step 5: <code lang='und' xml:lang='und'>gdb</code> will stop at the beginning of runops_jit. Step through the lines until just before the JITted code is executed (the line will be something like <code lang='und' xml:lang='und'>(jit_code)(interpreter,pc)</code>.</p>

<pre lang='und' xml:lang='und'>  gdb&#62; n
  gdb&#62; n
  .
  .
  .</pre>

<p>Step 6: load in the debugging information from the symbol file that the jit just generated.</p>

<pre lang='und' xml:lang='und'>  gdb&#62; add&#45;symbol&#45;file test.o 0</pre>

<p>Step 7: Step into the JITted code</p>

<pre lang='und' xml:lang='und'>  gdb&#62; s</pre>

<p>At this point, you can step through the instructions, or print out the various Parrot registers. <code lang='und' xml:lang='und'>gdb</code> will know about I0&#45;I31, N0&#45;N31, S0&#45;S31, and P0&#45;P31.</p>

<p>WARNING: Stepping too far</p>

<p>One thing to watch out for is that <code lang='und' xml:lang='und'>gdb</code> gets confused when attempting to step over certain instructions. The only ones that I have noticed having problems is keyed operations. With my version of <code lang='und' xml:lang='und'>gdb</code>, if I do &#39;n&#39; to step over the instruction, <code lang='und' xml:lang='und'>gdb</code> will start running and only stop when the entire parrot program has finished. To work around this, do &#39;si&#39; twice just before executing any keyed op. For some reason, <code lang='und' xml:lang='und'>gdb</code> can then figure out when it&#39;s supposed to stop next. If you know of a better technique, please let the mailing list know (<code lang='und' xml:lang='und'>perl6&#45;internals@perl.org</code>).</p>

<h1><a name="PIR_CODE_GENERATION"
>PIR CODE GENERATION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>The <code lang='und' xml:lang='und'>parrot</code> binary has a bunch of debugging flags for spewing out information about various aspects of its processing. See <em lang='und' xml:lang='und'><a href="../imcc/docs/running.pod.html">imcc/docs/running.pod</a></em> for a list of flags. Or have a look at the information provided by:</p>

<pre lang='und' xml:lang='und'>  shell&#62; parrot &#45;&#45;help</pre>

<p>or</p>

<pre lang='und' xml:lang='und'>  shell&#62; parrot &#45;&#45;help&#45;debug</pre>

<h1><a name="HISTORY"
>HISTORY <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="Version_1.1"
>Version 1.1</a></dt><p class="pad"></p>

<dd>Updates to remove references to <code lang='und' xml:lang='und'>imcc</code> by &#60;Bernhard.Schmalhofer@biomax.de&#62;</dd><p class="pad"></p>

<dt><a name="Version_1.0"
>Version 1.0</a></dt><p class="pad"></p>

<dd>First version by Steve Fink &#60;steve@fink.com&#62;</dd><p class="pad"></p>
</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
