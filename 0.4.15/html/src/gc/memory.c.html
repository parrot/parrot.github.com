<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Memory allocation</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Memory allocation</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/memory.c &#45; Memory allocation</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>The memory (mem) API handles memory allocation,</p>

<p>Basically just a wrapper <code lang='und' xml:lang='und'>around malloc/calloc/realloc/free()</code> with an setup function to initialize the memory pools.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>*/</p>

<p>#include &#34;parrot/parrot.h&#34; #include &#34;parrot/memory.h&#34;</p>

<p>/* HEADERIZER HFILE: include/parrot/memory.h */</p>

<p>/*</p>

<p>FUNCDOC: mem_sys_allocate</p>

<p>Uses <code lang='und' xml:lang='und'>malloc</code> to allocate system memory.</p>

<p>*/</p>

<p>PARROT_API PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem_sys_allocate(size_t size) { void * const ptr = malloc((size_t)size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Allocated %i at %p\n&#34;,
size,
ptr); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;); return ptr; }</p>

<p>PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem__internal_allocate(size_t size,
NOTNULL(const char *file),
int line) { void * const ptr = malloc((size_t)size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Internal malloc %i at %p (%s/%d)\n&#34;,
size,
ptr,
file,
line); #else UNUSED(file); UNUSED(line); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;); return ptr; }</p>

<p>/*</p>

<p>FUNCDOC: mem_sys_allocate_zeroed</p>

<p>Uses <code lang='und' xml:lang='und'>calloc</code> to allocate system memory.</p>

<p>*/</p>

<p>PARROT_API PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem_sys_allocate_zeroed(size_t size) { void * const ptr = calloc(1,
(size_t)size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Allocated %i at %p\n&#34;,
size,
ptr); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;); return ptr; }</p>

<p>PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem__internal_allocate_zeroed(size_t size,
NOTNULL(const char *file),
int line) { void * const ptr = calloc(1,
(size_t)size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Internal malloc %i at %p (%s/%d)\n&#34;,
size,
ptr,
file,
line); #else UNUSED(file); UNUSED(line); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;); return ptr; }</p>

<p>/*</p>

<p>FUNCDOC: mem_sys_realloc</p>

<p>Resize a chunk of system memory.</p>

<p>*/</p>

<p>PARROT_API PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem__sys_realloc(NULLOK(void *from),
size_t size) { void *ptr; #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Freed %p (realloc &#45;&#45; %i bytes)\n&#34;,
from,
size); #endif ptr = realloc(from,
size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Allocated %i at %p\n&#34;,
size,
ptr); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;); return ptr; }</p>

<p>/*</p>

<p>FUNCDOC: mem_sys_realloc_zeroed</p>

<p>Resize a chunk of system memory.
Fill the newly allocated space with zeroes.</p>

<p>*/</p>

<p>PARROT_API PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem__sys_realloc_zeroed(NULLOK(void *from),
size_t size,
size_t old_size) { void *ptr; #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Freed %p (realloc &#45;&#45; %i bytes)\n&#34;,
from,
size); #endif ptr = realloc(from,
size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr,
&#34;Allocated %i at %p\n&#34;,
size,
ptr); #endif if (!ptr) PANIC(NULL,
&#34;Out of mem&#34;);</p>

<pre lang='und' xml:lang='und'>    if (size &#62; old_size)
        memset((char*)ptr + old_size, 0, size &#45; old_size);

    return ptr;
}</pre>

<p>PARROT_MALLOC PARROT_CANNOT_RETURN_NULL void * mem__internal_realloc(NOTNULL(void *from), size_t size, NOTNULL(const char *file), int line) { void * const ptr = realloc(from, size); #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr, &#34;internal free of %p (realloc &#45;&#45; %i bytes) (%s/%d)\n&#34;, from, size, file, line); fprintf(stderr, &#34;Internal malloc %i at %p (%s/%d)\n&#34;, size, ptr, file, line); #else UNUSED(file); UNUSED(line); #endif if (!ptr) PANIC(NULL, &#34;Out of mem&#34;); return ptr; }</p>

<p>/*</p>

<p>FUNCDOC: mem_sys_free</p>

<p>Free a chunk of memory back to the system.</p>

<p>*/</p>

<p>PARROT_API void mem_sys_free(NULLOK(void *from)) { #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr, &#34;Freed %p\n&#34;, from); #endif if (from) free(from); }</p>

<p>void mem__internal_free(NULLOK(void *from), NOTNULL(const char *file), int line) { #ifdef DETAIL_MEMORY_DEBUG fprintf(stderr, &#34;Internal free of %p (%s/%d)\n&#34;, from, file, line); #else UNUSED(file); UNUSED(line); #endif free(from); }</p>

<p>/*</p>

<p>FUNCDOC: mem_setup_allocator</p>

<p>Initializes the allocator.</p>

<p>*/</p>

<p>void mem_setup_allocator(PARROT_INTERP) { interp&#45;&#62;arena_base = mem_allocate_zeroed_typed(Arenas); interp&#45;&#62;arena_base&#45;&#62;sized_header_pools = NULL;</p>

<p>#if PARROT_GC_MS Parrot_gc_ms_init(interp); #endif #if PARROT_GC_IMS Parrot_gc_ims_init(interp); #endif #if PARROT_GC_GMS Parrot_gc_gms_init(interp); #endif</p>

<pre lang='und' xml:lang='und'>    Parrot_initialize_memory_pools(interp);
    Parrot_initialize_header_pools(interp);
}</pre>

<p>/* * Local variables: * c&#45;file&#45;style: &#34;parrot&#34; * End: * vim: expandtab shiftwidth=4: */</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
