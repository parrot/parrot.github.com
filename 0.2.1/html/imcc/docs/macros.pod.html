<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Macros</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Macros</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/imcc.html">IMCC</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>IMCC &#45; Macros</p>

<h1><a name="OVERVIEW"
>OVERVIEW <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>This document describes the macro layer of IMCC.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>The macro support for IMCC was designed to be a drop in replacement for the original <em lang='und' xml:lang='und'>assemble.pl</em> macro layer.</p>

<p>One exception is the <b>.constant</b> macro,
which is only usable in PASM mode.
For PIR mode,
please use the <b>.const</b> directive instead.
Also note that you have to use <b>.sym</b> inside macros to define symbols,
as <b>.local</b> is used for local labels.</p>

<p>The addition of the &#39;.&#39; preface will hopefully make things easier to parse,
inasmuch as everything within an assembler file that needs to be expanded or processed by the macro engine will have a period (&#39;.&#39;) prepended to it.</p>

<p>The macro layer implements constants,
macros,
local labels and including of files.</p>

<p>A macro definition starts with a line consisting of &#34;.macro&#34;,
the name for the newly created macro and an optional list of parameters.
Thereafter follows the definition of the macro which can span several lines.
The definition is ended by &#34;.endm&#34;.
In the macro definition the formal parameters,
preceded by a &#39;.&#39;,
are valid macros.</p>

<pre lang='und' xml:lang='und'>  .macro swap (A,B,TEMP) # . marks the directive
    set .TEMP,.A         # . marks the special variable.
    set .A,.B
    set .B,.TEMP
  .endm                  # And . marks the end of the macro.</pre>

<p>Macros support labels, defined using <b>.local</b>, that are local to a given macro expansion. The syntax looks something like this:</p>

<pre lang='und' xml:lang='und'>  .macro SpinForever (Count)
    .local $LOOP: dec .COUNT    # &#34;.local $LOOP&#34; defines a local label.
                  branch .$LOOP # Jump to said label.
  .endm</pre>

<p>Include this macro as many times as you like; the branch statement should do the right thing every time. To use a global label, do just as you usually do.</p>

<p>Constants are new and the syntax looks like:</p>

<pre lang='und' xml:lang='und'>  .constant Hash 6 # Again, . marks the directive

  new P0, .Hash # . marks the special variable for expansion.</pre>

<p>Several constants are predefined, namely the PMC classes, e.g.</p>

<pre lang='und' xml:lang='und'>  .constant Array 0
  .constant PerlUndef 1
  ...</pre>

<p>The &#34;.include&#34; statement is followed by a string literal. The file of this name is include literally in the assembly.</p>

<p>The include file is searched for in the current directory and in <em lang='und' xml:lang='und'>runtime/parrot/include</em>, in that order. The first file of that name to be found is included.</p>

<h2><a name="Expansion"
>Expansion <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Constant definitions have the form</p>

<pre lang='und' xml:lang='und'>  .constant name {register}
  .constant name {signed_integer}
  .constant name {signed_float}
  .constant name {&#34;string constant&#34;}
  .constant name {&#39;string constant&#39;}</pre>

<p>They don&#39;t generate any code, but create a new macro directive .name</p>

<p>Given the line:</p>

<pre lang='und' xml:lang='und'>  &#39;.constant HelloWorld &#34;Hello, World!&#34;&#39;</pre>

<p>one can expand HelloWorld via:</p>

<pre lang='und' xml:lang='und'>  &#39;print .HelloWorld&#39; # Note the period to indicate a thing to expand.</pre>

<p>Some predefined constants exist for your convenience, namely:</p>

<pre lang='und' xml:lang='und'>  .Array
  .Hash
  .PerlArray</pre>

<p>and the other PMC types.</p>

<p>The contents of external files can be included by use of the <code lang='und' xml:lang='und'>.include</code> macro:</p>

<pre lang='und' xml:lang='und'>  .include &#34;{filename}&#34;</pre>

<p>The contents of the included file are inserted at the point where the <code lang='und' xml:lang='und'>.include</code> macro occurs. This means that code like this:</p>

<pre lang='und' xml:lang='und'>  print &#34;Hello &#34;
  .include &#34;foo.pasm&#34;
  end</pre>

<p>where <em lang='und' xml:lang='und'>foo.pasm</em> contains:</p>

<pre lang='und' xml:lang='und'>  print &#34;World \n&#34;</pre>

<p>becomes:</p>

<pre lang='und' xml:lang='und'>  print &#34;Hello &#34;
  print &#34;World \n&#34;
  end</pre>

<p>Attempting to include a non&#45;existent file is a non&#45;fatal error.</p>

<pre lang='und' xml:lang='und'>  .macro name ({arguments?})
  ...
  .endm</pre>

<p>Optional arguments are simply identifiers separated by commas. These arguments are matched to instances inside the macro named &#39;.foo&#39;. A simple example follows:</p>

<pre lang='und' xml:lang='und'>  .macro inc3 (A)
    inc .A # Mark the argument to expand with a &#39;.&#39;.
    inc .A
    inc .A
  .endm

  .inc3(I0) # Expands to the obvious (&#39;inc I0\n&#39;) x 3</pre>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
