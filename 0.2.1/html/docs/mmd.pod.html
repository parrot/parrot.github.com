<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Multimethod dispatch for binary opcode functions</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Multimethod dispatch for binary opcode functions</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>docs/mmd.pod &#45; Multimethod dispatch for binary opcode functions</p>

<h1><a name="SYNOPSIS"
>SYNOPSIS <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>This system is set up to handle type&#45;based dispatching for binary (i.e.
two&#45;arg) functions.
This includes,
though isn&#39;t necessarily limited to,
binary operators such as addition or subtraction.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>The MMD system is straightforward,
and currently must be explicitly invoked,
for example by a vtable function.
(We may reserve the right to use MMD in all circumstances,
but currently do not)</p>

<h2><a name="API"
>API <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>For the purposes of the API,
each MMD&#45;able function is assigned a unique number which is used to find the correct function table.
This is the <code lang='und' xml:lang='und'>func_num</code> parameter in the following functions.
While Parrot isn&#39;t restricted to a predefined set of functions,
it <i>does</i> set things up so that all the binary vtable functions have a MMD table preinstalled for them,
with default behaviour.</p>

<dl>
<dt><a name="mmd_add_by_class(interp,_func_num,_left_class,_right_class,_funcptr)"
>mmd_add_by_class(interp,
func_num,
left_class,
right_class,
funcptr)</a></dt><p class="pad"></p>

<dd>Adds a new MMD function <code lang='und' xml:lang='und'>funcptr</code> to the <code lang='und' xml:lang='und'>func_num</code> function table that will be invoked when the left parameter is of class <code lang='und' xml:lang='und'>left_class</code> and the right parameter is of class <code lang='und' xml:lang='und'>right_class</code>.
Both classes are <code lang='und' xml:lang='und'>STRING *</code>s that hold the PMC class names for the left and right sides.
If either class isn&#39;t yet loaded,
Parrot will cache the information such that the function will be installed if at some point in the future both classes are available.</dd><p class="pad"></p>

<dd>Currently this is done by just assigning class numbers to the classes,
which the classes will pick up and use if they&#39;re later loaded,
but we may later put the functions into a deferred table that we scan when PMC classes are loaded.
Either way,
the function will be guaranteed to be installed when it&#39;s needed.</dd><p class="pad"></p>

<dd>The function table must exist,
but if it is too small,
it will automatically be expanded.</dd><p class="pad"></p>

<dt><a name="mmd_register(interp,_func_num,_left_type,_right_type,_funcptr)"
>mmd_register(interp,
func_num,
left_type,
right_type,
funcptr)</a></dt><p class="pad"></p>

<dd>Register a function <code lang='und' xml:lang='und'>funcptr</code> for MMD function table <code lang='und' xml:lang='und'>func_num</code> for classes <code lang='und' xml:lang='und'>left_type</code> and <code lang='und' xml:lang='und'>right_type</code>.
The left and right types are <code lang='und' xml:lang='und'>INTVAL</code>s that represent the class ID numbers.</dd><p class="pad"></p>

<dd>The function table must exist,
but if it is too small,
it will automatically be expanded.</dd><p class="pad"></p>

<dd>Currently the MMD system doesn&#39;t handle inheritance and best match searching,
as it assumes that all PMC types have no parent type.
This can be considered a bug,
and will be resolved at some point in the future.</dd><p class="pad"></p>

<dt><a name="mmd_dispatch_pmc(interp,_left,_right,_dest,_func_num)"
>mmd_dispatch_pmc(interp,
left,
right,
dest,
func_num)</a></dt><p class="pad"></p>

<dd>Dispatch to a multimethod that &#34;returns&#34; a PMC.
<code lang='und' xml:lang='und'>left</code>,
<code lang='und' xml:lang='und'>right</code>,
and <code lang='und' xml:lang='und'>dest</code> are all PMC pointers,
while <code lang='und' xml:lang='und'>func_num</code> is the MMD table that should be used to do the dispatching.</dd><p class="pad"></p>

<dd>The MMD system will figure out which function should be called based on the types of <code lang='und' xml:lang='und'>left</code> and <code lang='und' xml:lang='und'>right</code> and call it,
passing in <code lang='und' xml:lang='und'>left</code>,
<code lang='und' xml:lang='und'>right</code>,
and <code lang='und' xml:lang='und'>dest</code> like any other binary vtable function.</dd><p class="pad"></p>

<dd>This function has a void return type,
like all the &#34;take two PMCs,
return a PMC&#34; vtable functions do.</dd><p class="pad"></p>

<dt><a name="STRING_*mmd_dispatch_string(interp,_left,_right,_func_num)"
>STRING *mmd_dispatch_string(interp,
left,
right,
func_num)</a></dt><p class="pad"></p>

<dd>Dispatch to a multimethod that returns a string.
<code lang='und' xml:lang='und'>left</code> and <code lang='und' xml:lang='und'>right</code> are PMC pointers,
while <code lang='und' xml:lang='und'>func_num</code> is the MMD table that should be used to do the dispatching.
The function is responsible for creating the returned string.</dd><p class="pad"></p>

<dt><a name="INTVAL_mmd_dispatch_intval(interp,_left,_right,_func_num)"
>INTVAL mmd_dispatch_intval(interp,
left,
right,
func_num)</a></dt><p class="pad"></p>

<dd>Like <code lang='und' xml:lang='und'>mmd_dispatch_string</code>,
only it returns an INTVAL.</dd><p class="pad"></p>

<dt><a name="FLOATVAL_mmd_dispatch_floatval(interp,_left,_right,_func_num)"
>FLOATVAL mmd_dispatch_floatval(interp,
left,
right,
func_num)</a></dt><p class="pad"></p>

<dd>Like <code lang='und' xml:lang='und'>mmd_dispatch_string</code>,
only it returns a FLOATVAL.</dd><p class="pad"></p>

<dt><a name="mmd_add_function(interp,_func_num,_default_func)"
>mmd_add_function(interp,
func_num,
default_func)</a></dt><p class="pad"></p>

<dd>Add a new function table to the list of functions the MMD system knows of.
<code lang='und' xml:lang='und'>func_num</code> is the number of the new function,
while <code lang='und' xml:lang='und'>default_func</code> is the function to be called when the system doesn&#39;t know which function it should call.
(Because,
for example,
there hasn&#39;t been a function installed that matches the left and right types for a call)</dd><p class="pad"></p>
</dl>

<h2><a name="Constants"
>Constants <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>The following constants are defined to identify function tables:</p>

<dl>
<dt><a name="MMD_ADD"
>MMD_ADD</a></dt><p class="pad"></p>

<dd>Addition</dd><p class="pad"></p>

<dt><a name="MMD_SUBTRACT"
>MMD_SUBTRACT</a></dt><p class="pad"></p>

<dd>Subtraction</dd><p class="pad"></p>

<dt><a name="MMD_MULTIPLY"
>MMD_MULTIPLY</a></dt><p class="pad"></p>

<dd>Multiplication</dd><p class="pad"></p>

<dt><a name="MMD_DIVIDE"
>MMD_DIVIDE</a></dt><p class="pad"></p>

<dd>Division</dd><p class="pad"></p>

<dt><a name="MMD_MOD"
>MMD_MOD</a></dt><p class="pad"></p>

<dd>Accurate modulus</dd><p class="pad"></p>

<dt><a name="MMD_CMOD"
>MMD_CMOD</a></dt><p class="pad"></p>

<dd>C&#45;style modulus</dd><p class="pad"></p>

<dt><a name="MMD_BAND"
>MMD_BAND</a></dt><p class="pad"></p>

<dd>Binary and</dd><p class="pad"></p>

<dt><a name="MMD_BOR"
>MMD_BOR</a></dt><p class="pad"></p>

<dd>Binary or</dd><p class="pad"></p>

<dt><a name="MMD_BXOR"
>MMD_BXOR</a></dt><p class="pad"></p>

<dd>Binary xor</dd><p class="pad"></p>

<dt><a name="MMD_BSL"
>MMD_BSL</a></dt><p class="pad"></p>

<dd>Bitshift left</dd><p class="pad"></p>

<dt><a name="MMD_BSR"
>MMD_BSR</a></dt><p class="pad"></p>

<dd>Bitshift right</dd><p class="pad"></p>

<dt><a name="MMD_CONCAT"
>MMD_CONCAT</a></dt><p class="pad"></p>

<dd>String concatenation</dd><p class="pad"></p>

<dt><a name="MMD_LAND"
>MMD_LAND</a></dt><p class="pad"></p>

<dd>Short&#45;circuiting logical and</dd><p class="pad"></p>

<dt><a name="MMD_LOR"
>MMD_LOR</a></dt><p class="pad"></p>

<dd>Short&#45;circuiting logical or</dd><p class="pad"></p>

<dt><a name="MMD_LXOR"
>MMD_LXOR</a></dt><p class="pad"></p>

<dd>Logical xor (not short&#45;circuiting)</dd><p class="pad"></p>

<dt><a name="MMD_REPEAT"
>MMD_REPEAT</a></dt><p class="pad"></p>

<dd>String repetition</dd><p class="pad"></p>

<dt><a name="MMD_NUMEQ"
>MMD_NUMEQ</a></dt><p class="pad"></p>

<dd>Numeric equality</dd><p class="pad"></p>

<dt><a name="MMD_STREQ"
>MMD_STREQ</a></dt><p class="pad"></p>

<dd>String equality</dd><p class="pad"></p>

<dt><a name="MMD_NUMCMP"
>MMD_NUMCMP</a></dt><p class="pad"></p>

<dd>Numeric comparison</dd><p class="pad"></p>

<dt><a name="MMD_STRCMP"
>MMD_STRCMP</a></dt><p class="pad"></p>

<dd>String comparison</dd><p class="pad"></p>

<dt><a name="MMD_SOR"
>MMD_SOR</a></dt><p class="pad"></p>

<dd>Bitwise or of the string value</dd><p class="pad"></p>

<dt><a name="MMD_SAND"
>MMD_SAND</a></dt><p class="pad"></p>

<dd>Bitwise and of the string value</dd><p class="pad"></p>

<dt><a name="MMD_SXOR"
>MMD_SXOR</a></dt><p class="pad"></p>

<dd>Bitwise xor of the string value</dd><p class="pad"></p>
</dl>

<h2><a name="Defaults"
>Defaults <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>By default,
functions are installed for all the functions that have constants associated with them.
They are all functions suitable for calling with <code lang='und' xml:lang='und'>mmd_dispatch_pmc</code>.</p>

<p>The math functions (add,
subtract,
multiply,
and divide) all work on the float values of the left and right sides.</p>

<p>The cmod function does a plan C&#45;style mod (the C <code lang='und' xml:lang='und'>%</code> operator) on the integer value of the left and right sides.</p>

<p>The mod function does an fmod on the float values of the two sides.</p>

<p>The bitwise functions (and,
or,
xor,
left shift,
right shift) work on the integer values of the two sides.</p>

<p>The concat function concatenates the string values of the left and right sides.</p>

<p>The logical functions (and,
or,
xor) use the boolean values of the left and right sides to see whether they should set_pmc the destination to the left or right sides.
The <code lang='und' xml:lang='und'>and</code> and <code lang='und' xml:lang='und'>or</code> functions short&#45;circuit,
<code lang='und' xml:lang='und'>xor</code> does not.</p>

<p>The repeat function gets the string value of the left side and the integer value of the right.</p>

<p>The numeric equal and numeric comparison functions work on the float values of both sides.</p>

<p>The string equal and comparison functions work on the string values of both sides.</p>

<p>The string bitwise ops (and,
or,
xor) take the string values of both sides and do bitwise operations on the resulting bitstring.</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
