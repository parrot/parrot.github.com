<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Untitled</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Untitled</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../../html/index.html">Contents</a> | <a href="../../../../html/languages.html">Language Implementations</a> | <a href="../../../../html/tcl.html">TCL</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="contributing_to_tcl/parrot"
>contributing to tcl/parrot <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>a brief overview on how to help out,
if you&#39;re interested.
In general,
it&#39;s ok to send patches for tcl to the RT system for anything that isn&#39;t &#34;BIG STUFF&#34; &#45; those,
please bounce off me first.
I&#39;d prefer <code lang='und' xml:lang='und'>diff &#45;u</code> patches,
but am happy to take complete files as well.</p>

<p>Most of this is mentioned in the TODO &#45; in fact,
this document probably should merge with the TODO to avoid redundancy.</p>

<h1><a name="BIG_STUFF"
>BIG STUFF <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="interperter_&#45;&#62;_compiler"
>interperter &#45;&#62; compiler</a></dt><p class="pad"></p>

<dd>Right now,
partcl is an interpreter.
The parser generates an AST of sorts,
which the interpreter then walks through the ast,
finds the command to execute,
(e.g.,
<code lang='und' xml:lang='und'>Tcl::puts</code>),
gets the values for each of the args (Evaluation is deferred until just before the function is called.)</dd><p class="pad"></p>

<dd>To switch to a compiler,
we need to basically use the same interpreter loop,
but generate it specifically for the series of commands being invoked.
Once we have the PIR,
we can then <code lang='und' xml:lang='und'>compile</code> it,
and return that anonymous PIR sub.
Then,
instead of calling &#34;interpret&#34;,
we can just invoke that sub.</dd><p class="pad"></p>

<dd>Some optimizations we can do:</dd><p class="pad"></p>

<dd>TclWord (which we call to get the PMC for the various arguments),
has an &#34;is_const&#34; method &#45; If we look up the value and it&#39;s constant,
we can hardcode it right into the PIR.
Same goes for the commands.</dd><p class="pad"></p>

<dd>A non&#45;tcl option we can provide is a command line option to just dump the generated PIR/bytecode.
(e.g.
tclsh &#45;o foo.pir or tclsh &#45;o foo.pbc)</dd><p class="pad"></p>

<dd>One algorithm to cache the builtins &#45; keep a global counter (in some places,
called epoch) &#45; every time [rename] is called,
epoch is bumped up and we have to re&#45;fetch the method.
But,
if it hasn&#39;t changed,
we&#39;re allowed to cheat.
And if we can cheat on something like <code lang='und' xml:lang='und'>puts foo</code>,
we can translate that *in place* to a simple <code lang='und' xml:lang='und'>print &#34;foo\n&#34;</code> and not have to go through all the overhead.</dd><p class="pad"></p>

<dt><a name="speed"
>speed</a></dt><p class="pad"></p>

<dd>We&#39;re currently quite slow,
compared to tclsh.
Switching over to a compiler instead of an interpreter might help here,
though I&#39;m having a hard time envisioning a compiler that doesn&#39;t have to do all the things we already do as an interpreter.</dd><p class="pad"></p>

<dd>We could rewrite parse/interpret/compile in C,
either as an NCI or behind a PMC object &#45; this would <i>possibly</i> give us an improvement in speed also.</dd><p class="pad"></p>

<dt><a name="features"
>features</a></dt><p class="pad"></p>

<dd>We&#39;re currently missing some things that require support from parrot before we can continue,
like [info nameofexecutable].
In general,
though,
a lot of what we need to do is possible with parrot.</dd><p class="pad"></p>

<dd>If you&#39;re looking for something to todo,
check one of: TODO tests in <code lang='und' xml:lang='und'>t/</code>; RT https://rt.perl.org/rt3/NoAuth/parrot/List.html?Field=Lang&#38;Value=tcl or by their absence: every actual builtin at <a href="http://www.tcl.tk/man/tcl8.5/TclCmd/contents.htm">http://www.tcl.tk/man/tcl8.5/TclCmd/contents.htm</a> should have a corresponding file in <code lang='und' xml:lang='und'>lib/commands/</code></dd><p class="pad"></p>
</dl>

<h1><a name="DOCUMENTATION"
>DOCUMENTATION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="pod"
>pod</a></dt><p class="pad"></p>

<dd>Every PIR .sub that&#39;s defined should probably have some POD to go along with it to document the arguments and return values.
Only exceptions to this should be subs which correspond directly to Tcl builtins &#45;&#45; those are already documented elsewhere.</dd><p class="pad"></p>

<dt><a name="big_picture_docs."
>big picture docs.</a></dt><p class="pad"></p>

<dd>Are the docs in <code lang='und' xml:lang='und'>docs/</code> useful?
Could use someone to proof them,
and verify that there are no missing chunks (if missing,
write them,
or get them added to the <code lang='und' xml:lang='und'>TODO</code>),
and that they are coherent.</dd><p class="pad"></p>
</dl>

<h1><a name="PIR"
>PIR <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="Missing_Commands"
>Missing Commands</a></dt><p class="pad"></p>

<dd>Every builtin command corresponds to a file with an appropriately named sub in <code lang='und' xml:lang='und'>lib/commands</code> &#45; Each of these subs takes some number of PMCs as arguments.
For those commands that take a fixed number of parameters,
we declare them with <code lang='und' xml:lang='und'>.param</code>.
For those that take a variable number,
we use the <code lang='und' xml:lang='und'>foldup</code> opcode.</dd><p class="pad"></p>

<dd>If the return value would be TCL_OK,
then simply <code lang='und' xml:lang='und'>.return</code> the value from the sub.
For any other return type,
use one of the macros in <code lang='und' xml:lang='und'>lib/returncodes.pir</code>: <code lang='und' xml:lang='und'>.throw</code>,
etc.
the value can be any simple register or a PMC,
the calling conventions will autobox as necessary.</dd><p class="pad"></p>

<dd>Before adding new functionality,
add a test (or a test in an existing) file in <code lang='und' xml:lang='und'>t/</code> &#45; tests for <code lang='und' xml:lang='und'>puts</code>,
for example,
go in <code lang='und' xml:lang='und'>t/cmd_puts.t</code> &#45; we use the <code lang='und' xml:lang='und'>Test::Harness</code> framework,
via <code lang='und' xml:lang='und'><a href='../../../lib/Parrot/Test.pm.html'>Parrot::Test</a></code>.</dd><p class="pad"></p>

<dd>Our final goal will be to pass (most of) the tcl test suite: run <code lang='und' xml:lang='und'>make tcl&#45;test</code> to checkout the latest version of of the tcl test suite and run it.
Warning: slow...</dd><p class="pad"></p>

<dd>Long term goal is remove any tests in <code lang='und' xml:lang='und'>t/</code> that are testing things that are already tested in the official tcl suite.
Partcl&#39;s checked in test suite should just be checking partcl&#45;specific functionaliity.</dd><p class="pad"></p>
</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
