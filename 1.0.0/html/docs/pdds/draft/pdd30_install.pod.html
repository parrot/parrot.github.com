<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Parrot  - [DRAFT] PDD 30: Installation</title>
        <link rel="stylesheet" type="text/css"
            href="../../../../resources/parrot.css"
            media="all">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    </head>
    <body>
        <div id="wrapper">
            <div id="header">

                <a href="http://www.parrot.org">
                <img border=0 src="../../../../resources/parrot_logo.png" id="logo" alt="parrot">
                </a>
            </div> <!-- "header" -->
            <div id="divider"></div>
            <div id="mainbody">
                <div id="breadcrumb">
                    <a href="../../../../html/index.html">Home</a> &raquo; <a href="../../../../html/pdds.html">Parrot Design Documents (PDDs)</a> &raquo; [DRAFT] PDD 30: Installation
                </div>

<h1><a name="[DRAFT]_PDD_30:_Installation"
>[DRAFT] PDD 30: Installation</a></h1>

<h2><a name="Abstract"
>Abstract</a></h2>

<p>This PDD outlines Parrot&#39;s installation system and support.
Parrot&#39;s core installation system will provide support for binary packages,
a working <code>make install</code> target,
compiled installables,
and FHS compliant search paths for the installables.
This document also aims to solve the current problem of accessing installed source&#45;only files,
and to allow the optimization of config bootstrapping if a frozen config_hash is already linked.</p>

<h2><a name="Version"
>Version</a></h2>

<p>$Revision$</p>

<h2><a name="Synopsis"
>Synopsis</a></h2>

<p>Parrot installation process (from the parrot source directory):</p>

<pre>  perl Configure.pl &#45;&#45;prefix=/usr/lib
  make
  make test
  make install</pre>

<p>Language installation process (from the language source directory):</p>

<pre>  make
  make test
  make install</pre>

<h2><a name="Description"
>Description</a></h2>

<p>Parrot uses Filesystem Hierarchy Standard (FHS) compliant install directories by default. Each install location is configurable with options passed to the configure script.</p>

<dl>
<dt><a name="/usr/bin/parrot"
><em>/usr/bin/parrot</em></a></dt>
The main Parrot executable.
<dt><a name="/usr/lib/parrot/&#60;version/library/&#62;"
><em>/usr/lib/parrot/&#60;version</em>/library/&#62;</a></dt>
Parrot runtime libraries, corresponds to <em>runtime/parrot/library/</em> in the repository.
<dt><a name="/usr/lib/parrot/&#60;version/include/&#62;"
><em>/usr/lib/parrot/&#60;version</em>/include/&#62;</a></dt>
Parrot runtime include files (not C include files), corresponds to <em>runtime/parrot/include/</em> in the repository.
<dt><a name="/usr/lib/parrot/&#60;version/dynext/&#62;"
><em>/usr/lib/parrot/&#60;version</em>/dynext/&#62;</a></dt>
Parrot dynamic extension files (for <code>loadlib</code>), corresponds to <em>runtime/parrot/dynext/</em> in the repository.
<dt><a name="/usr/lib/parrot/&#60;version/languages/&#62;"
><em>/usr/lib/parrot/&#60;version</em>/languages/&#62;</a></dt>
Parrot language modules, corresponds to <em>languages/</em> in the repository.Languages are loaded with <code>load_language &#39;abc&#39;</code>, which loads either <em>languages/abc/abc.pbc</em> in the build environment of a language in trunk, or <em>/usr/lib/parrot/languages/abc/abc.pbc</em> in an installed Parrot.On the commandline, a language is executed as:
<pre>  $ abc hello.bc</pre>
Where <em>abc</em> is a symlink to the <em>parrot</em> executable. On platforms that don&#39;t have symlinks, <em>abc</em> may be a copy of the <em>parrot</em> executable. On general principles, languages should not install themselves with the same name as their &#34;real&#34; counterpart, but should provide a build option to do so (so, the default installed executable for Python on Parrot should be <em>pynie</em> or <em>parrot&#45;python</em> but not <em>python</em>).
<dt><a name="/usr/lib/parrot/&#60;version/languages/*&#62;"
><em>/usr/lib/parrot/&#60;version</em>/languages/*&#62;</a></dt>
The languages directories may have subdirectories, including <em>library</em> for their own set of libraries, and <em>dynpmc</em> for dynamic pmcs.It is recommended that languages follow a standard pattern in installing their libraries so a bytecode compiled version of a module in the <code>mylang</code> HLL named <code>[&#39;Foo&#39;;&#39;Bar&#39;]</code> is stored in <em>usr/lib/parrot/&#60;version</em>/languages/&#60;mylang&#62;/library/Foo/Bar.pbc&#62;
<dt><a name="/usr/lib/parrot/&#60;version/tools/&#62;"
><em>/usr/lib/parrot/&#60;version</em>/tools/&#62;</a></dt>
Parrot tools that don&#39;t belong in the bin/ directory and don&#39;t belong in the runtime, corresponds to <em>tools/dev/</em> and/or <em>tools/build</em> in the repository.
<dt><a name="/usr/share/doc/parrot/&#60;version/"
><em>/usr/share/doc/parrot/&#60;version/</em></a></dt>
Parrot documentation files, generally raw Pod, but possibly also formatted HTML. May have subdirectories <em>pod/</em>, <em>html/</em>, etc.</dl>

<p>Bootstrapping the configuration hash should not read a config file when the hash is already contained in the pmc or executable. {{ See RT #57418 [TODO] optimize _config to omit .include &#34;library/config.pir&#34; on installables. }} The same problem is for every <code>.include</code>, <code>loadlib</code> and <code>load_bytecode</code> statement in installed files where the target is not installed. If in doubt install the missing library by patching the installation code.</p>

<p>Test executables are binary different to installable executables because of this embedded configuration hash. Test executables contain configuration hash with the prefix to the build directory, installables to the given prefix from Configure.pl. The executables that are tested should always be the same as the ones that are installed. Otherwise, subtle bugs can leak into the installed executables which can never be caught by the tests.</p>

<p>There are&#39;s also a long&#45;standing conflict in building Parrot with an already installed shared libparrot.so. See RT #39742. For win32 this was solved to put the dll into build_dir, for compilers withour rpath support this is still a problem.</p>

<h2><a name="Dependencies"
>Dependencies</a></h2>

<p>Building core Parrot depends on Perl (including perldoc, which may be a separate package), libgdm and libreadline.</p>

<p>Building a language depends on a series of Parrot build tools, installed in <em>/usr/lib/parrot/&#60;version/tools</em>. These tools will generally not be included in the default <code>parrot</code> package on most systems, but will require a <code>parrot&#45;dev</code> package to be installed before they can be built.</p>

<h2><a name="Definitions"
>Definitions</a></h2>

<p>The <b>build_dir</b> is the full path where Parrot was built. It is defined in the configuration hash. When building from source the <code>build_dir</code> is also the <code>PARROT_RUNTIME</code> prefix.</p>

<p>An <b>installable</b> is a bytecode or executable file which must not access the build_dir paths. The build_dir path is not available in a binary package. This is solved by generating and linking a special <em>install_config.fpmc</em>. Custom Python modules have a similar packaging problem, which they haven&#39;t solved yet.</p>

<p>The <b>destination directory</b> is the path of the installed Parrot tree after the prefix (<em>/usr</em>, <em>/usr/local</em>, or some other platform&#45;specific or custom location). Creating a virtual installation path like this simplifies packaging by installing into a separate install tree and creating a tarball from that tree.</p>

<p>The <b>configuration hash</b> is the return value of the global function <code>_config()</code>, generated in <em>config_lib.pasm</em>, and either defined in <em>library/config.pir</em>, or as frozen PMC embedded in the test executable (<em>config.fpmc</em>), the installable executable (<em>install_config.fpmc</em>) or empty for miniparrot (<em>null_config.fpmc</em>).</p>

<h3><a name="make_install"
>make install</a></h3>

<p>The Parrot build system is currently optimized for building and testing in the build directory, but not for building with an already installed Parrot. This is complicated by some simple build system bugs. It is also not optimized to build and test installables, which should not access libraries in the build directory, but in the destination directory.</p>

<p>The short&#45;term goal of this document is to make installation work for Parrot, its libraries and tools, and its languages so that packagers can provide binary packages for parrot and its languages.</p>

<p>The longer&#45;term goal is a framework so that external libraries and languages not within the current parrot source tree can also be properly built, tested and installed.</p>

<p>We do not only support GNU make or Win32 nmake but also other platform make variants, so we generate the Makefile at first from a generic template.</p>

<p>Currently for Parrot and its libraries the install actions are defined in the main Makefile. For the languages the install actions are defined in the language&#39;s Makefile. {{ See an implementation of this in #56554&#45;make&#45;install&#45;lang.patch.}}</p>

<p>One general comment: We need to be careful not to install bytecode files in the same directories as executables. The C includes and the PIR includes also need to be separate.</p>

<p><code>make install</code> currently does not work with an already installed shared libparrot.so on some platforms. {{See a patch for this in RT #39742.}}</p>

<ul>
<li>bin_dir: Copy installables to the destination directory&#39;s <em>bin</em> directory as <em>parrot&#45;mylanguage</em>.</li>

<li>script_dir: Optionally copy the main language file <em>mylanguage.pbc</em> to the destination directory&#39;s <em>script</em> directory. (<em>/usr/lib/parrot/bin/</em> ?)</li>

<li>dynext: Copy shared libraries (groups and ops) to the destination directory&#39;s <em>lib</em> directory under <em>/parrot/dynext/</em>.</li>

<p>The subdirs are currently needed for <code>forth</code> and <code>WMLScript</code>, the other language pbc&#39;s are <em>php_*.pbc</em>, <em>pipplib.pbc</em> and <em>tcllib.pbc</em>.</p>

<li>lib_dir: Optionally copy include PASM and PIR files to the destination directory&#39;s <em>lib</em> directory under <em>parrot/include/</em> <i>(not yet)</i>.</li>

<li>doc_dir: Copy documentation files to a <em>$doc_dir/languages/mylanguage/</em> subdirectory tree.</li>

<li>man_dir: Generate man(1) pages and copy to destination directory&#39;s <em>$man_dir/man1/</em> directory. {{ what about man(2) and man(3) pages? info_dir ditto }}</li>

<li>html_dir: Optionally generate HTML and copy to destination directory&#39;s <em>html</em> directory, possibly under a language specific subdirectory. This should be selectable by a <code>Configure</code> or <code>make install</code> option.</li>
</ul>

<h3><a name="Configuration_bootstrapping"
>Configuration bootstrapping</a></h3>

<p>Bootstrapping the configuration hash should not read a config file when the hash is already contained in the PMC or executable. <code>.include &#34;library/config.pir&#34;</code> and <code>load_bytecode &#34;config.pbc&#34;</code> should be omitted on installables if possible.</p>

<p>{{NOTE: We need to step back and take a broader view here. Why is <em>library/config.pir</em> currently included in the installables? It sounds like a hack to work around earlier limitations in the build system. This is an ideal opportunity to eliminate the hack. &#45;allison}}</p>

<h3><a name="Accessing_not&#45;installed_files"
>Accessing not&#45;installed files</a></h3>

<p><b>Makefile and MANIFEST cleanup</b></p>

<p><b>Problem:</b> Various PIR files load source&#45;only PIR, PASM or compiler bytecode files, which are not installed in binary packages. This shows up when trying to run an installable with the build directory removed or renamed.</p>

<pre> $ parrot&#45;forth.exe xx
 &#34;load_bytecode&#34; couldn&#39;t find file &#39;languages/forth/tokenstream.pbc&#39;
 current instr.: &#39; init&#39; pc 942 (forth.pir:9)
 called from Sub &#39;main&#39; pc 994 (forth.pir:40)

 $ parrot&#45;pheme.exe
 &#34;load_bytecode&#34; couldn&#39;t find file &#39;compilers/tge/TGE/Rule.pbc&#39;
 current instr.: &#39;parrot;TGE;__onload&#39; pc 19 (TGE.pir:94)
 called from Sub &#39;parrot;Pheme::AST::Grammar;__onload&#39; pc 7175
    (languages/pheme/lib/ASTGrammar.pir:5)
 called from Sub &#39;parrot;Pheme::Compiler;main&#39; pc &#45;1 ((unknown file):&#45;1)

 $ parrot&#45;pipp
 Parrot VM: Can&#39;t stat
    /usr/src/perl/parrot/parrot&#45;0.7.0&#45;1/
         build/languages/pipp/src/common/pipplib.pbc, code 2.
 Unable to append PBC to the current directory
 current instr.: &#39;parrot;Pipp;__onload&#39; pc 47 (src/common/pipp.pir:92)
 called from Sub &#39;parrot;Pipp;pipp&#39; pc &#45;1 ((unknown file):&#45;1)</pre>

<p><b>Fix 1</b>: Install all deps and make sure that every HLL is installed at <em>lib_dir/parrot/version/languages</em>. See also <a href='TODO'>pdd31_hll_interop.pod</a></p>

<p>{{NOTE: This may be a sign that we need to rethink our language build strategy. Trying to glom everything into a single C executable is less than ideal. Especially since it causes problems for language interoperability if every language is running off its own independent executable. &#45;allison}}</p>

<p>The simple Forth and Pipp problem could be solved by merging the missing bytecode files to a single file <em>forth.pbc</em> and generate from this the installable.</p>

<p>The simple Pheme problem could be solved by installing also all TGE and other compiler bytecode files at the <em>parrot/library/compilers</em> path. Since TGE is not used elsewhere anymore, Pheme should be fixed to get rid of this. {{NOTE: commonly used libraries should be installed somewhere. &#45;allison}}</p>

<p>The same problem is for every <code>.include</code>, <code>loadlib</code> and <code>load_bytecode</code> statement in installed files where the target is not installed.</p>

<p><b>Fix 2</b>: Module system.</p>

<p>Avoid already loaded pbc files.</p>

<p>Source loading PIR statements like <code>loadlib</code> and <code>load_bytecode</code> should cache the file name and skip the file if it has already been loaded (as in perl5)</p>

<p><b>Fix 3</b>: pbc_merge fixups</p>

<p>pbc_merge could patch up the bytecode (if possible) to omit loading load_bytecode pbc&#45;files which are being merged, but hacking bytecode during pbc_merge is not desirable.</p>

<h2><a name="Implementation"
>Implementation</a></h2>

<p>A new language is generated by <em><a href="../../../tools/dev/mk_language_shell.pl.html">tools/dev/mk_language_shell.pl</a></em></p>

<p>The makefiles are generated from a <em>config/makefiles/root.in</em> template, which can make use of conditional platform and config logic, the forward slashes are automatically converted to backslashes for MSWin32 and <code>\n</code> is converted to <code>\r\n</code> for MSWin32 nmake. See <a href='..%2F..%2F..%2Flib%2FParrot%2FConfigure%2FCompiler.pm.html'>Parrot::Configure::Compiler</a>.</p>

<p>A new <em>lib/Parrot/Install.pm</em> or <em>Parrot/Install.pir</em> library should provide the same support as described above and simplify the Makefile and installation maintenance. The entry point could be a Makefile.pl or Makefile.pir then.</p>

<h2><a name="Attachments"
>Attachments</a></h2>

<p>None.</p>

<h2><a name="Footnotes"
>Footnotes</a></h2>

<p>None.</p>

<h2><a name="References"
>References</a></h2>
            </div> <!-- "mainbody" -->
            <div id="divider"></div>
            <div id="footer">
	        Copyright &copy; 2002-2009, Parrot Foundation.
            </div>
        </div> <!-- "wrapper" -->
    </body>
</html>
