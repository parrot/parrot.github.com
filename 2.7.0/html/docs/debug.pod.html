<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Parrot  - Debugging Parrot</title>
        <link rel="stylesheet" type="text/css"
            href="../../resources/parrot.css"
            media="all">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    </head>
    <body>
        <div id="wrapper">
            <div id="header">

                <a href="http://www.parrot.org">
                <img border=0 src="../../resources/parrot_logo.png" id="logo" alt="parrot">
                </a>
            </div> <!-- "header" -->
            <div id="divider"></div>
            <div id="mainbody">
                <div id="breadcrumb">
                    <a href="../../html/index.html">Home</a> &raquo; <a href="../../html/tools.html">Tools</a> &raquo; Debugging Parrot
                </div>

<h1><a name="NAME"
>NAME</a></h1>

<p>docs/debug.pod &#45; Debugging Parrot</p>

<h1><a name="ABSTRACT"
>ABSTRACT</a></h1>

<p>This document describes how to debug various parts of Parrot.</p>

<h1><a name="VERSION"
>VERSION</a></h1>

<p>$Revision $</p>

<h1><a name="THE_PARROT_BINARY"
>THE PARROT BINARY</a></h1>

<h2><a name="Using_a_debugger"
>Using a debugger</a></h2>

<p>Per default the <code>parrot</code> binary is being built with debugging symbols.
This means that you can run <code>parrot</code> under an debugger like <code>gdb</code>.</p>

<p>Debugging support can be explicitly enabled with:</p>

<pre>    shell&#62; perl Configure.pl &#45;&#45;debugging
    shell&#62; make</pre>

<p>For testing it might be a good idea to make test runs without debug support. So debugging can also be turned off with:</p>

<pre>  shell&#62; perl Configure.pl &#45;&#45;debugging=0
  shell&#62; make</pre>

<h2><a name="Using_a_memory_checker"
>Using a memory checker</a></h2>

<p>You could, and should, also run the tests with a memory checker such as <code>valgrind</code>. You can enable <code>valgrind</code>, by running:</p>

<pre>  shell&#62; make test VALGRIND=&#34;valgrind &#45;&#45;log&#45;file=/tmp/grind&#34;</pre>

<p>Another possibility is to use Electric Fence, or ...</p>

<h2><a name="MEMORY_MANAGEMENT"
>MEMORY MANAGEMENT</a></h2>

<p>Some of the more frequent and exasperating <code>parrot</code> bugs are related to memory management in general, and garbage collection in particular.</p>

<p>Infant mortality</p>

<p>See <em><a href="dev/infant.pod.html">docs/dev/infant.pod</a></em> for details of one frequent problem: infant mortality. Infant mortality is when you create a Parrot object, but the garbage collector runs before you put it into a Parrot register or in something else that is itself within a Parrot register.</p>

<p>To help in resolving these issues, the parrot binary accepts a <code>&#45;&#45;gc&#45;debug</code> flag. This flag makes garbage collection occur as frequently as possible, which maximizes the probability that any newborn objects will run afoul of the garbage collector.</p>

<h1><a name="PIR_AND_PASM_CODE"
>PIR AND PASM CODE</a></h1>

<p>Let&#39;s say you have written (or generated) a huge .pasm or .pir file. It&#39;s not working. You&#39;d like some help in figuring out why.</p>

<h2><a name="parrot_debugger"
>parrot_debugger</a></h2>

<p>One possible tool is <code>parrot_debugger</code>, the Parrot Debugger. See <em><a href="debugger.pod.html">docs/debugger.pod</a></em> for details on it.</p>

<h1><a name="PIR_CODE_GENERATION"
>PIR CODE GENERATION</a></h1>

<p>The <code>parrot</code> binary has a bunch of debugging flags for spewing out information about various aspects of its processing. See <a href='TODO'>running.pod</a> for a list of flags. Or have a look at the information provided by:</p>

<pre>  shell&#62; parrot &#45;&#45;help</pre>

<p>or</p>

<pre>  shell&#62; parrot &#45;&#45;help&#45;debug</pre>

<h1><a name="BACKTRACING"
>BACKTRACING</a></h1>

<h2><a name="auto&#45;magical"
>auto&#45;magical</a></h2>

<p>If Parrot is built on a system with GNU libc it is capable of automatically generating a backtrace on <code>stderr</code> for debugging purposes. Currently these automatically backtraces are only generated by assertion failures but in the future they also be produced by other bad events (for example, <code>SEGV</code>).</p>

<p>Here is an example of a what a backtrace might look like:</p>

<pre>    Backtrace &#45; Obtained 15 stack frames (max trace depth is 32).
      (unknown)
        Parrot_confess
          Parrot_str_new_COW
            Parrot_String_get_string
              Parrot_set_s_p
                (unknown)
                  (unknown)
                    (unknown)
                      (unknown)
                        Parrot_runops_fromc_args
                          Parrot_runcode
                            (unknown)
                              imcc_run
                                (unknown)
                                  __libc_start_main
                                    (unknown)</pre>

<p>It must be noted that glibc&#39;s backtraces are not without limitation. It&#39;s method depends completely on information that is available at run time.</p>

<ul>
<li>Functions marked as <code>static</code> can only be identified by address as they have no &#34;symbol name&#34; for dynamic linking in the executable&#39;s symbol table. Static functions will appears as <code>(unknown)</code>.</li>

<li>There must be some means available for walking the stack at runtime. On x86(&#45;64)? the &#34;stack pointer&#34; must be in <code>[re]sp</code> register. For example, this <code>gcc</code> compilation flag would break backtracing (except for functions that do dynamic allocation on the stack as this optimization can no be allied to them). <code>perl Configure.pl &#45;&#45;ccflags=&#45;fomit&#45;frame&#45;pointer</code></li>

<li>Some platforms may require extra linker flags in order to get all of the required symbols exported in the symbol table. <code>Configure.pl &#45;&#45;ccflags=&#45;rdynamic</code></li>

<li>Any debugging information embedded in the object is not accessible. So file and line number can not be included as part of the backtrace information.</li>

<li>Be warned that signals may cause incorrect backtraces!</li>
</ul>

<h2><a name="gdb"
>gdb</a></h2>

<p>On systems not equipped with libc, one will need to use an external debugger to get backtrace information. This method is actually more capable then the <a href='TODO'>auto&#45;magical</a> approach as most debuggers will use debugging information if it&#39;s available in the object code (for example, if parrot was built with <code>&#45;g</code>).</p>

<p>Since the <code>Parrot_confess</code> symbol is <i>always</i> compiled into parrot it can be used as a break point to obtain a backtrace. Here is an example of doing this with gdb and a version of parrot compiled with <code>gcc</code> and the <code>&#45;g</code> flag.</p>

<pre>    $ gdb parrot
    GNU gdb 6.6
    Copyright (C) 2006 Free Software Foundation, Inc.
    GDB is free software, covered by the GNU General Public License, and you are
    welcome to change it and/or distribute copies of it under certain conditions.
    Type &#34;show copying&#34; to see the conditions.
    There is absolutely no warranty for GDB.  Type &#34;show warranty&#34; for details.
    This GDB was configured as &#34;i686&#45;pc&#45;linux&#45;gnu&#34;...
    Using host libthread_db library &#34;/lib/libthread_db.so.1&#34;.
    (gdb) b main
    Breakpoint 1 at 0x80488a0: file src/main.c, line 38.
    (gdb) r foo.pir
    Starting program: /home/moanui/jhoblitt/parrot/parrot foo.pir
    Failed to read a valid object file image from memory.
    [Thread debugging using libthread_db enabled]
    [New Thread &#45;1213900128 (LWP 23148)]
    [Switching to Thread &#45;1213900128 (LWP 23148)]

    Breakpoint 1, main (argc=&#45;400292727, argv=0x159a0) at src/main.c:38
    38      {
    (gdb) b Parrot_confess
    Breakpoint 2 at 0xb7c542a0: file src/exceptions.c, line 767.
    (gdb) c
    Continuing.
    [New Thread &#45;1214039152 (LWP 23151)]
    [New Thread &#45;1222431856 (LWP 23152)]
    1..1

    Breakpoint 2, Parrot_confess (cond=0xb7eeda65 &#34;s&#34;, 
        file=0xb7eeda58 &#34;src/string.c&#34;, line=129) at src/exceptions.c:767
    warning: Source file is more recent than executable.
    767     {
    (gdb) bt full
    #0  Parrot_confess (cond=0xb7eeda65 &#34;s&#34;, file=0xb7eeda58 &#34;src/string.c&#34;, 
        line=129) at src/exceptions.c:767
    No locals.
    #1  0xb7c433b1 in Parrot_str_new_COW (interp=0x804e008, s=0x0)
        at src/string.c:129
            d = (STRING *) 0x81c21b8
            __PRETTY_FUNCTION__ = &#34;Parrot_str_new_COW&#34;
    #2  0xb7e40db3 in Parrot_String_get_string (interp=0x804e008, pmc=0x81c8578)
        at src/pmc/string.c:310
    No locals.
    #3  0xb7cc7d41 in Parrot_set_s_p (cur_opcode=0x825d470, interp=0x804e008)
        at src/ops/set.ops:159
    No locals.
    #4  0xb7c9da32 in runops_slow_core (interp=0x804e008, pc=0x825d470)
        at src/runcore/cores.c:184
    No locals.
    #5  0xb7c67acf in runops_int (interp=0x804e008, offset=0)
        at src/interp/interpreter.c:816
            pc = (opcode_t * const) 0x8239730
            lo_var_ptr = 134537224
            core = (opcode_t *(*)(Parrot_Interp, 
        opcode_t *)) 0xb7c9d940 &#60;runops_slow_core at src/runcore/cores.c:169&#62;
    #6  0xb7c6854e in runops (interp=0x804e008, offs=0) at src/call/ops.c:100
            offset = 0
            old_runloop_id = 0
            our_runloop_level = 1
            our_runloop_id = 1
    #7  0xb7c687da in runops_args (interp=0x804e008, sub=0x8204d58, obj=0x80912d8, 
        meth_unused=0x0, sig=0xb7eefca6 &#34;vP&#34;, 
        ap=0xbfec614c &#34;@M \b&#195;&#175;&#194;&#191;&#194;&#189;b&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;P&#195;&#175;&#194;&#191;&#194;&#189;\222K\230&#195;&#175;&#194;&#191;&#194;&#189;\004\b@\236\&#34;\b@M \bXM
            \b\004&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;t&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;\b&#195;&#175;&#194;&#191;&#194;&#189;\004\b\001&#34;) at src/call/ops.c:216
            offset = 0
            dest = (opcode_t *) 0x8239730
            ctx = (Parrot_Context *) 0x822a3b0
            new_sig = &#34;&#34;
            sig_p = 0xb7eefca7 &#34;P&#34;
            old_ctx = (Parrot_Context * const) 0x804e298
    #8  0xb7c688fb in Parrot_runops_fromc_args (interp=0x804e008, sub=0x8204d58, 
        sig=0xb7eefca6 &#34;vP&#34;) at src/call/ops.c:293
            args = 0xbfec614c &#34;@M \b&#195;&#175;&#194;&#191;&#194;&#189;b&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;P&#195;&#175;&#194;&#191;&#194;&#189;\222K\230&#195;&#175;&#194;&#191;&#194;&#189;\004\b@\236\&#34;\b@M
                \bXM \b\004&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;t&#195;&#175;&#194;&#191;&#194;&#189;&#195;&#175;&#194;&#191;&#194;&#189;\b&#195;&#175;&#194;&#191;&#194;&#189;\004\b\001&#34;
            ctx = (Parrot_Context *) 0xb7fa1548
    #9  0xb7c50c51 in Parrot_runcode (interp=0x804e008, argc=1, argv=0xbfec62e8)
        at src/embed.c:783
            userargv = (PMC *) 0x8204d40
            main_sub = (PMC *) 0x8204d58
    #10 0xb7ed74a1 in imcc_run_pbc (interp=0x804e008, obj_file=0, output_file=0x0, 
        argc=1, argv=0xbfec62e8) at compilers/imcc/main.c:614
    No locals.
    #11 0xb7ed7d90 in imcc_run (interp=0x804e008, sourcefile=0xbfec6e0a &#34;foo.pir&#34;, 
        argc=1, argv=0xbfec62e8) at compilers/imcc/main.c:815
            obj_file = 0
            yyscanner = (yyscan_t) 0x822a090
            output_file = 0x0
    #12 0x080489b7 in main (argc=136704448, argv=0x825f220) at src/main.c:62
            sourcefile = 0xbfec6e0a &#34;foo.pir&#34;
            interp = (Interp *) 0x804e008
            executable_name = (STRING *) 0x821b8e4
            executable_name_pmc = (PMC *) 0x8204d70
            status = 1267896320
    (gdb) </pre>
            </div> <!-- "mainbody" -->
            <div id="divider"></div>
            <div id="footer">
	        Copyright &copy; 2002-2010, Parrot Foundation.
            </div>
        </div> <!-- "wrapper" -->
    </body>
</html>
