<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Multiple Dispatch</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Multiple Dispatch</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>docs/pdds/pdd27_multiple_dispatch.pod &#45; Multiple Dispatch</p>

<h1><a name="ABSTRACT"
>ABSTRACT <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>This PDD defines Parrot&#39;s multiple dispatch system.</p>

<h1><a name="VERSION"
>VERSION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>$Revision$</p>

<h1><a name="DEFINITIONS"
>DEFINITIONS <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Multiple dispatch allows a single function name to be associated with several alternate implementations.
It selects the alternate to execute for a particular call at runtime,
based on the types of the arguments passed into the call.
The selection process compares the arguments of the call and the types declared in the signatures of the alternates,
as well as their inherited or composed parents,
to find the best match.</p>

<p>A similar selection of alternates based on types at compile time is generally called overloading.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="&#45;_Parrot_supports_multiple_dispatch_in_opcodes_and_user&#45;defined_routines"
>&#45; Parrot supports multiple dispatch in opcodes and user&#45;defined routines</a></dt><p class="pad"></p>

<dt><a name="&#45;_A_single_dispatch_system_supports_MMD_in_both_contexts"
>&#45; A single dispatch system supports MMD in both contexts</a></dt><p class="pad"></p>

<dt><a
>&#45; For user&#45;defined subroutines and methods,
the dispatch system is pluggable,
allowing users to swap in their own type&#45;matching algorithms</a></dt><p class="pad"></p>

<dt><a
>&#45; For opcodes,
the dispatch system is merely extensible,
allowing users to define alternates with their own types</a></dt><p class="pad"></p>

<dt><a
>Dispatch considers both low&#45;level (register) types and high&#45;level (PMC) types,
as well as inherited and composed types</a></dt><p class="pad"></p>
</dl>

<h1><a name="IMPLEMENTATION"
>IMPLEMENTATION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>The aim of Parrot&#39;s multiple dispatch system is not to be an exact match to any one HLL,
but to provide the features and tools needed to support multiple dispatch in a number of different HLLs.</p>

<p>Parrot has a single multiple dispatch system,
used at the HLL level and internally.
{{NOTE: I appreciate the history that led us to have two largely independent MMD systems,
but it will cause problems down the road,
if we don&#39;t fix it now.}}</p>

<p>The heart of the system is the MultiSub PMC.
All multiple dispatch routines are MultiSub PMCs,
subclasses of MultiSub,
or polymorphic equivalents of MultiSub.
Calls to multiple dispatch routines use the Parrot calling conventions.</p>

<h2><a name="MultiSub_PMC_API"
>MultiSub PMC API <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>A MultiSub stores a list of subroutines.
When a MultiSub is invoked,
it calls an MMD sorting routine to select the best candidate for the current arguments,
and invokes that candidate.</p>

<p>A MultiSub can be used anywhere a Sub can be used.
It can be stored in a namespace or as a method or vtable override in a class.</p>

<p>An alternate multiple dispatch matching algorithm may be plugged in by subclassing MultiSub and overriding <code lang='und' xml:lang='und'>invoke</code>.</p>

<h3><a name="Vtable_Functions"
>Vtable Functions</a></h3>

<p>MultiSub defines the following vtable functions in addition to the ones inherited from ResizablePMCArray.</p>

<dl>
<dt><a name="push_pmc"
>push_pmc</a></dt><p class="pad"></p>

<dd>Add a Sub or NCI sub to the list of candidates.
Throw an exception if the value passed in is anything other than a Sub or NCI sub.</dd><p class="pad"></p>

<dt><a name="set_pmc_keyed_int"
>set_pmc_keyed_int</a></dt><p class="pad"></p>

<dd>Add a Sub or NCI sub to the list of candidates at a particular position in the list.
Throw an exception if the value passed in is anything other than a Sub or NCI sub.</dd><p class="pad"></p>

<dt><a name="invoke"
>invoke</a></dt><p class="pad"></p>

<dd>Invoke the best matching candidate for the current call arguments.
This vtable function calls <code lang='und' xml:lang='und'>Parrot_mmd_sort_candidate_list</code> from the public MMD API,
but may be changed to call <code lang='und' xml:lang='und'>Parrot_mmd_invoke</code>.</dd><p class="pad"></p>

<dt><a name="set_integer_keyed_int,_set_number_keyed_int,_set_string_keyed_int"
>set_integer_keyed_int,
set_number_keyed_int,
set_string_keyed_int</a></dt><p class="pad"></p>

<dd>Throw an exception,
as an integer,
float,
or string value is not a Sub or NCI sub.
(Masks the vtable functions inherited from ResizablePMCArray.)</dd><p class="pad"></p>
</dl>

<h3><a name="PIR_subroutine_attributes"
>PIR subroutine attributes</a></h3>

<p>The following attributes are used when declaring a MultiSub in PIR.</p>

<dl>
<dt><a name=":multi"
>:multi</a></dt><p class="pad"></p>

<pre lang='und' xml:lang='und'>  .sub mymultisub :multi(Integer, Integer)</pre>

<dd>The <code lang='und' xml:lang='und'>:multi</code> attribute marks a subroutine or method as participating in multiple dispatch.</dd><p class="pad"></p>

<dt><a name=":invocant"
>:invocant</a></dt><p class="pad"></p>

<pre lang='und' xml:lang='und'>  .param pmc first :invocant</pre>

<dd>Not all elements of a multi&#45;sub&#39;s signature are relevant for the purposes of multiple dispatch. The subroutine parameters that participate in dispatch are marked with the attribute <code lang='und' xml:lang='und'>:invocant</code>, and must be contiguous. Subs that are not marked with <code lang='und' xml:lang='und'>:multi</code> may not mark parameters with <code lang='und' xml:lang='und'>:invocant</code>.</dd><p class="pad"></p>

<dd>{{NOTE: I&#39;m open to other names for the attribute. An English form of the Latin <i>invocare</i>, &#34;to call upon&#34;, is pretty appropriate to the act of using an argument as a selector for multiple dispatch.}}</dd><p class="pad"></p>
</dl>

<h2><a name="C_Multiple_Dispatch_API"
>C Multiple Dispatch API <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>These functions are the public interface to common multiple dispatch operations, and may be called from opcodes, vtable functions, or other C functions.</p>

<dl>
<dt><a name="Parrot_mmd_sort_candidate_list"
>Parrot_mmd_sort_candidate_list</a></dt><p class="pad"></p>

<dd>Performs a multiple dispatch lookup on an array of subroutines. The call signature to match is pulled from the current interpreter, following the Parrot calling conventions. Returns a sorted array of candidates that match the call signature, with the best matching candidate as the 0th element.</dd><p class="pad"></p>

<dt><a name="Parrot_mmd_invoke"
>Parrot_mmd_invoke</a></dt><p class="pad"></p>

<dd>Make a multiple dispatch call. Similar in syntax to <code lang='und' xml:lang='und'>Parrot_PCCINVOKE</code>, but doesn&#39;t separate out the invocant before the signature since the call can have multiple invocants. A significant part of the code from <code lang='und' xml:lang='und'>Parrot_PCCINVOKE</code> can be factored out to helper routines used by both <code lang='und' xml:lang='und'>Parrot_PCCINVOKE</code> and <code lang='und' xml:lang='und'>Parrot_mmd_invoke</code>.</dd><p class="pad"></p>

<pre lang='und' xml:lang='und'>  void
  Parrot_mmd_invoke(PARROT_INTERP, NOTNULL(STRING *sub_name),
        ARGIN(const char *signature), ...)&#62;</pre>

<dt><a name="mmd_dispatch*_[deprecated]"
>mmd_dispatch* [deprecated]</a></dt><p class="pad"></p>

<dd>Dispatch a routine with a fixed low&#45;level (register) type signature, with multiple dispatch on the high&#45;level (PMC) types. The low&#45;level call and return types are specified in the name of the function: &#39;i&#39; for integer, &#39;n&#39; for float, &#39;s&#39; for string, &#39;p&#39; for PMC, and &#39;v&#39; for void. So, a dispatch of one PMC and one integer argument that returns void is a call to <code lang='und' xml:lang='und'>mmd_dispatch_v_pi()</code>.</dd><p class="pad"></p>
</dl>

<h2><a name="Opcode_Multiple_Dispatch"
>Opcode Multiple Dispatch <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Parrot&#39;s basic opcodes are not multiple dispatch. They appear to be so, since a single opcode name may have multiple signatures. But, behind the scenes, this is essentially compile&#45;time overloading. (Each different signature is actually a different opcode number, hidden behind the abstraction of a single name.)</p>

<p>Multiple dispatch is only used by a limited set of opcodes. These opcodes directly correspond to standard vtable functions. Multiple dispatch opcodes may take PMC, integer, float, or string arguments and return a PMC, integer, float, or string result.</p>

<p>Multiple dispatch opcodes are standard opcodes that internally call the <code lang='und' xml:lang='und'>Parrot_mmd_invoke</code> routine from the public MMD API.</p>

<p>{{NOTE: It is no longer necessary to name multisubs used for opcode dispatch using the &#34;__&#34; names.}}</p>

<h2><a name="Vtable_Multiple_Dispatch"
>Vtable Multiple Dispatch <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Some PMCs call multiple dispatch routines from their vtable functions. ResizablePMCArray, for example, calls the multiple dispatch equality operation on each element of two arrays from the &#39;is_equal&#39; vtable function.</p>

<p>Multiple dispatch calls from within vtable functions call the <code lang='und' xml:lang='und'>Parrot_mmd_invoke</code> routine from the public MMD API.</p>

<h1><a name="ATTACHMENTS"
>ATTACHMENTS <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>None.</p>

<h1><a name="REFERENCES"
>REFERENCES <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>docs/mmd.pod src/mmd.c src/pmc/multisub.pmc</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
