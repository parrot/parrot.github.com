<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
    <HEAD>
        <TITLE>Parrot Subroutines</TITLE>
        <LINK REL="stylesheet" TYPE="text/css"
            HREF="../../../resources/perl.css"
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY>
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot Subroutines</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Subs &#45; Parrot Subroutines</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Parrot comes with different subroutine and alike classes which implement CPS (Continuation Passing Style) and PCC (Parrot Calling Conventions) <em lang='und' xml:lang='und'><a href="../pdds/pdd03_calling_conventions.pod.html">docs/pdds/pdd03_calling_conventions.pod</a></em>.</p>

<p>Please note,
that this document refers to PASM assembler only.
The PIR assembler has a more HLL&#45;like syntax for Parrot Calling Conventions.
S.
<em lang='und' xml:lang='und'>imcc/docs/calling_conventions.pod</em></p>

<h2><a name="Class_Tree"
>Class Tree <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>  Sub
    Closure
      Continuation
        Coroutine
      Eval
      RetContinuation</pre>

<h2><a name="Items_in_the_Subs_Context"
>Items in the Subs Context <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>  Subtype       Controlstack  PadStack UserStack RegStacks Warnings
  &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
  Sub                &#45;           &#45;         &#45;         &#45;        C
  Closure            &#45;           C         &#45;         &#45;        C
  Continuation       C           C         C         C        C
  Coroutine          C           C         C         C        C
  RetContinuation    X           X         X         X        X

  &#34;C&#34; ... COWed copy is in context
  &#34;X&#34; ... is in context
  &#34;&#45;&#34; ... isn&#39;t.</pre>

<h1><a name="SYNOPSIS"
>SYNOPSIS <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<h2><a name="Creation"
>Creation <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Create a subroutine of class <code lang='und' xml:lang='und'>Sub</code> and assign the subroutine address to it:</p>

<pre lang='und' xml:lang='und'>  new P0, &#39;Sub&#39;
  set_addr P0, _sub_label</pre>

<p>This can be done with one opcode:</p>

<pre lang='und' xml:lang='und'>  newsub P0, .Sub, _sub_label</pre>

<p>Create a subroutine (in P0) and a return continuation (in P1):</p>

<pre lang='und' xml:lang='und'>  newsub .Sub, .RetContinuation, _sub_label, ret_label</pre>

<h2><a name="Refering_to_existing_Subs"
>Refering to existing Subs <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Subroutines denoted with <b>.pcc_sub</b> (and all PIR <b>.sub</b> subroutines that use Parrot Calling Conventions) are stored in the constant table and can be fetched with the <b>get_hll_global</b> and <b>get_root_global</b> opcodes.</p>

<p>E.g. get a reference to a (possibly) external subroutine:</p>

<pre lang='und' xml:lang='und'>  get_hll_global $P0, &#34;_the_sub&#34;
  ...
  .pcc_sub _the_sub:</pre>

<h2><a name="Program_entry_point"
>Program entry point <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>Exactly one subroutine in the first executed source or byte code file may be flagged as the &#34;main&#34; subroutine, where executions starts.</p>

<pre lang='und' xml:lang='und'>  .pcc_sub :main _main:</pre>

<p>In the absence of a <b>:main</b> entry Parrot starts execution at the first statement.</p>

<h2><a name="Automatically_loaded_initializer_code"
>Automatically loaded initializer code <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>If a subroutine is marked as <b>:load</b> this subroutine is run, before the <b>load_bytecode</b> opcode returns.</p>

<p>e.g.</p>

<pre lang='und' xml:lang='und'>  .pcc_sub :main _main:
     print &#34;in main\n&#34;
     load_bytecode &#34;library_code.pasm&#34;
     ...</pre>

<p># library_code.pasm</p>

<pre lang='und' xml:lang='und'>     ...
  .pcc_sub :load _my_lib_init:
     ...
     invoke P1</pre>

<p><b>:load</b> is ignored, if another subroutine in that file is marked with <b>:main</b>.</p>

<p>If a subroutine is marked as <b>:init</b> this subroutine is run, before the <b>:main</b> or the first subroutine in the source file runs.</p>

<h2><a name="Invocation_i.e._calling_the_sub"
>Invocation i.e. calling the sub <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>  invoke        # call the subroutine in P0 (P1 was created earlier)

  invokecc      # call sub in P0 and create return continuation in P1</pre>

<h2><a name="Returning_from_a_sub"
>Returning from a sub <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>  invoke P1     # call return continuation in P1</pre>

<h2><a name="All_together_now"
>All together now <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>The following scheme can be used if a subroutine is called once or if performance doesn&#39;t matter:</p>

<pre lang='und' xml:lang='und'>    newsub P0, .Sub, _sub_label # create subroutine
    set I5, 42                  # pass an argument
    invokecc                    # create ret continuation and call sub
    end                         # fin.
  _sub_label:
    print I5                    # do something with parameters
    invoke P1                   # return</pre>

<p>If a subroutine is called several times, for instance inside a loop, the creation of the return continuation can be done outside the loop if performance is an issue:</p>

<pre lang='und' xml:lang='und'>    newsub .Sub, .RetContinuation, _sub_label, ret_label
    set I16, 1000000
    set I17, 0
  lp:
    pushtopi            # preserve counter vars
    invoke
  ret_label:
    poptopi
    inc I17
    lt I17, I16, lp
    end
  _sub_label:
    # do_something
    invoke P1</pre>

<p>If items in the interpreter context are changed between creation of the subroutine/return continuation and its invocation, the <code lang='und' xml:lang='und'>updatecc</code> opcode should be used, so that the state of the return continuation matches that of the interpreter:</p>

<pre lang='und' xml:lang='und'>    newsub .Sub, .RetContinuation, _sub_label, ret_label
    ...
    warningson 1
    ...
    updatecc
    invoke
    ...</pre>

<h2><a name="Generating_a_Subroutine_Symbol_Table_Entry"
>Generating a Subroutine Symbol Table Entry <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>When a subroutine label is prefixed by <b>.pcc_sub</b>, the name of the subroutine (i.e. the label) gets stored in the global stash.</p>

<pre lang='und' xml:lang='und'>    find_global P0, &#34;_the_sub&#34;
    invokecc
    print &#34;back\n&#34;
    end

  .pcc_sub _the_sub:
    print &#34;in sub\n&#34;
    invoke P1</pre>

<h2><a name="Optimized_Tail_Calls"
>Optimized Tail Calls <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>    find_global P0, &#34;_the::sub&#34;
    invokecc
    print &#34;back\n&#34;
    end

  .pcc_sub _the::sub:
    print &#34;in sub\n&#34;                    # must preserve P1
    find_global P0, &#34;_next::sub&#34;
    get_addr I0, P0                     # get the absolute address
    jump I0                             # jump to absolute address

  .pcc_sub _next::sub:                  # must preserve P1
    print &#34;in next sub\n&#34;
    invoke P1                           # return to main</pre>

<h1><a name="FILES"
>FILES <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'><a href="../../src/pmc/sub.pmc.html">src/pmc/sub.pmc</a></em>, <em lang='und' xml:lang='und'><a href="../../src/pmc/closure.pmc.html">src/pmc/closure.pmc</a></em>, <em lang='und' xml:lang='und'><a href="../../src/pmc/continuation.pmc.html">src/pmc/continuation.pmc</a></em>, <em lang='und' xml:lang='und'><a href="../../src/pmc/coroutine.pmc.html">src/pmc/coroutine.pmc</a></em>, <em lang='und' xml:lang='und'>sub.c</em>, <em lang='und' xml:lang='und'><a href="../../t/pmc/sub.t.html">t/pmc/sub.t</a></em></p>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'><a href="../pdds/pdd03_calling_conventions.pod.html">docs/pdds/pdd03_calling_conventions.pod</a></em> <em lang='und' xml:lang='und'>imcc/docs/calling_conventions.pod</em></p>

<h1><a name="AUTHOR"
>AUTHOR <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>Leopold Toetsch &#60;lt@toetsch.at&#62;</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot_small.png"
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
