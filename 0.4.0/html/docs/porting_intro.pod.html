<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Parrot Subsystem Porting Introduction</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot Subsystem Porting Introduction</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>docs/porting_intro.pod &#45; Parrot Subsystem Porting Introduction</p>

<h1><a name="OVERVIEW"
>OVERVIEW <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>This document is an introduction to porting the optional subsystems of Parrot onto a new architecture once the core successfully builds.
It assumes passing familiarity with common VM techniques but relatively little knowledge of Parrot internals.
For each feature,
a brief description of its purpose,
hints on helping to port it,
and pointers to more information are included.</p>

<h1><a name="CGoto"
>CGoto <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>&#34;Computed goto&#34; is a non&#45;standard C feature that allows taking a pointer to an statement label (e.g.
&#34;LOOP:&#34; ) using the unary &#38;&#38; operator.
Certain Parrot runcores make use of this feature as an optimization.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>If cgoto is not supported in Parrot by default on your platform,
try to compile config/auto/cgoto/test_c.in with your C compiler and determine why it fails.
If the compiler does not support the computed goto concept at all,
this feature cannot be made to work (don&#39;t worry,
there are other runcores).
However,
if the compiler supports it but the test is inadequate,
please submit a bug report describing how the implementation of this feature differs from what Parrot expects.</p>

<p>Note that gcc supports this feature out of the box,
though it sometimes struggles with it in low&#45;memory situations.
Failures during compilation of core_ops_cg.c are frequently caused by insufficient resources rather than bugs in gcc or Parrot.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'>config/auto/cgoto/test_c.in</em></li><p class="pad"></p>

<li><i>make testC</i></li><p class="pad"></p>
</ul>

<h1><a name="JIT"
>JIT <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Parrot contains a just&#45;in&#45;time compilation subsystem that compiles Parrot bytecode into native processor instructions just prior to execution,
eliminating much of the overhead of bytecode interpretation.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Each unique processor target requires its own JIT engine.
So far,
engines have been implemented for DEC Alpha,
ARM,
Intel i386,
SGI MIPS,
PPC,
and Sun4.
If you know that your architecture is substantially similar to one of these,
adding support may be possible with relatively little effort.
Implementing a novel JIT core from scratch is a substantial undertaking.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'><a href="jit.pod.html">docs/jit.pod</a></em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>jit/$arch/*</em></li><p class="pad"></p>

<li><i>make testj</i></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'><a href="../t/op/jit.t.html">t/op/jit.t</a></em></li><p class="pad"></p>
</ul>

<h1><a name="Native_Exec"
>Native Exec <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Parrot&#39;s &#34;native exec&#34; feature allows the integration of the parrot runtime and a Parrot program into a single precompiled binary,
reducing program start&#45;up cost and negating the need to package Parrot distinctly from an application.
It&#39;s perl2exe/PerlApp/PAR for the Parrot generation.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>The exec feature makes use of the JIT subsystem,
and requires supporting code with knowledge of the operating system&#39;s native object format.
This feature is only supported on JITable architectures (for now,
just x86) running Linux,
*BSD,
or Darwin.
An interested Parrot hacker with an eligible platform can contribute by submitting patches which emit exec objects in the OS&#39;s native object format (e.g.,
ELF,
a.out,
XCOFF).</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'><a href="native_exec.pod.html">docs/native_exec.pod</a></em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>src/exec*.c</em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>include/parrot/exec*.h</em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>config/auto/jit.pl</em></li><p class="pad"></p>
</ul>

<h1><a name="Threads"
>Threads <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Parrot abstracts parallel streams of execution (threads) using a small set of concurrency primitives that operate on thread objects with distinct code paths and private data.
Architecture&#45;specific threading models are mapped onto to these primitives to provide Parrot threads with the most desirable features of native threads.
Native thread support is very important to the adoption of Parrot.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>At present Parrot implements support only for POSIX threads (pthreads).
Most modern UNIX&#45;like operating systems have a pthreads implementation,
and allowing Parrot to use these is frequently just a matter of finding the right compiler and linker flags.
Non&#45;POSIX architectures with substantially different threading models will require more implementation and debugging to work with Parrot.</p>

<p>To assist with enhancing threading support,
compare the threading primitives required by Parrot in <em lang='und' xml:lang='und'>thread.h</em> to those provided by your platform&#39;s threading model(s) and implement Parrot threads in terms of native threads.
See <em lang='und' xml:lang='und'>thr_pthread.h</em> for an example of this.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'><a href="../t/pmc/threads.t.html">t/pmc/threads.t</a></em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>config/gen/platform/*/threads.h</em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'><a href="../src/thread.c.html">src/thread.c</a></em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>include/parrot/thread.h</em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'>include/parrot/thr_pthread.h</em></li><p class="pad"></p>
</ul>

<h1><a name="Signals"
>Signals <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Parrot must be able to receive asynchronous imperative and advisory messages from the operating system and other local processes in a safe manner.
Typically this is done by registering message&#45;specific callback functions,
to which the operating system transfers control when signals are generated.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>UNIX&#45;like systems usually employ the signal() function for this purpose; Windows achieves similar functionality with message queues.
For now,
Parrot assumes a mechanism like the former can be used.
Currently the signal handler test suite only operates under Linux,
though the mechanism itself is intended to work wherever Parrot does.
Portable tests as well as fixes for failures thereof are greatly needed.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'>config/gen/platform/*/signal.[ch]</em></li><p class="pad"></p>

<li><em lang='und' xml:lang='und'><a href="../t/pmc/signal.t.html">t/pmc/signal.t</a></em></li><p class="pad"></p>
</ul>

<h1><a name="Dynloading"
>Dynloading <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Nearly all modern operating systems support runtime&#45;specified importation of shared library object code,
and Parrot must support this feature in order to use native libraries without relying on the system linker.
Notable APIs for this mechanism include <code lang='und' xml:lang='und'>dlopen()</code> on common *NIXes and LoadLibrary on Win32.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>If not already supported,
research the dynamic library loading API for your platform and implement it in the platform&#45;specific sources.
Since Parrot substantially abstracts the dynload mechanism,
adding support for a new platform should not require diving far into Parrot internals.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'>config/gen/platform/*/dl.[ch]</em></li><p class="pad"></p>
</ul>

<h1><a name="Memory_protection"
>Memory protection <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<h2><a name="What_it_is"
>What it is <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>An ever&#45;increasing number of operating systems support the enforcement of executable/non&#45;executable flags on memory regions to prevent the improper execution of erroneous or malicious instructions.
When applied by default to regions that rarely need to contain executable code,
this is a useful security measure.
However,
since Parrot (specifically,
the JIT subsystem) generates and executes native instructions in such regions,
it must be able to safely circumvent these protections.</p>

<h2><a name="How_to_help"
>How to help <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p>Determine what level of support for execute protection your architecture/OS combination has,
and how to selectively disable it.
Documentation for features like PaX (Linux) and W^X (OpenBSD) are the best place to look for this information.
The platform&#45;specific source files implement memory allocation wrappers that hide these details,
so wading deep into Parrot is probably not a prerequisite for this task.</p>

<h2><a name="References"
>References <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<ul>
<li><em lang='und' xml:lang='und'>config/gen/platform/*/memexec.c</em></li><p class="pad"></p>
</ul>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
