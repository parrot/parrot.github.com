<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>UCS&#45;2 encoding</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">UCS&#45;2 encoding</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../html/index.html">Contents</a> | <a href="../../../html/c.html">C</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>src/encodings/ucs2.c &#45; UCS&#45;2 encoding</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p>UCS&#45;2 encoding with the help of the ICU library.</p>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h2>

<p>*/</p>

<p>#include &#34;parrot/parrot.h&#34; #include &#34;../unicode.h&#34;</p>

<p>/* HEADER: src/encodings/ucs2.h */</p>

<p>#include &#34;ucs2.h&#34;</p>

<p>#if PARROT_HAS_ICU # include &#60;unicode/ustring.h&#62; #endif</p>

<p>#define UNIMPL internal_exception(UNIMPLEMENTED,
&#34;unimpl ucs2&#34;)</p>

<p>static void iter_init(Interp *,
const STRING *src,
String_iter *iter);</p>

<p>static STRING * to_encoding(Interp *interp,
STRING *src,
STRING *dest) { STRING * const result = Parrot_utf16_encoding_ptr&#45;&#62;to_encoding(interp,
src,
dest); /* * conversion to utf16 downgrads to ucs&#45;2 if possible &#45; check result */ if (result&#45;&#62;encoding == Parrot_utf16_encoding_ptr) { real_exception(interp,
NULL,
E_UnicodeError,
&#34;can&#39;t convert string with surrogates to ucs2&#34;); } return result; }</p>

<p>static UINTVAL get_codepoint(Interp *interp,
const STRING *src,
UINTVAL offset) { #if PARROT_HAS_ICU UChar *s = (UChar*) src&#45;&#62;strstart; return s[offset]; #else real_exception(interp,
NULL,
E_LibraryNotLoadedError,
&#34;no ICU lib loaded&#34;); return 0; #endif }</p>

<p>static void set_codepoint(Interp *interp,
STRING *src,
UINTVAL offset,
UINTVAL codepoint) { #if PARROT_HAS_ICU UChar *s = (UChar*) src&#45;&#62;strstart; s[offset] = codepoint; #else real_exception(interp,
NULL,
E_LibraryNotLoadedError,
&#34;no ICU lib loaded&#34;); #endif }</p>

<p>static UINTVAL get_byte(Interp *interp,
const STRING *src,
UINTVAL offset) { UNIMPL; return 0; }</p>

<p>static void set_byte(Interp *interp,
const STRING *src,
UINTVAL offset,
UINTVAL byte) { UNIMPL; }</p>

<p>static STRING * get_codepoints(Interp *interp,
STRING *src,
UINTVAL offset,
UINTVAL count) { STRING *return_string = Parrot_make_COW_reference(interp,
src); #if PARROT_HAS_ICU return_string&#45;&#62;strstart = (char*)src&#45;&#62;strstart + offset * sizeof (UChar); return_string&#45;&#62;bufused = count * sizeof (UChar); #else { String_iter iter; UINTVAL start;</p>

<pre lang='und' xml:lang='und'>        iter_init(interp, src, &#38;iter);
        iter.set_position(interp, &#38;iter, offset);
        start = iter.bytepos;
        return_string&#45;&#62;strstart = (char *)return_string&#45;&#62;strstart + start;
        iter.set_position(interp, &#38;iter, offset + count);
        return_string&#45;&#62;bufused = iter.bytepos &#45; start;
    }
#endif
    return_string&#45;&#62;strlen = count;
    return_string&#45;&#62;hashval = 0;
    return return_string;
}</pre>

<p>static STRING * get_bytes(Interp *interp, STRING *src, UINTVAL offset, UINTVAL count) { UNIMPL; return NULL; }</p>

<p>static STRING * get_codepoints_inplace(Interp *interp, STRING *src, UINTVAL offset, UINTVAL count, STRING *dest_string) {</p>

<pre lang='und' xml:lang='und'>    UNIMPL;
    return NULL;
}</pre>

<p>static STRING * get_bytes_inplace(Interp *interp, STRING *src, UINTVAL offset, UINTVAL count, STRING *return_string) { UNIMPL; return NULL; }</p>

<p>static void set_codepoints(Interp *interp, STRING *src, UINTVAL offset, UINTVAL count, STRING *new_codepoints) { UNIMPL; }</p>

<p>static void set_bytes(Interp *interp, STRING *src, UINTVAL offset, UINTVAL count, STRING *new_bytes) { UNIMPL; }</p>

<p>/* Unconditionally makes the string be in this encoding, if that&#39;s valid */ static void become_encoding(Interp *interp, STRING *src) { UNIMPL; }</p>

<p>static UINTVAL codepoints(Interp *interp, STRING *src) { #if PARROT_HAS_ICU return src&#45;&#62;bufused / sizeof (UChar); #else real_exception(interp, NULL, E_LibraryNotLoadedError, &#34;no ICU lib loaded&#34;); return 0; #endif }</p>

<p>static UINTVAL bytes(Interp *interp, STRING *src) { return src&#45;&#62;bufused; }</p>

<p>#if PARROT_HAS_ICU static UINTVAL ucs2_decode_and_advance(Interp *interp, String_iter *i) { UChar *s = (UChar*) i&#45;&#62;str&#45;&#62;strstart, c; size_t pos; pos = i&#45;&#62;bytepos / sizeof (UChar); /* TODO either make sure that we don&#39;t go past end or use SAFE * iter versions */ c = s[pos++]; i&#45;&#62;charpos++; i&#45;&#62;bytepos = pos * sizeof (UChar); return c; }</p>

<p>static void ucs2_encode_and_advance(Interp *interp, String_iter *i, UINTVAL c) { UChar *s = (UChar*) i&#45;&#62;str&#45;&#62;strstart; UINTVAL pos; pos = i&#45;&#62;bytepos / sizeof (UChar); s[pos++] = (UChar)c; i&#45;&#62;charpos++; i&#45;&#62;bytepos = pos * sizeof (UChar); }</p>

<p>static void ucs2_set_position(Interp *interp, String_iter *i, UINTVAL n) { i&#45;&#62;charpos = n; i&#45;&#62;bytepos = n * sizeof (UChar); }</p>

<p>#endif static void iter_init(Interp *interp, const STRING *src, String_iter *iter) { iter&#45;&#62;str = src; iter&#45;&#62;bytepos = iter&#45;&#62;charpos = 0; #if PARROT_HAS_ICU iter&#45;&#62;get_and_advance = ucs2_decode_and_advance; iter&#45;&#62;set_and_advance = ucs2_encode_and_advance; iter&#45;&#62;set_position = ucs2_set_position; #else real_exception(interp, NULL, E_LibraryNotLoadedError, &#34;no ICU lib loaded&#34;); #endif }</p>

<p>ENCODING * Parrot_encoding_ucs2_init(Interp *interp) { ENCODING *return_encoding = Parrot_new_encoding(interp);</p>

<pre lang='und' xml:lang='und'>    static const ENCODING base_encoding = {
        &#34;ucs2&#34;,
        2, /* Max bytes per codepoint 0 .. 0x10ffff */
        to_encoding,
        get_codepoint,
        set_codepoint,
        get_byte,
        set_byte,
        get_codepoints,
        get_codepoints_inplace,
        get_bytes,
        get_bytes_inplace,
        set_codepoints,
        set_bytes,
        become_encoding,
        codepoints,
        bytes,
        iter_init
    };
    memcpy(return_encoding, &#38;base_encoding, sizeof (ENCODING));
    Parrot_register_encoding(interp, &#34;ucs2&#34;, return_encoding);
    return return_encoding;
}</pre>

<p>/*</p>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'><a href="fixed_8.c.html">src/encodings/fixed_8.c</a></em>, <em lang='und' xml:lang='und'><a href="utf8.c.html">src/encodings/utf8.c</a></em>, <em lang='und' xml:lang='und'><a href="../string.c.html">src/string.c</a></em>, <em lang='und' xml:lang='und'>include/parrot/string.h</em>, <em lang='und' xml:lang='und'>docs/string.pod</em>.</p>

<p>*/</p>

<p>/* * Local variables: * c&#45;file&#45;style: &#34;parrot&#34; * End: * vim: expandtab shiftwidth=4: */</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
