<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Parrot&#39;s security infrastructure</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot&#39;s security infrastructure</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../../../html/index.html">Contents</a> | <a href="../../../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>docs/pdds/pdd18_security.pod &#45; Parrot&#39;s security infrastructure</p>

<h1><a name="ABSTRACT"
>ABSTRACT <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>This PDD describes the safety,
security,
and quota infrastructure of Parrot.</p>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<p>There are three basic subsystems in Parrot&#39;s security system.
They are:</p>

<dl>
<dt><a name="Quotas"
>Quotas</a></dt><p class="pad"></p>

<dd>To ensure that an interpreter doesn&#39;t use more CPU time,
memory,
or system resources than is allowed.</dd><p class="pad"></p>

<dt><a name="Privilege_checks"
>Privilege checks</a></dt><p class="pad"></p>

<dd>To restrict access to what an interpreter can do.</dd><p class="pad"></p>

<dt><a name="Parameter_checks"
>Parameter checks</a></dt><p class="pad"></p>

<dd>To double&#45;check bytecode parameters for basic sanity.</dd><p class="pad"></p>
</dl>

<p>Each of these can be enabled or disabled separately,
and each has a particular purpose.
Often two or more systems will be engaged at once,
but this isn&#39;t required.</p>

<h2><a name="Quotas"
>Quotas <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>The purpose of a quota system is to ensure that an interpreter doesn&#39;t use up too many resources &#45;&#45; usually memory and CPU,
but there may be other scarce resources,
such as files,
that need managing.
In a shared environment it prevents an interpreter from hogging too many resources,
either explicitly (as in a DOS attack) or implicitly (through poor programming or poorly scheduled runs),
and preventing other interpreters from running.</p>

<h2><a name="Privilege_checks"
>Privilege checks <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>A privilege system is used to restrict code from performing certain actions.
When privilege checking is in force you may need a particular privilege to load a library,
or open a file.</p>

<p>Each interpreter has three sets of privileges.
The first set is the <i>current</i> privilege set,
which is the set of privileges currently in force.
The second set is the set of <i>authorized</i> privileges.
These are the privileges that the interpreter is allowed to put into its current set.
The third set are the <i>sub</i> privileges.
These are the privileges that a sub has intrinsic to itself,
regardless of what the interpreter privileges currently are.
(Subs with privileges attached to them are called <i>privileged subs</i>,
oddly enough).</p>

<p>An interpreter may drop any privilege it likes from the current set.
It may also at any time enable a privilege which is in the authorized set but not in the current set.
It is possible for a sub to have a privilege in its current set which isn&#39;t in its authorized set.
Those privileges are,
once dropped,
gone.</p>

<p>Subroutines may also have a set of <i>required privileges</i> attached to them.
The current interpreter <b>must</b> have those privileges in its current or sub set to call a subroutine so tagged.
If the interpreter doesn&#39;t have the privileges then a privilege violation exception is thrown.</p>

<h2><a name="Parameter_checking"
>Parameter checking <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>In normal operation the interpreter assumes that the bytecode that it executes is valid &#45;&#45; that is,
any parameters to opcodes are sane,
data structures are intact,
and the world,
generally,
is a good place.
When parameter checking is enabled,
however,
we assume that bytecode is not necessarily valid.
The interpreter then,
at runtime,
makes sure that all specified register numbers are within valid range,
and string and PMC structures used are valid.</p>

<h2><a name="Feature_usage"
>Feature usage <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>Each of the three features has a separate use.
Parameter checking is most useful when executing code which may come from an unsafe source,
for example from the network.
Quotas are most useful when running code in a managed environment such as a web,
database,
or game server where no one interpreter is allowed to consume too many resources and impact the system too badly.
Privileges are used when running untrusted code in a trusted environment,
again such as a database or game server,
where Parrot can&#39;t disable certain features,
but must limit their use to trusted code.</p>

<p>It&#39;s unlikely that any one of these features will be enabled individually,
though there are certainly reasons to do so.
Each feature is separately implemented,
however,
and as such can be taken singly and discussed.</p>

<h1><a name="IMPLEMENTATION"
>IMPLEMENTATION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<h2><a name="Quotas"
>Quotas <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>Quota management is split into two separate parts,
CPU time and everything else.</p>

<h3><a name="CPU_time"
>CPU time</a></h3>

<p>CPU time is managed by the runloop.
There&#39;s a certain unavoidable overhead,
but there&#39;s no way around this,
at least not reliably.
(We may be able to play interesting games with timer events and system event handlers.
We&#39;ll see).</p>

<h3><a name="Everything_else"
>Everything else</a></h3>

<p>The rest of the quotas are enforced by code scattered across the interpreter.
The memory system handles memory quotas,
the IO system handles file open and pending IO count quotas,
and so on.
There&#39;s not a whole lot for this,
though we should abstract out all the high&#45;level operations that do things which may have quotas applied so we can wrap these functions,
so as not to pay the price when quotas aren&#39;t in force.</p>

<p>For example,
rather than having checks in the memory subsystem to see if quotas are enabled (a check that would have to be done on each memory allocation) we should instead access the memory allocation via a function pointer stored off the interpreter somewhere.
This way when quotas are enabled we can swap in an alternate function pointer,
one that points to a function which checks quotas before calling into the memory subsystem.</p>

<p>This should be relatively painless as most,
if not all,
of the functions which should have quotas applied to them are also functions which embedders may wish to override,
and thus already need to be accessed indirectly.</p>

<h2><a name="Privileges"
>Privileges <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<h2><a name="Parameter_Checking"
>Parameter Checking <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<p>Parameter checking is done with an alternate runloop,
one where the opcodes first check their parameters before executing.
This is fairly expensive,
which is why it isn&#39;t the default mode for operations.
(The JIT may,
at its choice,
check parameters at JIT time).
Checking at load time is also somewhat problematic,
as it is also somewhat expensive,
means the checker needs to know the signatures for ops which may not have been loaded yet,
and precludes code doing overly clever things.
(Which itself probably ought be forbidden,
but that&#39;s a separate problem).</p>

<p>The checking op variants are automatically generated by the op file preprocessor,
the same way that it generates all the other oploop variants.</p>

<h1><a name="ATTACHMENTS"
>ATTACHMENTS <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<h1><a name="FOOTNOTES"
>FOOTNOTES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<h1><a name="REFERENCES"
>REFERENCES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<h1><a name="VERSION"
>VERSION <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<h2><a name="CURRENT"
>CURRENT <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<pre lang='und' xml:lang='und'>    Maintainer: Dan Sugalski
    Class: Internal
    PDD Number: 18
    Version: 1.0
    Status: Developing
    Last Modified: 29 Aug 2004
    PDD Format: 1
    Language: English</pre>

<h2><a name="HISTORY"
>HISTORY <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="version_1"
>version 1</a></dt><p class="pad"></p>

<dd>None. First version</dd><p class="pad"></p>
</dl>

<h1><a name="CHANGES"
>CHANGES <a href='#_top'><img alt='^' border=0 src='../../../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="Version_1.0"
>Version 1.0</a></dt><p class="pad"></p>

<dd>None. First version</dd><p class="pad"></p>
</dl>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
