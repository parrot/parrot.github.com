<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
    "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>  
    <HEAD>
        <TITLE>Parrot embedding system</TITLE>
        <LINK REL="stylesheet" TYPE="text/css" 
            HREF="../../resources/perl.css" 
            TITLE="Default CSS2" media="screen">
    </HEAD>
    <BODY> 
        <A NAME="_top"></A>
        <TABLE CELLSPACING="0" WIDTH="730">
            <TR>
                <TD WIDTH="100%" COLSPAN="2" CLASS="BANNER">parrotcode: <SPAN CLASS="title">Parrot embedding system</SPAN></TD>
            </TR>
            <TR>
                <TD WIDTH="100%" COLSPAN="2"  ID="NAV" STYLE="border-bottom: 1px solid #191970;">
                    <a href="../../html/index.html">Contents</a> | <a href="../../html/docs.html">Documentation</a>
                </TD>
            </TR>
        </TABLE>
        <DIV CLASS="pod">

<h1><a name="NAME"
>NAME <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>embed.pod &#45; Parrot embedding system</p>

<h1><a name="SYNOPSIS"
>SYNOPSIS <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<pre lang='und' xml:lang='und'>    #include &#34;parrot/embed.h&#34;

    int main(int argc, char *argv[]) {
        Parrot_Interp interp;
        Parrot_PackFile pf;
        char * bcfile = &#34;program.pbc&#34;;

        argc&#45;&#45;; argv++; /* skip the program name */

        interp=Parrot_new(NULL);
        Parrot_init(interp);

        if(PARROT_JIT_CAPABLE) {
            Parrot_set_run_core(interp, PARROT_JIT_CORE);  /* activate JIT */
        }

        pf = Parrot_readbc(interp, bcfile);
        Parrot_loadbc(interp, pf);

        Parrot_runcode(interp, argc, argv); /* argc and argv as seen by the bytecode file */

        Parrot_destroy(interp);

        return 0;
    }</pre>

<h1><a name="FILES"
>FILES <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<dl>
<dt><a name="include/parrot/embed.h"
><em lang='und' xml:lang='und'>include/parrot/embed.h</em></a></dt><p class="pad"></p>

<dt><a name="embed.c"
><em lang='und' xml:lang='und'>embed.c</em></a></dt><p class="pad"></p>
</dl>

<h1><a name="DESCRIPTION"
>DESCRIPTION <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>Parrot&#39;s embedding system is designed with one guiding principle in mind: encapsulation. Users of Parrot shouldn&#39;t have to know what the insides of a <code lang='und' xml:lang='und'>Parrot_Interp</code> structure look like or how to load a packfile. They should just know a few functions and constants. The embedding system is designed to do just that.</p>

<h2><a name="Data_Structures"
>Data Structures <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="Parrot_Interp"
><b><code lang='und' xml:lang='und'>Parrot_Interp</b></code></a></dt><p class="pad"></p>

<dd>This typedef represents (a pointer to) an actual Parrot interpreter.</dd><p class="pad"></p>

<dt><a name="Parrot_PackFile"
><b><code lang='und' xml:lang='und'>Parrot_PackFile</b></code></a></dt><p class="pad"></p>

<dd>This structure represents (a pointer to) a &#39;packfile&#39;&#45;&#45;a Parrot bytecode file.</dd><p class="pad"></p>

<dt><a name="Parrot_Interp_flag"
><b><code lang='und' xml:lang='und'>Parrot_Interp_flag</b></code></a></dt><p class="pad"></p>

<dd>An interpreter flag.</dd><p class="pad"></p>

<dt><a name="Parrot_Interp_flag_val"
><b><code lang='und' xml:lang='und'>Parrot_Interp_flag_val</b></code></a></dt><p class="pad"></p>

<dd>The value passed in with an interpreter flag. Unused at the moment&#45;&#45;just pass in <code lang='und' xml:lang='und'>NULL</code>.</dd><p class="pad"></p>

<dt><a name="Parrot_Int"
><b><code lang='und' xml:lang='und'>Parrot_Int</b></code></a></dt><p class="pad"></p>

<dt><a name="Parrot_UInt"
><b><code lang='und' xml:lang='und'>Parrot_UInt</b></code></a></dt><p class="pad"></p>

<dt><a name="Parrot_Float"
><b><code lang='und' xml:lang='und'>Parrot_Float</b></code></a></dt><p class="pad"></p>

<dt><a name="Parrot_Opcode"
><b><code lang='und' xml:lang='und'>Parrot_Opcode</b></code></a></dt><p class="pad"></p>

<dd>Various Parrot internal types; most are chosen at Configure time.</dd><p class="pad"></p>
</dl>

<h2><a name="Constants"
>Constants <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<p><b>interpreter core setting</b> is done by a call of <code lang='und' xml:lang='und'>Parrot_set_run_core()</code> like:</p>

<pre lang='und' xml:lang='und'>  Parrot_set_run_core(interp, PARROT_JIT_CORE);</pre>

<p>See <em lang='und' xml:lang='und'>/include/parrot/interpreter.h</em> for a list of available cores beside PARROT_PREDEREF_CORE, PARROT_JIT_CORE.</p>

<dl>
<dt><a name="PARROT_PREDEREF_CORE"
><b><code lang='und' xml:lang='und'>PARROT_PREDEREF_CORE</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on predereferencing. Parrot will transform many offsets in the opcode stream to absolute pointers.</dd><p class="pad"></p>

<dt><a name="PARROT_JIT_CORE"
><b><code lang='und' xml:lang='und'>PARROT_JIT_CORE</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on just&#45;in&#45;time compilation. Parrot will convert the bytecode file into native machine code and run it, usually resulting in substantial speedup.</dd><p class="pad"></p>
</dl>

<p><b>Interpreter flags setting</b> is done by a call of <code lang='und' xml:lang='und'>Parrot_set_flag()</code> like&#62;:</p>

<pre lang='und' xml:lang='und'>    Parrot_set_flag(interp, PARROT_TRACE_FLAG, NULL);</pre>

<p>See <em lang='und' xml:lang='und'>/include/parrot/interpreter.h</em> for an up to date list.</p>

<dl>
<dt><a name="PARROT_DEBUG_FLAG"
><b><code lang='und' xml:lang='und'>PARROT_DEBUG_FLAG</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on debugging mode. Debugging mode basically means that Parrot&#39;s core prints out diagnostic messages. This flag does not take any parameters.</dd><p class="pad"></p>

<dt><a name="PARROT_TRACE_FLAG"
><b><code lang='und' xml:lang='und'>PARROT_TRACE_FLAG</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on opcode tracing. Parrot will print out each opcode and the parameters passed to it as it is called. This flag does not take any parameters.</dd><p class="pad"></p>

<dt><a name="PARROT_BOUNDS_FLAG"
><b><code lang='und' xml:lang='und'>PARROT_BOUNDS_FLAG</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on bounds checking. Parrot will make sure that all addresses returned by an opcode function are within the boundaries of the bytecode block. This flag does not take any parameters.</dd><p class="pad"></p>

<dt><a name="PARROT_PROFILE_FLAG"
><b><code lang='und' xml:lang='und'>PARROT_PROFILE_FLAG</b></code></a></dt><p class="pad"></p>

<dd>This flag turns on profiling. Parrot will print out a list of each opcode called, the number of times it was called, the average time it took to run, and the total time it took over the life of the program. This flag does not take any parameters.</dd><p class="pad"></p>

<dt><a name="PARROT_THR_TYPE_1,_PARROT_THR_TYPE_2,_PARROT_THR_TYPE_3"
><b><code lang='und' xml:lang='und'>PARROT_THR_TYPE_1</b></code>, <b><code lang='und' xml:lang='und'>PARROT_THR_TYPE_2</b></code>, <b><code lang='und' xml:lang='und'>PARROT_THR_TYPE_3</b></code></a></dt><p class="pad"></p>

<dd>This flags control the threading behavior. With <code lang='und' xml:lang='und'>PARROT_THR_TYPE_1</code>, threads runs without sharing variables and do not communicate, With <code lang='und' xml:lang='und'>PARROT_THR_TYPE_2</code>, threads shares no variables and communicate by sending messages. With <code lang='und' xml:lang='und'>PARROT_THR_TYPE_3</code>, threads share variables. See <em lang='und' xml:lang='und'><a href="../t/pmc/threads.t.html">t/pmc/threads.t</a></em> for examples.</dd><p class="pad"></p>
</dl>

<p><b>Other constants:</b></p>

<dl>
<dt><a name="PARROT_VERSION"
><b><code lang='und' xml:lang='und'>PARROT_VERSION</b></code></a></dt><p class="pad"></p>

<dd>This constant contains a string representation of Parrot&#39;s version number.</dd><p class="pad"></p>

<dt><a name="PARROT_MAJOR_VERSION"
><b><code lang='und' xml:lang='und'>PARROT_MAJOR_VERSION</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the first part of Parrot&#39;s version number.</dd><p class="pad"></p>

<dt><a name="PARROT_MINOR_VERSION"
><b><code lang='und' xml:lang='und'>PARROT_MINOR_VERSION</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the second part of Parrot&#39;s version number.</dd><p class="pad"></p>

<dt><a name="PARROT_PATCH_VERSION"
><b><code lang='und' xml:lang='und'>PARROT_PATCH_VERSION</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the third part of Parrot&#39;s version number.</dd><p class="pad"></p>

<dt><a name="PARROT_CONFIG_DATE"
><b><code lang='und' xml:lang='und'>PARROT_CONFIG_DATE</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the date that Configure was run to generate config.h.</dd><p class="pad"></p>

<dt><a name="PARROT_JIT_CAPABLE"
><b><code lang='und' xml:lang='und'>PARROT_JIT_CAPABLE</b></code></a></dt><p class="pad"></p>

<dd>This constant is true if Parrot supports JIT on this platform, false otherwise.</dd><p class="pad"></p>

<dt><a name="PARROT_ARCHNAME"
><b><code lang='und' xml:lang='und'>PARROT_ARCHNAME</b></code></a></dt><p class="pad"></p>

<dd>This constant contains a string representation of the Parrot JIT&#39;s name for the current architecture.</dd><p class="pad"></p>

<dt><a name="PARROT_CPU_ARCH"
><b><code lang='und' xml:lang='und'>PARROT_CPU_ARCH</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the name of your processor (as the JIT sees it).</dd><p class="pad"></p>

<dt><a name="PARROT_OS_NAME"
><b><code lang='und' xml:lang='und'>PARROT_OS_NAME</b></code></a></dt><p class="pad"></p>

<dd>This constant contains the name of your operating system (as the JIT sees it).</dd><p class="pad"></p>
</dl>

<h2><a name="Functions"
>Functions <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h2>

<dl>
<dt><a name="Parrot_Interp_Parrot_new(Parrot_Interp_parent)"
><b><code lang='und' xml:lang='und'>Parrot_Interp Parrot_new(Parrot_Interp parent)</b></code></a></dt><p class="pad"></p>

<dd>Allocates and returns a new Parrot interpreter. <code lang='und' xml:lang='und'>parent</code> is NULL for the main interpreter that will be destroyed last.</dd><p class="pad"></p>

<dt><a name="void_Parrot_init(Parrot_Interp)"
><b><code lang='und' xml:lang='und'>void Parrot_init(Parrot_Interp)</b></code></a></dt><p class="pad"></p>

<dd>Initializes a Parrot interpreter.</dd><p class="pad"></p>

<dt><a name="void_Parrot_setflag(Parrot_Interp,_Parrot_Interp_flag,_Parrot_Interp_flag_val)"
><b><code lang='und' xml:lang='und'>void Parrot_setflag(Parrot_Interp, Parrot_Interp_flag, Parrot_Interp_flag_val)</b></code></a></dt><p class="pad"></p>

<dd>Sets a flag in the Parrot interpreter.</dd><p class="pad"></p>

<dt><a name="Parrot_PackFile_Parrot_readbc(Parrot_Interp,_char_*filename)"
><b><code lang='und' xml:lang='und'>Parrot_PackFile Parrot_readbc(Parrot_Interp, char *filename)</b></code></a></dt><p class="pad"></p>

<dd>Reads in a bytecode file and returns a packfile structure for it.</dd><p class="pad"></p>

<dt><a name="void_Parrot_loadbc(Parrot_Interp,_Parrot_PackFile)"
><b><code lang='und' xml:lang='und'>void Parrot_loadbc(Parrot_Interp, Parrot_PackFile)</b></code></a></dt><p class="pad"></p>

<dd>Loads a packfile into a Parrot interpreter.</dd><p class="pad"></p>

<dt><a name="void_Parrot_runcode(Parrot_Interp,_int_argc,_char_*argv[])"
><b><code lang='und' xml:lang='und'>void Parrot_runcode(Parrot_Interp, int argc, char *argv[])</b></code></a></dt><p class="pad"></p>

<dd>Runs the bytecode associated with a Parrot interpreter. <code lang='und' xml:lang='und'>argc</code> and <code lang='und' xml:lang='und'>argv</code> are the parameters the bytecode should receive.</dd><p class="pad"></p>

<dt><a name="Parrot_destroy(Parrot_Interp)"
><b><code lang='und' xml:lang='und'>Parrot_destroy(Parrot_Interp)</b></code></a></dt><p class="pad"></p>

<dd>Deallocates all memory associated with a Parrot interpreter.</dd><p class="pad"></p>

<dd><b>XXX</b> At the moment, it just leaks most of it.</dd><p class="pad"></p>
</dl>

<h1><a name="COMPILING"
>COMPILING <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p>Note: This section is aimed at you if you are writing an application external to parrot which links against an installed parrot library.</p>

<p>Your application will need to include the appropriate header files and link against parrot and its dependencies.</p>

<p>Since the location of these files can vary from platform to platform, and build to build, a general method is provided to find out the necessary flags to use.</p>

<p>pkg&#45;config is a helper tool, now common on many platforms, which many packages have adopted to provide the necessary compiler and linker flags required to build against a library. parrot will install a file called parrot.pc which can be queried using pkg&#45;config.</p>

<p>To start with, let&#39;s find out what version of parrot is installed by running pkg&#45;config with the &#45;&#45;modversion flag. If this command fails with an error, skip to the bottom of this section.</p>

<pre lang='und' xml:lang='und'>  pkg&#45;config &#45;&#45;modversion parrot</pre>

<p>To find out the necessary &#45;I flags, use &#45;&#45;cflags</p>

<pre lang='und' xml:lang='und'>  pkg&#45;config &#45;&#45;cflags parrot</pre>

<p>and to find the necessary &#45;L and &#45;l flags, use &#45;&#45;libs</p>

<pre lang='und' xml:lang='und'>  pkg&#45;config &#45;&#45;libs parrot</pre>

<p>Where both compiling and linking are performed in one step, both sets of flags can be queries with</p>

<pre lang='und' xml:lang='und'>  pkg&#45;config &#45;&#45;cflags &#45;&#45;libs parrot</pre>

<p>The pkg&#45;config command can be incorporated with a compile as shown here.</p>

<pre lang='und' xml:lang='und'>  cc src/disassemble.c `pkg&#45;config &#45;&#45;cflags &#45;&#45;libs parrot`</pre>

<p>Most applications will probably choose to run pkg&#45;config as part of a configure script, so if you are using autoconf you could use a test such as this.</p>

<pre lang='und' xml:lang='und'>  PARROT_REQUIRED_VERSION=0.4.1
  AC_SUBST(PARROT_REQUIRED_VERSION)
  PKG_CHECK_MODULES(PARROT, parrot &#62;= $PARROT_REQUIRED_VERSION,
                    [AC_DEFINE([HAVE_PARROT], 1, [define if have parrot])])
  AC_SUBST(PARROT_LIBS)
  AC_SUBST(PARROT_CFLAGS)</pre>

<p>If parrot has been installed system&#45;wide, then any of the previous lines should have returned the relevant flags. If it is not installed in one of the standard places that pkg&#45;config looks, then you will get an error message.</p>

<pre lang='und' xml:lang='und'>  pkg&#45;config &#45;&#45;libs parrot
  Package parrot was not found in the pkg&#45;config search path.
  Perhaps you should add the directory containing `parrot.pc&#39;
  to the PKG_CONFIG_PATH environment variable
  No package &#39;parrot&#39; found</pre>

<p>As stated in the error message, an environment variable can be used to make pkg&#45;config look in more locations.</p>

<pre lang='und' xml:lang='und'>  export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig</pre>

<p>The last part of the variable will almost certainly be .../lib/pkgconfig. This variable will have to be set in your login scripts if you need it to be available in future.</p>

<h1><a name="SEE_ALSO"
>SEE ALSO <a href='#_top'><img alt='^' border=0 src='../../resources/up.gif'></a></a></h1>

<p><em lang='und' xml:lang='und'>embed.c</em> and <em lang='und' xml:lang='und'>embed.h</em> for the implementation.</p>

<p><em lang='und' xml:lang='und'>src/test_main.c</em> for Parrot&#39;s use of the embedding system.</p>

<p><a href='http://pkgconfig.freedesktop.org/wiki/'><a href="http://pkgconfig.freedesktop.org/wiki/">http://pkgconfig.freedesktop.org/wiki/</a></a> A pkg&#45;config page</p>
        </DIV>
        <P>
        <TABLE BORDER="0" WIDTH="730" CELLSPACING="0" CELLPADDING="0">
            <TR ALIGN="RIGHT">
                <TD WIDTH="590" VALIGN="MIDDLE">
                    <BR>
                    <DIV CLASS="FOOTER">
                        <DIV ALIGN="LEFT">
                        </DIV>
                    </DIV>
                </TD>
                <TD VALIGN="middle" ALIGN="center">
                    <IMG BORDER=0
                        SRC="../../resources/parrot.small.png" 
                        ALT="parrot">
                </TD>
            </TR>
        </TABLE>
    </BODY>
</HTML>
